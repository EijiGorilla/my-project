import{df as et,a$ as J,X as u,Y as d,$ as H,N as w,xZ as Vo,ar as L,cz as Ft,jc as Fo,lx as Me,k2 as Ms,tf as Uo,kY as fi,g5 as Tt,qg as ja,rK as Ut,pc as Zo,rJ as Ht,dt as Bo,x_ as No,fJ as b,sq as Wo,j2 as Yo,j6 as qo,x$ as Xo,k6 as Ta,cR as Qe,y0 as ws,e1 as M,hy as Qt,e3 as R,b0 as Ae,ej as Z,fI as $,y1 as qi,dT as $t,y2 as Xe,so as Pe,xk as Jo,f_ as xs,jG as mi,y3 as Qo,js as Ko,y4 as er,y5 as tr,y6 as ir,y7 as ar,y8 as ft,es as te,eX as P,g3 as nr,y9 as vi,eG as It,e5 as le,jq as Ss,fm as bi,gt as Je,ya as sr,fL as B,fO as Ya,qA as pa,uq as yi,jp as Yt,n4 as ga,sc as qa,dw as re,yb as Os,yc as Xa,eS as Ye,g9 as _e,yd as or,ye as rr,dk as Ke,jb as Ja,pE as lr,_ as $s,xB as cr,yf as hr,eW as U,jW as Qa,hA as ur,sS as dr,ik as F,sP as pr,yg as Ka,di as A,ax as C,aw as Dt,ip as gr,mi as _r,yh as fr,hr as Et,nr as mr,gq as vr,sg as br,yi as _a,lw as Mi,mj as en,uh as yr,cU as me,f1 as ze,xf as fa,jz as Mr,ji as tn,jf as wr,jd as an,su as dt,fx as Kt,fP as jt,fE as wt,fS as xr,yj as nn,eT as Ds,yk as Sr,dX as Or,xm as wi,yl as $r,t8 as Dr,s9 as Er,jt as Re,l5 as jr,ym as Tr,yn as Ir,s4 as ma,tj as Ia,bg as xi,yo as Es,yp as js,iM as Rr,yq as Ar,d6 as Pr,ju as zr,lq as Ts,sQ as Ra,sW as sn,er as de,fF as gt,fA as $e,yr as Cr,fz as he,i_ as Li,ys as q,wu as Is,fH as Rs,yt as Si,e8 as Lr,bi as De,pP as va,wq as As,wi as kr,aK as Ps,gz as we,az as Hr,jY as tt,cy as ki,yu as Gr,aA as zs,sV as Vr,yv as Cs,yw as Aa,cN as Ls,fV as ks,yx as Fr,fZ as Ur,p5 as Zr,cT as Br,gs as Nr,jE as qe,gu as Wr,gv as Yr,gy as qr,tL as Xr,jr as Jr,bS as Qr,id as Kr,C as el,nM as tl,el as qt,vo as il,pQ as on,e4 as Zt,p3 as al,eL as rn,fY as ln,cE as nl,K as sl,lJ as ol,hK as cn,gp as hn,jV as un,yy as dn,l9 as pn,yz as gn,wp as rl,yA as ll,le as cl,fM as hl,bY as ul,lh as dl}from"./index-DcRZY5kx.js";import{D as Oi,I as $i,H as K,L as Hs,P as pl,Q as gl}from"./colorUtils-D2u0Cz_P.js";import{k as _l,z as ba,C as Gs,F as Vs,V as fl,r as ei,R as Hi,H as Di}from"./rotate-b1Bu2GWE.js";import{t as Pa,c as Ei,a as ml,b as _t,R as pt}from"./OverlayCompositing.glsl-B5Gb4OKm.js";import{h as za,B as ji}from"./line-YTXKKEII.js";import{M as ve,i as vl,a as bl,b as Gt,c as Ti,y as Fs,e as yl,w as Ml,g as wl,f as ya,m as Us}from"./HUDMaterial.glsl-Y94sN1l6.js";import{J as be,i as Zs,W as Bs,u as Gi,o as ti,l as xl,j as Xi}from"./RibbonLine.glsl-if-wKVEd.js";import{u as Sl,s as Ol,o as $l,c as Dl}from"./sdfPrimitives-Ygt7JL5o.js";import{m as Ns,M as El,a4 as jl,W as Ca,p as Ws,a as Ys,i as qs,b as Xs,f as La,e as Ii,ad as Tl,T as Il,g as Js,t as Qs,aD as Rl,w as Ks,q as eo,v as to,x as ka,y as io,z as ne,s as Al,A as Ji,E as Pl,a$ as ao,G as no,I as zl,aS as Cl,H as Ll,d as kl,R as Hl,h as Gl,j as Vl,k as Fl,l as Ul,r as Zl,aJ as _n,b1 as Qi,D as Bl,aW as Nl,b2 as Wl}from"./OutputColorHighlightOID.glsl-BLlApcGW.js";import{m as fe,f as Yl,i as ql,u as Xl}from"./DefaultLayouts-Cjoe7LWe.js";import{r as Jl,e as Ri,g as Ha,d as Ql,F as Kl,Q as ec,U as tc,h as so,M as oo,j as ic,k as ac}from"./SnappingContext-DPTC4qiI.js";import{o as nc,s as ro,f as sc}from"./BufferView-BkGwg0rw.js";import{o as lo,h as fn,s as oc}from"./BooleanBindUniform-rV7lhEqP.js";import{Q as rc}from"./InterleavedLayout-BRE52VHV.js";import{T as co,d as ho,_ as uo}from"./renderState-CKc66y4x.js";import{e as po}from"./GraphicState-CJ8LYMbA.js";import{A as lc,a as cc,c as hc,l as uc,M as dc,D as Vi,f as pc,g as gc,p as ye,R as Bt,m as _c,b as Rt,z as xt,r as Fi,d as fc,v as mc,e as Ai,U as mn,q as vc,V as bc,T as yc,S as Mc}from"./editPlaneUtils-3j-Ma9Sd.js";import{x as vn,k as wc,u as xc}from"./hydratedFeatures-DnmJXUVN.js";import{i as go,p as Sc}from"./SelectedVertexTooltipInfo-Dbm8JcQH.js";import{i as Ga}from"./TranslateTooltipInfo-Cp0vbkrB.js";import{h as bn}from"./utils-B-zUtWrK.js";import{w as Oc,y as $c}from"./axisAngleDegrees-BzL-J_KN.js";import{G as Pi,z as Nt,J as Dc}from"./boundedPlane-BlANjyRg.js";import"./Octree-DZ_wik88.js";import"./Indices-DfQUWp03.js";import{t as ue,n as Ma}from"./glsl-B5bJgrnA.js";import{s as Va}from"./ShaderBuilder-DG0ic514.js";import{M as Ec}from"./Texture-DXHwgIS0.js";import{s as jc,e as Tc,a as Ic}from"./ExtentScaleTooltipInfo-tPfQh_2B.js";import{t as Rc}from"./meshVertexSpaceUtils-Dta9Id-h.js";import{S as Ac}from"./GraphicManipulator-BknR10QP.js";let Pc=i=>({vnodeSelector:"",properties:void 0,children:void 0,text:i.toString(),domNode:null}),_o=(i,e,t)=>{for(let a=0,n=e.length;a<n;a++){let s=e[a];Array.isArray(s)?_o(i,s,t):s!=null&&s!==!1&&(typeof s=="string"&&(s=Pc(s)),t.push(s))}};function zc(i,e,t){if(Array.isArray(e))t=e,e=void 0;else if(e&&(typeof e=="string"||e.hasOwnProperty("vnodeSelector"))||t&&(typeof t=="string"||t.hasOwnProperty("vnodeSelector")))throw new Error("h called with invalid arguments");let a,n;return t&&t.length===1&&typeof t[0]=="string"?a=t[0]:t&&(n=[],_o(i,t,n),n.length===0&&(n=void 0)),{vnodeSelector:i,properties:e,children:n,text:a===""?void 0:a,domNode:null}}const yn={bottom:"esri-text-overlay-item-anchor-bottom","bottom-right":"esri-text-overlay-item-anchor-bottom-right","bottom-left":"esri-text-overlay-item-anchor-bottom-left",top:"esri-text-overlay-item-anchor-top","top-right":"esri-text-overlay-item-anchor-top-right","top-left":"esri-text-overlay-item-anchor-top-left",center:"esri-text-overlay-item-anchor-center",right:"esri-text-overlay-item-anchor-right",left:"esri-text-overlay-item-anchor-left"};let N=class extends et{get position(){return[this.x,this.y]}set position(e){this._set("x",e[0]),this._set("y",e[1])}get _textShadowColor(){const{textColor:e,backgroundColor:t}=this,a=t.clone();return a.a*=e.a,a}get _textShadow(){const e=this._textShadowColor.toCss(!0);return`0 0 ${this._textShadowSize}px ${e}`}get padding(){return .5*this.fontSize}get borderRadius(){return this.padding}set borderRadius(e){this._overrideIfSome("borderRadius",e)}constructor(e){super(e),this.x=0,this.y=0,this.text="-",this.fontSize=14,this.anchor="center",this.visible=!0,this.isDecoration=!0,this.backgroundColor=new J([0,0,0,.6]),this.textColor=new J([255,255,255]),this._textShadowSize=1}render(){return zc("div",{classes:this._cssClasses(),styles:{left:Math.floor(this.x)+"px",top:Math.floor(this.y)+"px",visibility:this.visible?"visible":"hidden",fontSize:this.fontSize+"px",lineHeight:this.fontSize+"px",backgroundColor:this.backgroundColor.toCss(!0),color:this.textColor.toCss(!0),padding:this.padding+"px",borderRadius:this.borderRadius+"px",textShadow:this._textShadow}},[this.text])}renderCanvas(e){if(!this.visible)return;const t=e.font.replace(/^(.*?)px/,"");e.font=`${this.fontSize}px ${t}`;const{padding:a,borderRadius:n}=this,s=e.measureText(this.text).width,o=this.text!==""?this.fontSize:0,r=Cc[this.anchor];e.textAlign="center",e.textBaseline="middle";const l=s+2*a,c=o+2*a,h=this.x+r.x*l,p=this.y+r.y*c;this._roundedRect(e,h,p,l,c,n),e.fillStyle=this.backgroundColor.toCss(!0),e.fill();const g=this.x+(r.x+.5)*l,_=this.y+(r.y+.5)*c;this._renderTextShadow(e,this.text,g,_),e.fillStyle=this.textColor.toCss(!0),e.fillText(this.text,g,_)}_renderTextShadow(e,t,a,n){e.lineJoin="miter",e.fillStyle=`rgba(${this._textShadowColor.r}, ${this._textShadowColor.g}, ${this._textShadowColor.b}, ${1/wa.length})`;const s=this._textShadowSize;for(const[o,r]of wa)e.fillText(t,a+s*o,n+s*r)}_roundedRect(e,t,a,n,s,o){o=Math.min(o,s/2,n/2),e.beginPath(),e.moveTo(t,a+o),e.arcTo(t,a,t+o,a,o),e.lineTo(t+n-o,a),e.arcTo(t+n,a,t+n,a+o,o),e.lineTo(t+n,a+s-o),e.arcTo(t+n,a+s,t+n-o,a+s,o),e.lineTo(t+o,a+s),e.arcTo(t,a+s,t,a+s-o,o),e.closePath()}_cssClasses(){const e={"esri-text-overlay-item":!0};let t;for(t in yn)e[yn[t]]=this.anchor===t;return e}};u([d()],N.prototype,"x",void 0),u([d()],N.prototype,"y",void 0),u([d()],N.prototype,"position",null),u([d()],N.prototype,"text",void 0),u([d()],N.prototype,"fontSize",void 0),u([d()],N.prototype,"anchor",void 0),u([d()],N.prototype,"visible",void 0),u([d()],N.prototype,"isDecoration",void 0),u([d()],N.prototype,"backgroundColor",void 0),u([d()],N.prototype,"textColor",void 0),u([d()],N.prototype,"_textShadowSize",void 0),u([d()],N.prototype,"_textShadowColor",null),u([d()],N.prototype,"_textShadow",null),u([d()],N.prototype,"padding",null),u([d()],N.prototype,"borderRadius",null),N=u([H("esri.views.overlay.TextOverlayItem")],N);const Cc={bottom:{x:-.5,y:-1,textAlign:"center",textBaseline:"bottom"},"bottom-left":{x:0,y:-1,textAlign:"left",textBaseline:"bottom"},"bottom-right":{x:-1,y:-1,textAlign:"right",textBaseline:"bottom"},center:{x:-.5,y:-.5,textAlign:"center",textBaseline:"middle"},left:{x:0,y:-.5,textAlign:"left",textBaseline:"middle"},right:{x:-1,y:-.5,textAlign:"right",textBaseline:"middle"},top:{x:-.5,y:0,textAlign:"center",textBaseline:"top"},"top-left":{x:0,y:0,textAlign:"left",textBaseline:"top"},"top-right":{x:-1,y:0,textAlign:"right",textBaseline:"top"}},wa=[];for(let e=0;e<360;e+=360/16)wa.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)]);const Lc=3025,kc={default:15,far:25};let ce=class extends et{constructor(e){super(e),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messageUnitsTask=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){this.addHandles([w(()=>[this.context!=null&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),...["vertex-add","vertex-update","vertex-remove"].map(e=>Ft(()=>this.context?.editGeometryOperations,e,()=>this._update())),w(()=>this._colors,e=>this._updateStyle(e)),Vo(()=>this._refreshMessages()),L(()=>this._messageUnitsTask?.abort())]),this._refreshMessages()}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return this._messagesUnits==null}get test(){}get _messagesUnits(){return this._messageUnitsTask?.value}get _edgeDistancePixels(){return kc[this.edgeDistance]}get _colors(){const e=this.context?.view.effectiveTheme.textColor??J.fromArray([255,255,255]);return{textColor:e,backgroundColor:Oi($i(e,160),.6)}}_update(){if(this.destroyed)return;this._nextLabelIndex=0;const{context:e,stagedVertex:t}=this;if(!e)return this._destroyUnusedLabels();const{editGeometryOperations:a}=e,{parts:n,geometry:s,coordinateHelper:o}=a.data;if(!s)return this._destroyUnusedLabels();const r=n.length;for(let l=0;l<r;++l){const c=Hc(s,a,t,o,l);if(c.length<2||!Gc(c,e.view,e.elevationInfo,o.spatialReference))continue;const h=r===1&&!Fo(c);let p=Fc,g=Uc;this.toScreenPointArray(e,c[0],p);for(let _=1;_<c.length;++_){const f=c[_-1],m=c[_];this.toScreenPointArray(e,m,g),this._addLabel(e,f,p,m,g,h),[p,g]=[g,p]}}this._destroyUnusedLabels()}_updateStyle({textColor:e,backgroundColor:t}){const a=this._nextLabelIndex,n=this._labelInfos;for(let s=0;s<a;++s){const{label:o}=n[s];o.textColor=e,o.backgroundColor=t}}_addLabel(e,t,a,n,s,o){const{label:r}=this._getOrCreateLabel(e);if(!this.visible||Ms(a,s)<Lc)return void(r.visible=!1);const{spatialReference:l}=e.editGeometryOperations.data,c=e.automaticLengthMeasurementUtils.autoDistance2D(t,n,l),h=this._messagesUnits,p=Uo(e.view);r.text=h!=null&&c!=null?_l(h,c,p):"",r.visible=!0;const g=s[0]-a[0],_=s[1]-a[1];o?fi(pe,-_,g):fi(pe,_,-g),ja(pe,pe),Ut(pe,pe,this._edgeDistancePixels),Zo(Pt,a,s,.5),Ht(Pt,Pt,pe),r.position=[Pt[0],Pt[1]],Math.abs(pe[0])>Math.abs(pe[1])?r.anchor=pe[0]>0?"left":"right":r.anchor=-pe[1]<0?"top":"bottom"}_getOrCreateLabel(e){const t=this._labelInfos.length>this._nextLabelIndex,{textColor:a,backgroundColor:n}=this._colors;if(t){const r=this._labelInfos[this._nextLabelIndex++],{label:l}=r;return l.textColor=a,l.backgroundColor=n,r}const s=new N({anchor:"center",fontSize:8,textColor:a,backgroundColor:n});e.view.overlay?.items.add(s);const o={label:s};return this._labelInfos.push(o),this._nextLabelIndex=this._labelInfos.length,o}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:e}){this.context?.view.overlay?.items.remove(e),e.destroy()}_refreshMessages(){this._messageUnitsTask?.abort(),this._messageUnitsTask=Bo(()=>No("esri/core/t9n/Units"))}};function Hc(i,e,t,a,n){const s=[];for(const l of e.data.parts[n].iterateVertices())s.push(a.toXYZ(l.pos,b.get()));if(n===0&&t!=null&&s.push(a.toXYZ(t,b.get())),s.length<2)return s;const o=s[0],r=s[s.length-1];return i.type==="polygon"&&s.length>2&&!Wo(o,r)&&s.push(o),s}function Gc(i,e,t,a){if(e.type==="2d")return!0;const n=Yo(a)??1,s=qo(a),o=r=>Xo(e,r,a,t,Ta)??0;for(let r=1;r<i.length;++r){const l=i[r-1],c=i[r],h=(c[0]-l[0])*n,p=(c[1]-l[1])*n,g=(o(c)-o(l))*s;if(Math.abs(g)/Math.sqrt(h*h+p*p)>Vc)return!1}return!0}u([d()],ce.prototype,"context",void 0),u([d()],ce.prototype,"stagedVertex",void 0),u([d()],ce.prototype,"visible",void 0),u([d()],ce.prototype,"edgeDistance",void 0),u([d()],ce.prototype,"updating",null),u([d()],ce.prototype,"_messageUnitsTask",void 0),u([d()],ce.prototype,"_messagesUnits",null),u([d()],ce.prototype,"_edgeDistancePixels",null),u([d()],ce.prototype,"_colors",null),ce=u([H("esri.views.interactive.SegmentLabels")],ce);const Vc=Qe(5),pe=Tt(),Pt=Tt(),Fc=Me(),Uc=Me();let zi=class extends ce{getCameraOrExtent({view:e}){return e.state.camera}toScreenPointArray({view:e,elevationInfo:t,editGeometryOperations:a},n,s=Me()){const{spatialReference:o}=a.data.coordinateHelper;return ws(n,o,t,e,Mn),e.state.camera.projectToScreen(Mn,s),s}};zi=u([H("esri.views.3d.interactive.SegmentLabels3D")],zi);const Mn=M();let Ui=class extends Pa{constructor(e){super(e),this._ray=Qt(),this._isWorldDown=!1,this._start=M(),this._end=R(1,0,0),this._width=1,this._color=Ae(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=Ae(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=0,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=4,this._fadedExtensions=On,this._laserline=new Ei({view:this.view,isDecoration:e.isDecoration}),this.applyProperties(e)}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:wn,recreateGeometry:(t,a)=>this._recreateObject3DGeometry(t,a),cameraChanged:()=>this._updateGeometry(),forEachMaterial:(t,a)=>a(t.material)}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:wn,recreateGeometry:t=>this._recreateDrapedGeometry(t),forEachMaterial:(t,a)=>a(t.material)}}updateVisibility(e){super.updateVisibility(e),this._laserline.visible=e}onAttachedChange(){this._laserline.attached=this._laserlineAttached}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,Z(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),$(this._end,e,this._end),qi(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,$t(this._start,e)||(Z(this._start,e),qi(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,$t(this._end,e)||(Z(this._end,e),qi(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){Xe(e,this._color)||(Pe(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){Xe(e,this._innerColor)||(Pe(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=e!=null!=(this._stipplePattern!=null);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e!=null&&this._stippleOffColor!=null&&Xe(e,this._stippleOffColor)||(this._stippleOffColor=e!=null?Jo(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.recreateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&this._laserlineStyle!=null&&this.attached&&!this.isDraped}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,e!=null&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===8?4:this._renderOccluded}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=e??On,this.recreateGeometry()}_updateMaterial(){const{materialParameters:e}=this;this.object3dResources.resources?.material.setParameters(e),this.drapedResources.resources?.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._normalizedRenderOccluded,isDecoration:this.isDecoration,writeDepth:this._writeDepthEnabled}}_createObject3DResources(e){const t=new be(this.materialParameters,this.view.state.isGlobal),a=new Array;return this._createObject3DGeometry(t,e,a),{material:t,geometries:a}}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,a){const n=this._createGeometry(e);a.push(n),t.addGeometry(n),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new be(this.materialParameters,this.view.state.isGlobal);return{material:e,geometries:[this._createDrapedGeometry(e)]}}_recreateDrapedGeometry(e){e.geometries=[this._createDrapedGeometry(e.material)]}_createDrapedGeometry(e){const t=this._createGeometry(e);return this._updateVerticesDraped(t),new za(t)}_createGeometry(e){const t=this.extensionType===3,a=t?[M(),M(),M(),M()]:[M(),M()];return ve(e,a,null,t?[1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]:null)}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this._lineSegment;this._updateVertexAttributesObject3D(e,t),this._laserline.intersectsLine=t}_updateVerticesDraped(e){this._updateVertexAttributesDraped(e,this._lineSegment)}get _lineSegment(){return this._extensionType===3?this._updateLineSegmentFinite(xn):this._updateLineSegmentInfinite(this._extensionType,xn)}_updateLineSegmentFinite(e){return mi(this._start,this._end,e)}_updateLineSegmentInfinite(e,t){const a=this.view.state.camera;switch(Qo(this._ray,ke),e){case 0:ke.c0=-Number.MAX_VALUE;break;case 1:case 2:{const o=this._ray.origin,r=this.view.elevationProvider.getElevation(o[0],o[1],o[2],this.view.renderCoordsHelper.spatialReference,"ground")??0,l=this.view.renderCoordsHelper.getAltitude(o);this._isWorldDown&&l<r&&Ko(ke.ray.direction,ke.ray.direction),this._extensionType===2&&r!=null&&(ke.c1=Math.abs(l-r));break}}if(!tr(a.frustum,ke))return this._updateLineSegmentFinite(t);const n=ir(ke,at),s=ar(ke,Zc);return mi(n,s,t)}_updateVertexAttributesObject3D(e,t){const a=e.geometries[0].getMutableAttribute("position")?.data;if(!a)return;let n=0;for(const s of this._lineVertices(t))a[n++]=s[0],a[n++]=s[1],a[n++]=s[2];e.geometryVertexAttributeUpdated(e.geometries[0],"position")}_updateVertexAttributesDraped(e,t){const a=e.getMutableAttribute("position")?.data;if(!a)return;let n=0;for(const s of this._lineVertices(t))a[n++]=s[0],a[n++]=s[1],a[n++]=ji;e.invalidateBoundingInfo()}*_lineVertices(e){this.extensionType===3?(yield ft(e,-this.fadedExtensions.start,at),yield ft(e,0,at),yield ft(e,1,at),yield ft(e,1+this.fadedExtensions.end,at)):(yield ft(e,0,at),yield ft(e,1,at))}};function wn(i){i.geometries=[]}const ke=er(),at=M(),Zc=M(),xn=xs(),Sn=1/3,On={start:Sn,end:Sn};let Bc=class extends Pa{constructor(e){super(e),this._location=M(),this._direction=R(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=Ae(1,0,1,1),this._renderOccluded=4,this.applyProperties(e)}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:Nc,recreateGeometry:(t,a)=>this._recreateObject3DGeometry(t,a),cameraChanged:()=>this._updateGeometry(),forEachMaterial:(t,a)=>a(t.material)}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:Wc,recreateGeometry:t=>this._recreateDrapedGeometry(t),forEachMaterial:(t,a)=>a(t.material)}}get location(){return this._location}set location(e){$t(this._location,e)||(Z(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){$t(this._direction,e)||(Z(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){te(this._direction,$(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){Xe(e,this._color)||(Pe(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get isDecoration(){return this._isDecoration}set isDecoration(e){this._isDecoration=e,this._updateMaterial()}_createObject3DResources(e){const t=new be(this.materialParameters,this.view.state.isGlobal),a=new Array;return this._createObject3DGeometry(t,e,a),{material:t,geometries:a}}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,a){const[n,s]=$n(e);t.addGeometry(n),t.addGeometry(s),a.push(n),a.push(s),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new be(this.materialParameters,this.view.state.isGlobal),t=w(()=>this.view.state.contentPixelRatio,()=>this.drapedResources.recreateGeometry());return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const t=$n(e);return this._updateVerticesDraped(t),t.map(a=>new za(a))}_updateMaterial(){const{materialParameters:e}=this;this.object3dResources.resources?.material.setParameters(e),this.drapedResources.resources?.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this.view.state.camera;t.projectToScreen(this.location,ni),P(xe,this.location,this.direction),t.projectToScreen(xe,mt),ja(mt,nr(mt,mt,ni)),this._updateVertexAttributesObject3D(t,e,0,ni,mt,1),this._updateVertexAttributesObject3D(t,e,1,ni,mt,-1)}_updateVertexAttributesObject3D(e,t,a,n,s,o){const r=t.geometries[a],l=r.getMutableAttribute("position")?.data;if(!l)return;const{start:c,end:h}=Dn(s,n,o,this.offset,this.width,this.length);e.unprojectFromScreen(vi(c),xe),l[0]=xe[0],l[1]=xe[1],l[2]=xe[2],e.unprojectFromScreen(vi(h),xe),l[3]=xe[0],l[4]=xe[1],l[5]=xe[2],t.geometryVertexAttributeUpdated(r,"position")}_updateVerticesDraped(e){const{view:{overlayManager:t,state:{contentPixelRatio:a}}}=this,{location:n,width:s,length:o,offset:r}=this,l=Yc;l.spatialReference=t.spatialReference,l.x=n[0],l.y=n[1];const c=this.view.overlayPixelSizeInMapUnits(l)*a,h=s*c,p=o*c,g=r*c;this._updateVertexAttributesDraped(e[0],h,p,g,-1),this._updateVertexAttributesDraped(e[1],h,p,g,1)}_updateVertexAttributesDraped(e,t,a,n,s){const o=e.getMutableAttribute("position")?.data;if(!o)return;const{location:r,direction:l}=this,{start:c,end:h}=Dn(l,r,s,n,t,a);o[0]=c[0],o[1]=c[1],o[2]=ji,o[3]=h[0],o[4]=h[1],o[5]=ji,e.invalidateBoundingInfo()}};function $n(i){return[ve(i,[M(),M()]),ve(i,[M(),M()])]}function Dn(i,e,t,a,n,s){const o=Ut(En,fi(En,i[1]*t,i[0]*-t),a+n/2),r=Ht(ai,Ht(ai,Ht(ai,e,Ut(ai,i,s/2)),o),o);return{start:r,end:Ht(jn,r,Ut(jn,i,-s))}}function Nc(i){i.geometries.length=0}function Wc(i){i.pixelRatioHandle.remove(),i.geometries=[]}const xe=M(),En=Tt(),ai=Tt(),jn=Tt(),ni=Me(),mt=Me(),Yc=It(0,0,void 0,null);let fo=class extends ml{constructor(e){super(e),this._resources=null,this._transform=le()}get object(){return this._resources!=null?this._resources.object:null}get transform(){return this._transform}set transform(e){Ss(this._transform,e),this._resources!=null&&(this._resources.object.transformation=this._transform)}recreate(){this.attached&&this.createResources()}recreateGeometry(){if(this._resources==null)return;const e=this._resources.object;e.removeAllGeometries(),this.createGeometries(e),e.visible=this.visible}createResources(){this.destroyResources();const e=this.view.stage;if(!e)return;const t=new Zs(e,{pickable:!1,updatePolicy:1}),a=new Bs({castShadow:!1});a.transformation=this._transform,this.createExternalResources(),this.createGeometries(a),t.add(a),a.visible=this.visible,this._resources={layer:t,object:a}}destroyResources(){const e=this.view.stage;this._resources!=null&&e&&(this._resources.layer.destroy(),this._resources.object.dispose(),this.destroyExternalResources(),this._resources=null)}updateVisibility(e){this._resources!=null&&(this._resources.object.visible=e)}},xa=class extends fo{constructor(e){super(e),this._material=null,this._texture=null,this._geometry=null,this._size=3,this._color=Ae(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=Ae(1,1,1,1),this._elevationInfo=null,this.applyProperties(e)}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const t=this._preferredTextureSize;this._size=e,t<this._preferredTextureSize?this.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){Xe(e,this._color)||(Pe(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,this.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){Xe(e,this._outlineColor)||(Pe(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}_updateMaterial(){this._material?.setParameters(this._materialParameters)}_updateSizeAttribute(){const e=this.object;if(e==null)return;const t=e.geometries[0];if(t==null)return;const a=t.getMutableAttribute("size").data,n=this._geometrySize;a[0]=n,a[1]=n,e.geometryVertexAttributeUpdated(e.geometries[0],"size")}get _materialParameters(){return{color:this._color,textureIsSignedDistanceField:!0,sampleSignedDistanceFieldTexelCenter:Ol(this._primitive),distanceFieldBoundingBox:Sl,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:this._texture?.id,polygonOffset:!1,shaderPolygonOffset:0,drawAsLabel:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled,isDecoration:this.isDecoration}}get _geometrySize(){return this._size/$l}createExternalResources(){this._texture=Dl(this._primitive,this._preferredTextureSize),this._material=new vl(this._materialParameters,this.view.state.viewingMode===1);const e=this.view.stage;this._texture.load(e.renderView.renderingContext),e.addTexture(this._texture)}destroyExternalResources(){this._texture&&(this.view.stage.removeTexture(this._texture),this._texture.dispose(),this._texture=null),this._material=null}createGeometries(e){const t=this._createRenderGeometry();t!=null&&e.addGeometry(t)}forEachMaterial(e){e(this._material)}get _preferredTextureSize(){return bi(2*this._geometrySize,16,128)}calculateMapBounds(e){const t=this.object?.geometries[0];if(!t)return!1;const a=t.attributes.get("position").data;return Je(a,this.view.renderCoordsHelper.spatialReference,Tn,this.view.spatialReference),sr(e,Tn),!0}_createRenderGeometry(){const{geometry:e,_material:t}=this;if(e==null||t==null)return null;const{renderCoordsHelper:a,elevationProvider:n}=this.view,s=Gi(e,n,ti.fromElevationInfo(this.elevationInfo),a),o=B(b.get(),e.x,e.y,s),r=b.get();Je(o,e.spatialReference,r,a.spatialReference);const l=this._geometrySize;return bl(t,{position:r,size:[l,l],centerOffsetAndDistance:[0,0,0,1]})}};const Tn=M();let qc=class extends Pa{constructor(e){super(e),this._maxSize=0,this._position=M(),this._up=M(),this._right=M(),this._renderOccluded=4,this._color=Ae(1,0,0,1),this._outlineColor=Ae(0,0,0,1),this._outlineSize=0,this._size=32,this._outlineRenderOccluded=16,this.applyProperties(e)}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:()=>{},cameraChanged:()=>this._updateTransformObject3D(),forEachMaterial:(t,a)=>{a(t.outlineMaterial),a(t.quadMaterial)}}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:Xc,forEachMaterial:(t,a)=>{a(t.outlineMaterial),a(t.quadMaterial)}}}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateQuadMaterial())}get isDecoration(){return this._isDecoration}set isDecoration(e){this._isDecoration=e,this._updateOutlineMaterial(),this._updateQuadMaterial()}get color(){return this._color}set color(e){Pe(this._color,e),this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(e){Pe(this._outlineColor,e),this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(e){const t=this._outlineSize===0!=(e===0);this._outlineSize=e,t?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(e){this._outlineRenderOccluded=e,this._updateOutlineMaterial()}set geometry({previous:e,center:t,next:a}){this._maxSize=Math.min(Ya(t,e),Ya(t,a))/3,te(this._up,$(this._up,e,t)),te(this._right,$(this._right,a,t)),Z(this._position,t),this.recreateGeometry()}_createObject3DResources(e){const t=new fe(this._quadMaterialParameters),a=this._outlineSize===0?void 0:new be(this._outlineMaterialParameters,this.view.state.isGlobal);return this._createObject3DGeometries(e,t,a),{quadMaterial:t,outlineMaterial:a}}_createObject3DGeometries(e,t,a){if($t(this._up,pa)&&$t(this._right,pa))return;const n=this._createGeometries(t,a);for(const s of n)e.addGeometry(s);this._updateTransformObject3D(e)}_createDrapedResources(){const e=new fe(this._quadMaterialParameters),t=this._outlineSize===0?void 0:new be(this._outlineMaterialParameters,this.view.state.isGlobal),a=this._createGeometries(e,t).map(n=>new za(n));return this._setTransformDraped(a),{quadMaterial:e,outlineMaterial:t,geometries:a,pixelRatioHandle:w(()=>this.view.state.contentPixelRatio,()=>this.drapedResources.recreateGeometry())}}_createGeometries(e,t){const{up:a,right:n,corner:s}=this._getVertices(),o=Jc(a,n,s,e);return t?[o,ve(t,[a,s,n])]:[o]}_getVertices(){let e=this._up,t=this._right;const a=P(b.get(),e,t);return this.isDraped&&(e=Z(b.get(),e),t=Z(b.get(),t),e[2]=0,t[2]=0,a[2]=0),{up:e,right:t,corner:a}}_updateTransform(){this.isDraped?this.drapedResources.recreateGeometry():this._updateTransformObject3D()}_updateTransformObject3D(e=this.object3dResources.object){if(!e)return;const t=this.view.state.camera,a=this._size*t.computeScreenPixelSizeAt(this._position),n=Math.min(this._maxSize,a);yi(He,this._position),Yt(He,He,[n,n,n]),e.transformation=He}_setTransformDraped(e){if(e.length===0)return;const{view:{overlayManager:t,state:{contentPixelRatio:a}}}=this,{_position:n,_size:s}=this,o=Z(b.get(),n);o[2]=ji;const r=Qc;r.spatialReference=t.spatialReference,r.x=o[0],r.y=o[1];const l=s*(this.view.overlayPixelSizeInMapUnits(r)*a),c=Math.min(this._maxSize,l);yi(He,o),Yt(He,He,[c,c,1]);for(const h of e)h.transformation=He}get _quadMaterialParameters(){return{color:this._color,forceTransparentMode:!0,writeDepth:!1,polygonOffset:!0,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateQuadMaterial(){this.object3dResources.resources?.quadMaterial.setParameters(this._quadMaterialParameters),this.drapedResources.resources?.quadMaterial.setParameters(this._quadMaterialParameters)}get _outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded,isDecoration:this.isDecoration}}_updateOutlineMaterial(){this.object3dResources.resources?.outlineMaterial?.setParameters(this._outlineMaterialParameters),this.drapedResources.resources?.outlineMaterial?.setParameters(this._outlineMaterialParameters)}};function Xc(i){i.pixelRatioHandle.remove(),i.geometries=[]}function Jc(i,e,t,a){return new Ns(a,[["position",new ga([0,0,0,...e,...i,...t],[0,1,2,1,2,3],3,!0)]])}const He=le(),Qc=It(0,0,void 0,null);let Xt=class extends Jl{sortUniqueHints(e){return e.sort((t,a)=>(a instanceof qa?a.length:0)-(t instanceof qa?t.length:0))}visualizeIntersectionPoint(e,t){const{spatialReference:a,view:n}=t,s=zt(t);return re(new xa({view:n,primitive:"circle",geometry:Xa(e.intersectionPoint,a),elevationInfo:e.isDraped?Os:Ta,size:20,outlineSize:2,color:s.intersectionPointColor,outlineColor:s.intersectionPointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizePoint(e,t){const{view:a,spatialReference:n}=t,s=zt(t),o=Ge(e.point,e.domain,t);return re(new xa({view:a,primitive:"circle",geometry:Xa(o,n),elevationInfo:si(e),size:20,outlineSize:2,color:s.pointColor,outlineColor:s.pointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizeLine(e,t){const{view:a,spatialReference:n}=t,s=zt(t),o=Ge(e.lineStart,e.domain,t),r=Ge(e.lineEnd,e.domain,t);return re(Kc(e.type,o,r,n,si(e),a,s,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{view:a,spatialReference:n}=t,s=zt(t),{isDraped:o}=e,r=si(e),l=Ge(e.lineStart,e.domain,t),c=Ge(e.lineEnd,e.domain,t),h=rt(l,n,r,a,o),p=rt(c,n,r,a,o),g=Ye(p,h,p,.5),_=new Bc({view:a,attached:!1,offset:_e.parallelLineHintOffset,length:_e.parallelLineHintLength,width:_e.parallelLineHintWidth,color:s.parallelSignColor,location:g,renderOccluded:o?4:16,isDraped:o,renderGroup:3,isDecoration:!0});return _.setDirectionFromPoints(h,g),_.attached=!0,re(_)}visualizeRightAngleQuad(e,t){const{view:a,spatialReference:n}=t,s=zt(t),o=si(e),{isDraped:r}=e,l=Ge(e.previousVertex,e.domain,t),c=Ge(e.centerVertex,e.domain,t),h=Ge(e.nextVertex,e.domain,t),p=rt(l,n,o,a,r),g=rt(c,n,o,a,r),_=rt(h,n,o,a,r);return re(new qc({view:a,attached:!0,color:r?s.rightAngleColorDraped:s.rightAngleColor,renderOccluded:r?4:2,outlineRenderOccluded:r?4:16,outlineColor:s.rightAngleOutlineColor,outlineSize:_e.rightAngleHintOutlineSize,size:_e.rightAngleHintSize,isDraped:r,geometry:{previous:p,center:g,next:_},renderGroup:3,isDecoration:!0}))}};function zt(i){const{effectiveTheme:e}=i.view,t=J.toUnitRGBA(e.accentColor),a=[0,0,0,0];return{intersectionPointColor:a,intersectionPointOutlineColor:t,pointColor:a,pointOutlineColor:t,lineColor:t,lineOutlineColor:void 0,parallelSignColor:t,rightAngleColor:t,rightAngleColorDraped:J.toUnitRGBA(Oi(e.accentColor,.5)),rightAngleOutlineColor:t}}function Ge(i,e,{selfSnappingZ:t,view:a,spatialReference:n}){return 2&e&&rr(i)&&t!=null?or(i,t,a,n):i}function si(i){return i.isDraped?Os:Ta}function Kc(i,e,t,a,n,s,o,r=!1,l=!0,c=!0){const h=rt(e,a,n,s,r),p=rt(t,a,n,s,r),g=new Ui({view:s,extensionType:3,start:h,end:p,isDraped:r,color:o.lineColor,renderOccluded:r?4:16,renderGroup:3,isDecoration:!0});switch(i){case 0:g.width=_e.lineHintWidthTarget,g.fadedExtensions={start:0,end:_e.lineHintFadedExtensions};break;case 2:g.width=_e.lineHintWidthReference,g.fadedExtensions={start:0,end:0};break;case 1:g.width=_e.lineHintWidthReference,g.fadedExtensions={start:l?_e.lineHintFadedExtensions:0,end:c?_e.lineHintFadedExtensions:0}}return g.attached=!0,g}function rt(i,e,t,a,n){const s=M();if(n){const o=a.overlayManager.spatialReference;Je(i,e,s,o)}else ws(i,e,t,a,s);return s}function Fa(i){const e=i.graphic;return e?[w(()=>"visible"in i?i.visible:i.displaying,t=>{t&&e.notifyMeshTransformChanged({action:0})},{...Ke}),L(()=>e.notifyMeshTransformChanged({action:1}))]:[]}function eh(i,e,t,a,n){const s=Ja(3*i.length),o=Ja(s.length);i.forEach((c,h)=>{s[3*h]=c[0],s[3*h+1]=c[1],s[3*h+2]=c.length>2?c[2]:0});const r=xl(s,e,0,o,0,s,0,s.length/3,t,a,n),l=r!=null;return{numVertices:i.length,position:s,mapPositions:o,projectionSuccess:l,sampledElevation:r}}function th(i,e){if(!e.screenSizeEnabled)return;const t=i.vertex;El(t,e),t.uniforms.add(new jl("perScreenPixelRatio",a=>a.camera.perScreenPixelRatio),new Ca("screenSizeScale",a=>a.screenSizeScale)).code.add(ue`float computeRenderPixelSizeAt( vec3 pWorld ){
vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);
float viewDirectionDistance = abs(dot(viewForward, pWorld - cameraPosition));
return viewDirectionDistance * perScreenPixelRatio;
}
vec3 screenSizeScaling(vec3 position, vec3 anchor){
return position * screenSizeScale * computeRenderPixelSizeAt(anchor) + anchor;
}`)}function mo(i){const e=new Va;e.include(lo),e.include(th,i),e.fragment.include(Ws,i),e.include(Ys,i),e.include(qs,i);const{vertex:t,fragment:a}=e;return a.include(Xs),La(t,i),a.uniforms.add(new Ii("uColor",n=>n.color)),e.attributes.add("position","vec3"),e.varyings.add("vWorldPosition","vec3"),i.screenSizeEnabled&&e.attributes.add("offset","vec3"),i.shadingEnabled&&(Tl(t),e.attributes.add("normal","vec3"),e.varyings.add("vViewNormal","vec3"),a.uniforms.add(new Il("shadingDirection",n=>n.shadingDirection)),a.uniforms.add(new Ii("shadedColor",n=>ih(n.shadingTint,n.color)))),t.main.add(ue`
    vWorldPosition = ${i.screenSizeEnabled?ue`screenSizeScaling(offset, position)`:ue`position`};
    ${Ma(i.shadingEnabled,ue`vec3 worldNormal = normal;
           vViewNormal = (viewNormal * vec4(worldNormal, 1)).xyz;`)}
    forwardViewPosDepth((view * vec4(vWorldPosition, 1.0)).xyz);
    gl_Position = transformPosition(proj, view, vWorldPosition);
  `),a.main.add(ue`
      discardBySlice(vWorldPosition);
      discardByTerrainDepth();
      ${i.shadingEnabled?ue`vec3 viewNormalNorm = normalize(vViewNormal);
             float shadingFactor = 1.0 - clamp(-dot(viewNormalNorm, shadingDirection), 0.0, 1.0);
             vec4 finalColor = mix(uColor, shadedColor, shadingFactor);`:ue`vec4 finalColor = uColor;`}
      outputColorHighlightOID(finalColor, vWorldPosition, finalColor.rgb);`),e}function ih(i,e){const t=1-i[3],a=i[3]+e[3]*t;return a===0?(nt[3]=a,nt):(nt[0]=(i[0]*i[3]+e[0]*e[3]*t)/a,nt[1]=(i[1]*i[3]+e[1]*e[3]*t)/a,nt[2]=(i[2]*i[3]+e[2]*e[3]*t)/a,nt[3]=e[3],nt)}const nt=lr(),ah=Object.freeze(Object.defineProperty({__proto__:null,build:mo},Symbol.toStringTag,{value:"Module"}));let nh=class extends Js{constructor(e,t){super(e,t,new Qs(ah,()=>$s(()=>Promise.resolve().then(()=>Md),void 0)),vo(t).locations)}initializePipeline(e){const{oitPass:t,output:a,transparent:n,cullFace:s,shadingEnabled:o}=e,r=t===0,l=t===2;return co({blending:ka(a)&&n?to(t):null,culling:uo(s),depthTest:{func:l?513:o?515:513},depthWrite:eo(e),drawBuffers:Ks(t,a),colorWrite:ho,polygonOffset:r||l?null:Rl})}};function vo(i){const e=rc().vec3f("position").vec3f("normal");return i.screenSizeEnabled&&e.vec3f("offset"),e}let Ue=class extends io{constructor(){super(...arguments),this.cullFace=0,this.transparent=!1,this.writeDepth=!0,this.screenSizeEnabled=!0,this.shadingEnabled=!0,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.textureCoordinateType=0,this.emissionSource=0,this.occlusionPass=!1,this.olidColorInstanced=!1,this.draped=!1,this.overlayEnabled=!1,this.snowCover=!1}get discardInvisibleFragments(){return this.transparent}};u([ne({count:3})],Ue.prototype,"cullFace",void 0),u([ne()],Ue.prototype,"transparent",void 0),u([ne()],Ue.prototype,"writeDepth",void 0),u([ne()],Ue.prototype,"screenSizeEnabled",void 0),u([ne()],Ue.prototype,"shadingEnabled",void 0),u([ne()],Ue.prototype,"terrainDepthTest",void 0),u([ne()],Ue.prototype,"cullAboveTerrain",void 0);let Sa=class extends Al{constructor(e){super(e,oh),this._configuration=new Ue,this.supportsEdges=!0,this._pp0=R(0,0,1),this._pp1=R(0,0,0),this.produces=new Map([[2,t=>t===9||Ji(t)&&!this.parameters.transparent],[4,t=>Ji(t)&&this.parameters.transparent&&this.parameters.writeDepth],[8,t=>Ji(t)&&this.parameters.transparent&&!this.parameters.writeDepth]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.screenSizeEnabled=this.parameters.screenSizeEnabled,this._configuration.shadingEnabled=this.parameters.shadingEnabled,this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest&&ka(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration}get visible(){return this.parameters.color[3]>=Pl}intersect(e,t,a,n,s,o){this._intersect(e,a,n,s,o)}intersectDraped(e,t,a,n){return this._pp0[0]=this._pp1[0]=a[0],this._pp0[1]=this._pp1[1]=a[1],this._intersect(e,t,this._pp0,this._pp1,n)}_intersect(e,t,a,n,s){if(this.parameters.screenSizeEnabled){const o=e.attributes.get("offset");fn(e,t,a,n,{applyToVertex:(l,c,h,p)=>{const g=B(In,o.data[3*p],o.data[3*p+1],o.data[3*p+2]),_=B(lh,l,c,h);return U(g,g,this.parameters.screenSizeScale*(t.camera?.computeScreenPixelSizeAt(g)??1)),P(_,_,g),[_[0],_[1],_[2]]},applyToAabb:l=>{const c=cr(l,In);return hr(l,this.parameters.screenSizeScale*(t.camera?.computeScreenPixelSizeAt(c)??1))}},s)}else fn(e,t,a,n,void 0,s)}createGLMaterial(e){return new sh(e)}createBufferWriter(){return new rh(vo(this.parameters))}},sh=class extends no{beginSlot(e){return this.getTechnique(nh,e)}},oh=class extends ao{constructor(){super(...arguments),this.color=Ae(1,1,1,1),this.shadingTint=Ae(0,0,0,.25),this.shadingDirection=te(M(),[.5,-.5,-.5]),this.screenSizeScale=14,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=0,this.screenSizeEnabled=!1,this.shadingEnabled=!0}get transparent(){return this.color[3]<1||this.forceTransparentMode}},rh=class{constructor(e){this.layout=e}elementCount(e){return e.get("position").indices.length}write(e,t,a,n,s,o){const r=zl(a,n,this.layout,e,t,s,o),l=s.getField("offset",nc);if(l&&a.has("offset")){const c=a.get("offset");ro(c.size===3),Cl(c,t,l,o)}return r}};const In=M(),lh=M();let Rn=class extends fo{constructor(e){super(e),this.view=null,this._renderOccluded=4,this._vertices=null,this._spatialReference=null,this._color=Qa([1,127/255,0,1]),this._size=11,this._outlineColor=Qa([0,0,0,.5]),this._outlineSize=1,this._elevationInfo=null,this.applyProperties(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){Xe(e,this._color)||(Pe(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){Xe(e,this._outlineColor)||(Pe(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get _vertexMaterialParameters(){return{color:this._color,screenSizeScale:this.size,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}get _vertexOutlineMaterialParameters(){return{color:this._outlineColor,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateMaterial(){this.attached&&this._vertexMaterial.setParameters(this._vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this._vertexOutlineMaterial.setParameters(this._vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(e==null||e.length===0)return[];const t=.5,a=.5,n=eh(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,ti.fromElevationInfo(this.elevationInfo)),s=[],o=n.numVertices,r=n.position;for(let l=0;l<o;++l){const c=B(ch,r[3*l],r[3*l+1],r[3*l+2]),h=An(this._vertexMaterial,t,c),p=An(this._vertexOutlineMaterial,a,c);s.push({vertexGeometry:h,vertexOutlineGeometry:p})}return s}createGeometries(e){const t=this._createRenderGeometries();for(const{vertexGeometry:a,vertexOutlineGeometry:n}of t)e.addGeometry(a),e.addGeometry(n)}createExternalResources(){this._vertexMaterial=new Sa({...this._vertexMaterialParameters,writeDepth:!0,cullFace:2,screenSizeEnabled:!0}),this._vertexOutlineMaterial=new Sa({...this._vertexOutlineMaterialParameters,forceTransparentMode:!0,writeDepth:!0,cullFace:1,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this._vertexMaterial=null,this._vertexOutlineMaterial=null}forEachMaterial(e){e(this._vertexMaterial),e(this._vertexOutlineMaterial)}};const ch=M();function An(i,e,t){return Gt(i,e,16,16,{offset:t})}let ot=class extends lc{constructor(e){super(e),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._verticalLineVisualElement=null,this._settings=new _t({getTheme:()=>this.view.effectiveTheme}),this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:e,offset:t,unit:a,featureExpressionInfo:n}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new ur({mode:e,offset:t,unit:a,featureExpressionInfo:n})}normalizeCtorArgs(e){if(!e.elevationInfo){const t=e.hasZ??!0;return{...e,elevationInfo:dr(t)}}return e}initializeGraphic(e){const{view:t}=this,a=this._createGraphicState=new po({graphic:e});return F([t.maskOccludee(e),t.trackGraphicState(a),w(()=>({element:this._outlineVisualElement,isDraped:a.isDraped}),({element:n,isDraped:s})=>{n&&(n.isDraped=s)},Ke),pr(()=>{ba(this.tooltipInfos.mesh,this.geometryToPlace)}),this._setupLoadingIndicator(a),...Fa(a)])}makeDrawOperation(){const{geometryType:e}=this,t=e!=="circle"&&e!=="rectangle";return new cc({view:this.view,manipulators:this.manipulators,geometryType:dc(e),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new uc(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new hc(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new Xt,segmentLabels:t?new zi:null,labelOptions:this.sketchOptions.labels,isDraped:this._createGraphicState?this._createGraphicState.isDraped:Ka(this.hasZ,this.elevationInfo)==="on-the-ground",cursor:this.cursor,constraintsEnabled:!0,automaticLengthMeasurementUtils:this.automaticLengthMeasurementUtils})}onActiveVertexChanged(e){const{view:t}=this;if(this._activeVertexVisualElement)return this._activeVertexVisualElement.vertices=[e],this._activeVertexVisualElement.recreate(),this._updateVerticalLineVisualElement(e),L();const a=this._settings,n=a.manipulators.vertex,s=new Rn({view:t,spatialReference:t.spatialReference,vertices:[e],elevationInfo:this.internalGraphicsLayer.elevationInfo,size:n.size,outlineSize:n.outlineSize,renderOccluded:n.renderOccluded,attached:!1,isDecoration:!0});this._activeVertexVisualElement=s;const o=a.visualElements.zVerticalLine,r=new Ui({view:t,extensionType:o.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4,isDecoration:!0});this._verticalLineVisualElement=r;const l=F([w(()=>a.visualElements.zVerticalLine,c=>c.apply(r),A),w(()=>({selectedColor:K(a.colors.selected),outlineColor:K(a.manipulators.vertex.outlineColor)}),({selectedColor:c,outlineColor:h})=>{s.color=c,s.outlineColor=h},A),L(()=>{this._activeVertexVisualElement=C(this._activeVertexVisualElement),this._verticalLineVisualElement=C(this._verticalLineVisualElement)})]);return s.attached=!0,this._updateVerticalLineVisualElement(e),l}_updateVerticalLineVisualElement(e){const t=this._verticalLineVisualElement;if(!t)return;const{renderCoordsHelper:a,elevationProvider:n}=this.view;B(vt,e[0],e[1],e[2]),Pn.setFromElevationInfo(this.elevationInfo),vt[2]=Gi(vt,n,Pn,a),a.toRenderCoords(vt,this.view.spatialReference,vt)?(t.setStartEndFromWorldDownAtLocation(vt),t.attached=!0):t.attached=!1}onOutlineChanged(e){if(this._outlineVisualElement)return this._outlineVisualElement.geometry=e,L();const t=this.internalGraphicsLayer.elevationInfo,{view:a}=this,n=this._settings,s=new pt({view:a,geometry:e,elevationInfo:t,isDraped:this._createGraphicState?this._createGraphicState.isDraped:Ka(this.hasZ,t)==="on-the-ground",attached:!1,isDecoration:!0});this._outlineVisualElement=s;const o=F([w(()=>n.visualElements.lineObjects.outline,r=>r.apply(s),A),w(()=>n.visualElements.lineObjects.shadowStyle,r=>r.apply(s),A),L(()=>{this._outlineVisualElement=C(this._outlineVisualElement)})]);return s.attached=!0,s.laserlineEnabled=!0,o}onRegularVerticesChanged(e){if(this._verticesVisualElement)return this._verticesVisualElement.vertices=e,L();const{view:t}=this,a=this._settings,n=a.manipulators.vertex,s=new Rn({view:t,spatialReference:t.spatialReference,vertices:e,elevationInfo:this.internalGraphicsLayer.elevationInfo,size:n.size,outlineSize:n.outlineSize,renderOccluded:n.renderOccluded,attached:!1,isDecoration:!0}),o=F([w(()=>({color:K(a.manipulators.vertex.color),outlineColor:K(a.manipulators.vertex.outlineColor)}),({color:r,outlineColor:l})=>{s.color=r,s.outlineColor=l},A),L(()=>{this._verticesVisualElement=C(this._verticesVisualElement)})]);return s.attached=!0,this._verticesVisualElement=s,o}updateGraphicGeometry(e){if(this.geometryType==="mesh"&&e?.type==="point"){const t=this.geometryToPlace;t?.centerAt(e),ba(this.tooltipInfos.mesh,t);const a=this._graphic;return void(t&&a.geometry===t||(a.geometry=t))}super.updateGraphicGeometry(e)}_setupLoadingIndicator(e){const{drawOperation:t}=this;if(!this.geometryToPlace||e.displaying)return t.loading=!1,null;t.loading=!0;const a=L(()=>{t.loading=!1});let n;const s=()=>{n&&cancelAnimationFrame(n)};return F([Dt(()=>e.displaying,()=>{s(),n=requestAnimationFrame(()=>a.remove())},{...Ke,once:!0}),L(s),a])}};u([d({constructOnly:!0})],ot.prototype,"elevationInfo",void 0),u([d({constructOnly:!0})],ot.prototype,"geometryType",void 0),u([d()],ot.prototype,"type",void 0),u([d({constructOnly:!0})],ot.prototype,"view",void 0),ot=u([H("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],ot);const Pn=new ti,vt=M();function hh(i){const e=Ua(i);return _r(Math.cos(e),Math.sin(e))}function Ua(i){if(i==null||i.type!=="polyline"&&i.type!=="polygon")return 0;const e=i.type==="polyline"?i.paths:i.rings,t=gr();for(const a of e)for(let n=0;n<a.length-1;n++){const s=a[n],o=a[n+1],r=s[0]-o[0],l=s[1]-o[1];if(r*r+l*l>t)return Math.atan2(o[1]-s[1],o[0]-s[0])}return 0}function k(i){return i?.operations?.data.geometry}function ht(i,e){return uh(i?.data.coordinateHelper.hasZ(),e)}function uh(i,e){return!!i&&e.mode!=="on-the-ground"&&!fr(e)}function bo(i,e,t){function a(){const r=t(),l=r.sketchOptions.tooltips.effectiveEnabled?r.activeTooltipInfo:null;return{...r,activeTooltipInfo:l}}let n=!1;function s(r){n||(n=!0,r(),n=!1)}function o({activeTooltipInfo:r,sketchOptions:l,scaleRotateTransform:c}){s(()=>{r&&(r.sketchOptions=l,yo(r,e),dh(r,c)),i.info=r})}return F([w(a,o,Ke),w(()=>{const r=a(),{activeTooltipInfo:l}=r;if(l)return{context:r,activeTooltipInfo:l,key:l.key,geometry:k(e)}},(r,l)=>{r&&l&&l.key!==r.key&&s(()=>zn(e,r.context))},Et),e.on("committed",()=>{queueMicrotask(()=>o(a()))}),Gs(i,{onBeforePaste:()=>{n=!0},onAfterPaste:()=>{zn(e,a()),n=!1}})])}function zn(i,{activeTooltipInfo:e,callbacks:t}){if(!e)return;t.onBeforeUpdate();const a=k(i);switch(a?.type){case"mesh":Ci(e,a.origin,i,t),"orientation"in e&&"scale"in e&&ba(e,a,t);break;case"point":Ci(e,a,i,t)}}function Ci(i,e,t,a){const{dx:n,dy:s,dz:o}=Vs(i,e);n===0&&s===0&&o===0||(a.onMoveStart(),t.operations?.move(n,s,o,0),a.onMove(n,s,o),a.onMoveStop())}function yo(i,e){const t=k(e),a=t?.type;if(!i||!t||a!=="mesh"&&a!=="point")return;const n=a==="mesh",s=n?t.origin:t;i.setLocationFromPoint(s),Mo(i,s,e),i.type==="transform-mesh"&&n&&fl(i,t),i.clearInputValues()}function Mo(i,e,t){i.elevation.actual=mr(e),i.elevation.visible=!!t.operations?.data.coordinateHelper.hasZ(),i.elevation.readOnly=!1,i.elevation.showAsZ=!0}function dh(i,e){if(i?.type!=="transform-point")return;if(!e)return i.orientation.actual=void 0,i.size.actual=void 0,i.orientation.visible=!1,void(i.size.visible=!1);const t=e.mode,{size:a,orientationClockwise:n}=e.adapter,{visualVariables:s}=i.sketchOptions.tooltips,o=s?.rotation,r=n!=null&&(t==null||t==="rotate"),l="geographic";i.orientation.actual=r?vr(n,"radians",l):void 0,i.orientation.precision=Cn(o?.valueType),i.orientation.visible=r;const c=s?.size,h=a!=null&&(t==null||t==="scale");i.size.actual=h?br(a,c?.unit??"meters"):void 0,i.size.precision=Cn(c?.valueType),i.size.visible=h}function Cn(i){switch(i){case"integer":case"long":return 0;default:return null}}function wo(i,e,t=Qt()){return Ot(i,Mi(e),t),te(t.direction,t.direction),t}function Ot(i,e,t){return ph(i,i.screenToRender(e,_a(b.get())),t)}function ph(i,e,t){if(e==null)return null;const a=_a(en(b.get(),e));if(a[2]=0,!i.unprojectFromRenderScreen(a,t.origin))return null;const n=_a(en(b.get(),e));n[2]=1;const s=i.unprojectFromRenderScreen(n,b.get());return s==null?null:($(t.direction,s,t.origin),t)}class ee{constructor(e){this.metadata=void 0,this._camera=new yr,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=new Array,this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=le(),this._worldFrame=null,this._renderLocation=M(),this._renderLocationDirty=!0,this._location=new me({x:0,y:0,z:0}),this._elevationAlignedLocation=new me,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.consumesClicks=!0,this.cursor=null,this.grabCursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=0,this._focused=!1,this.events=new ze,this._screenLocation={screenPointArray:Me(),renderScreenPointArray:fa(),pixelSize:0},this._screenLocationDirty=!0,this._engineResourcesAddedToStage=!1,this._attached=!1,this._location.spatialReference=e.view.spatialReference,Object.assign(this,e);const t=this.view.state?.camera;t&&this._camera.copyFrom(t)}destroy(){this._applyObjectTransform=vh,this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this._camera=null}get _stage(){return this.view?.stage}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}set available(e){e!==this._available&&(this._available=e,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,this._noDisplayCount===1&&this._updateEngineObject(),L(()=>{this._noDisplayCount--,this._noDisplayCount===0&&this._updateEngineObject()})}set radius(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}get radius(){return this._radius}set worldSized(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(e){Ln(e)&&(this._screenLocationDirty=!0),Ss(this._modelTransform,e),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=le()),gh(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(e){vn(e,this._location),this._notifyLocationChanged()}_notifyLocationChanged(){this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(e){vn(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){const e=this._elevation.override!=null?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y,this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=wc(this.location.spatialReference),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._updateEngineObject())}updateStateEnabled(e,t){t?this.state|=e:this.state&=~e}_setFocused(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:e===!0?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this._ensureScreenLocation(),this._screenLocation}_ensureScreenLocation(){if(!this._screenLocationDirty)return;this._screenLocation.pixelSize=this._camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1;let e;if(Ln(this._modelTransform)){const t=this._calculateModelTransformOffset(mh);e=P(t,t,this.renderLocation)}else e=this.renderLocation;this._camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this._camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}get attached(){return this._attached}intersectionDistance(e,t){if(!this.available)return null;const a=Mi(e,_h),n=this._getCollisionRadius(t),s=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(Ms(this.screenLocation.screenPointArray,a)<n*n)return this.screenLocation.renderScreenPointArray[2]+s;break;case"line":{const o=this.collisionType.paths,r=this._getWorldToScreenObjectScale(),l=this._calculateObjectTransform(r,oi),c=n*this.screenLocation.pixelSize,h=Ot(this._camera,a,Ki);if(h==null)return null;for(const p of o){if(p.length===0)continue;const g=wt(Wt,p[0],l);for(let _=1;_<p.length;_++){const f=wt(Gn,p[_],l),m=Sr(mi(g,f,kn),h);if(m!=null&&m<c*c){const y=P(b.get(),g,f);U(y,y,.5);const v=nn(b.get());if(this._camera.projectToRenderScreen(y,v))return v[2]+s}Z(g,f)}}break}case"disc":{const o=this.collisionType.direction,r=this.collisionType.offset??pa,l=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(l,oi),h=n*this.screenLocation.pixelSize,p=Ot(this._camera,a,Ki);if(p==null)return null;const g=tn(Hn,c),_=an(Fn,o,g),f=wt(Un,r,c);dt(f,_,ri);const m=Vn;if(jt(ri,p,m)&&Ds(m,f)<h*h)return this.screenLocation.renderScreenPointArray[2]+s;break}case"ribbon":{const{paths:o,direction:r}=this.collisionType,l=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(l,oi),h=n*this._camera.computeScreenPixelSizeAt(this.renderLocation),p=Ot(this._camera,a,Ki);if(p==null)return null;const g=tn(Hn,c),_=an(Fn,r,g),f=this._calculateModelTransformPosition(Un);dt(f,_,ri);const m=Vn;if(!jt(ri,p,m))break;for(const y of o){if(y.length===0)continue;const v=wt(Wt,y[0],c);for(let S=1;S<y.length;S++){const j=wt(Gn,y[S],c),T=xr(mi(v,j,kn),m);if(T!=null&&T<h*h){const D=P(b.get(),v,j);U(D,D,.5);const W=nn(b.get());if(this._camera.projectToRenderScreen(D,W))return W[2]+s}Z(v,j)}}break}default:Mr(this.collisionType)}return null}attach(e={manipulator3D:{}}){const t=this._stage;if(!t)return;const a=e.manipulator3D;a.engineLayerId==null?(this._engineLayer=new Zs(t,{pickable:!1,updatePolicy:1}),a.engineLayerId=this._engineLayer.id):t?.getLayer&&(this._engineLayer=t.getLayer(a.engineLayerId)),a.engineLayerReferences=(a.engineLayerReferences||0)+1,this._camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),Or(this._location.spatialReference,this.view.spatialReference)||(this.location=new me({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(e={manipulator3D:{}}){const t=e.manipulator3D;t.engineLayerReferences--;const a=t.engineLayerReferences===0;this._removeResourcesFromStage(),a&&(t.engineLayerId=null,C(this._engineLayer)),this._engineResources=null,this._engineLayer=null,this._attached=!1}onViewChange(){this._camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(e){wi(this.location,Zn,e.spatialReference)&&$r(e.extent,Zn)&&this._notifyLocationChanged()}_evaluateElevationAlignment(){if(this.elevationInfo==null)return;let e=null,t=0;const a=Dr(this.elevationInfo,this.location.spatialReference??this.view.elevationProvider.spatialReference);switch(this.elevationInfo.mode){case"on-the-ground":e=Xi(this.view.elevationProvider,this.location,"ground")??0;break;case"relative-to-ground":t=(Xi(this.view.elevationProvider,this.location,"ground")??0)+a;break;case"relative-to-scene":t=(Xi(this.view.elevationProvider,this.location,"scene")??0)+a;break;case"absolute-height":t=a}return t!==this._elevation.offset||e!==this._elevation.override?(this._elevation.offset=t,void(this._elevation.override=e)):void 0}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const e=this._getWorldToScreenObjectScale(),t=oi;if(this.autoScaleRenderObjects===!0){const o=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(o,t)}else this._calculateObjectTransform(e,t);const{objectsByState:a}=this._ensureEngineResources(),n=(this.focused?2:1)|(this.selected?8:4),s=this._noDisplayCount>0;for(const{stateMask:o,objects:r}of a){if(s){for(const h of r)h.visible=!1;continue}const l=!(15&o)||(n&o)===(15&o),c=!(65520&o)||(this.state&o)===(65520&o);if(l&&c)for(const h of r)h.visible=!0,h.transformation=t;else for(const h of r)h.visible=!1}}_ensureEngineResources(){if(this._engineResources==null){const e=this._engineLayer,t=[],a=new Set;this.renderObjects.forEach(({geometry:{material:o}})=>{a.has(o)||(t.push(o),a.add(o))});const n=new Map;this._renderObjects.forEach(o=>{const r=new Bs({castShadow:!1,geometries:[o.geometry]}),l=n.get(o.stateMask)||[];l.push(r),n.set(o.stateMask,l)});const s=[];n.forEach((o,r)=>s.push({stateMask:r,objects:o})),this._engineResources={objectsByState:s,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){const e=this._stage;if(this._engineResourcesAddedToStage||this._engineResources==null||!e)return;const{objectsByState:t,layer:a}=this._engineResources;t.forEach(({objects:n})=>a.addMany(n)),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(){const e=this._stage;if(!this._engineResourcesAddedToStage||this._engineResources==null||!e)return;const{objectsByState:t,layer:a}=this._engineResources;t.forEach(({objects:n})=>a.removeMany(n)),this._engineResourcesAddedToStage=!1}_getCollisionRadius(e){return this._getFocusedSize(this.radius,!0)*(e==="touch"?this.touchMultiplier:1)}_getFocusedSize(e,t){return e*(t?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(e){const t=this._getWorldToScreenObjectScale(),a=this._calculateObjectTransform(t,fh);return B(e,a[12],a[13],a[14])}_calculateModelTransformOffset(e){const t=this._calculateModelTransformPosition(e);return $(e,t,this.renderLocation)}_calculateObjectTransform(e,t){return Er(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&Re(t,t,this._worldFrame),Re(t,t,this._modelTransform),t[12]+=this.renderLocation[0],t[13]+=this.renderLocation[1],t[14]+=this.renderLocation[2],t[15]=1,this._applyObjectTransform!=null&&this._applyObjectTransform(t),t}get test(){}}function Ln(i){return i[12]!==0||i[13]!==0||i[14]!==0}function gh(i,e,t){switch(i.viewingMode){case"local":return ma(t),!0;case"global":{const a=jr(i.renderCoordsHelper.spatialReference);return Tr(e,0,Wt,0,a.radius),Ir(Qe(Wt[0]),Qe(Wt[1]),t),!0}}}const _h=Me(),kn=xs(),Ki=Qt(),Hn=wr(),fh=le(),oi=le(),ri=Kt(),Wt=M(),Gn=M(),Vn=M(),Fn=M(),Un=M(),mh=M(),Zn=new me({x:0,y:0,z:0,spatialReference:null}),vh=()=>{};let xo=class{constructor(){this.grabbingState=0,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=0,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator((t,a)=>{if(a===0&&(this.zManipulator=t),t instanceof ee&&(t.selected&&(this.numSelected===0&&(this.firstSelected=t),this.numSelected++),this.firstGrabbedXY==null&&t.grabbing&&a===1&&(this.firstGrabbedXY=t)),t.grabbing)switch(this.grabbingState|=1,a){case 0:this.grabbingState|=2;break;case 1:this.grabbingState|=4}})}};function bh(i){const{object:e}=i,t=yh(i),a=[t,Mh(i,t.visualElement)];return e.maskOccludee&&a.push(e.maskOccludee()),{visualElement:t.visualElement,remove:()=>Ia(a)}}function yh(i){const{view:e,object:t}=i,a=k(t),n=new pt({view:e,geometry:Oa(a)?a:null,elevationInfo:t.elevationInfo,attached:!1,isDecoration:!0}),s=new _t({getTheme:()=>e.effectiveTheme}),o=()=>{n.attached=t.visible},r=F([w(()=>s.visualElements.lineObjects.outline,l=>l.apply(n),A),w(()=>s.visualElements.lineObjects.shadowStyle,l=>l.apply(n),A),w(()=>t.visible,o),w(()=>t.isDraped,l=>{n.isDraped=l},A),t.on("committed",()=>{const l=k(t);n.geometry=Oa(l)?l:null}),re(n)]);return o(),{visualElement:n,remove:()=>r.remove()}}function Mh(i,e){const{object:t,view:a}=i,n=[],s=t.elevationInfo,o=s.mode==="on-the-ground"||!s.offset&&s.mode!=="absolute-height",r=new xo,l=new _t({getTheme:()=>a.effectiveTheme}),c=l.visualElements,h=new Ui({view:a,extensionType:c.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4,isDecoration:!0}),p=Qe(c.heightPlaneAngleCutoff),g=new Ei({view:a,attached:!1,angleCutoff:p,isDecoration:!0}),_=xi(1);n.push(w(()=>({lineShadowStyle:l.visualElements.lineObjects.shadowStyle,pointShadowStyle:l.visualElements.pointObjects.shadowStyle,alpha:_.value}),({lineShadowStyle:S,pointShadowStyle:j,alpha:T})=>{S.apply(e,T),j.apply(h,T)},A));const f=xi(1);n.push(w(()=>({heightPlane:l.visualElements.heightPlane,alpha:f.value}),({heightPlane:S,alpha:j})=>S.apply(g,j),A));const m=()=>{r.update(i);const S=k(t);if(!t.visible||o&&(t.isDraped||!Oa(S)||!S.hasZ))return e.laserlineEnabled=!1,h.attached=!1,void(g.attached=!1);e.laserlineEnabled=!0;const j=4&r.grabbingState?c.laserlineAlphaMultiplier:1;_.value=j;const T=2&r.grabbingState?c.laserlineAlphaMultiplier:1;f.value=T,wh(h,r),xh(i,e,g,r)};n.push(w(()=>l.visualElements.zVerticalLine,S=>S.apply(h),A)),n.push(t.on("committed",m),w(()=>t.visible,m),e.events.on("attachment-origin-changed",m),re(h),re(g));const y=[],v=()=>{Ia(y),y.length=0,i.forEachManipulator(S=>y.push(S.events.on("grab-changed",m))),i.forEachManipulator(S=>y.push(S.events.on("select-changed",m))),m()};return v(),n.push(i.onManipulatorsChanged(v),Es(()=>F(y))),F(n)}function wh(i,e){const t=e.numSelected===1?e.firstSelected:e.numSelected>1&&e.firstGrabbedXY!=null?e.firstGrabbedXY:null;t!=null?(i.setStartEndFromWorldDownAtLocation(t.renderLocation),i.attached=!0):i.attached=!1}function xh(i,e,t,a){if(a.numSelected>0){B(st,0,0,0);let n=0;i.forEachManipulator((s,o)=>{o===1&&s.selected&&s instanceof ee&&(P(st,st,s.renderLocation),n++)}),n>0?(t.heightManifoldTarget=U(st,st,1/n),t.attached=!0):t.attached=!1}else{const n=e.attachmentOrigin;n!=null&&i.view.renderCoordsHelper.toRenderCoords(n,st)?(t.heightManifoldTarget=st,t.attached=!0):t.attached=!1}}function Oa(i){return i!=null&&(i.type==="polygon"||i.type==="polyline")}const st=M();function Sh(i){const e=[],t=$h(i,e);return Oh(i,e,t),{visualElement:t,remove:()=>Ia(e)}}function Oh(i,e,t){const{view:a,object:n}=i,s=new _t({getTheme:()=>a.effectiveTheme}),o=new Ui({view:a,extensionType:s.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4,isDecoration:!0});e.push(w(()=>s.visualElements.zVerticalLine,v=>v.apply(o),A));const r=new Ei({view:a,intersectsLineInfinite:!0,attached:!1,isDecoration:!0}),l=Qe(s.visualElements.heightPlaneAngleCutoff),c=new Ei({view:a,attached:!1,angleCutoff:l,isDecoration:!0}),h=n.elevationInfo,p=ti.fromElevationInfo(h),g=h.mode==="on-the-ground"||!h.offset&&h.mode!=="absolute-height",_=new xo,f=xi(1);e.push(w(()=>({heightPlane:s.visualElements.heightPlane,alpha:f.value}),({heightPlane:v,alpha:S})=>v.apply(c,S),A));const m=xi(1);e.push(w(()=>({shadowStyle:s.visualElements.pointObjects.shadowStyle,alpha:m.value}),({shadowStyle:v,alpha:S})=>v.apply(r,S),A));const y=()=>{_.update(i);let v=Za(k(n));const S=g&&(n.isDraped||v==null||!v.hasZ);let j=!0;if(S||v==null)j=!1;else{js(n.elevationInfo)&&(v=v.clone(),v.z=0);const V=Gi(v,a.elevationProvider,p,a.renderCoordsHelper);B(ge,v.x,v.y,V),Je(ge,v.spatialReference,ge,a.renderCoordsHelper.spatialReference),o.setStartEndFromWorldDownAtLocation(ge),r.intersectsWorldUpAtLocation=ge}const T=2&_.grabbingState?s.visualElements.laserlineAlphaMultiplier:1;f.value=T;const D=Rr(Th);!S&&n.visible&&t.calculateMapBounds(D)&&Je(Ar(D,ge),a.spatialReference,ge,a.renderCoordsHelper.spatialReference)?(c.heightManifoldTarget=ge,c.attached=!0):c.attached=!1;const W=4&_.grabbingState?s.visualElements.laserlineAlphaMultiplier:1;m.value=W;const O=j&&n.visible&&!S;r.attached=O,o.attached=O};e.push(w(()=>[n.visible,n.isDraped],y),n.on("committed",y)),i.forEachManipulator(v=>{e.push(v.events.on("grab-changed",y))}),e.push(re(r)),e.push(re(o)),e.push(re(c)),y()}function $h(i,e){const{view:t,object:a}=i,n=new xa({view:t,geometry:Za(k(a)),elevationInfo:a.elevationInfo,isDecoration:!0});return Dh(i,n,e),e.push(re(n)),n}function Za(i){return i==null?null:i.type==="point"?i:i.type==="mesh"?i.origin.clone():null}function Dh(i,e,t){const{view:a,object:n}=i,s=()=>{e.attached=n.visible},o=new _t({getTheme:()=>a.effectiveTheme});Eh(i,e,t),o.visualElements.pointObjects.outline.apply(e),t.push(w(()=>n.visible,s,A))}function Eh(i,e,t){const{view:a,object:n}=i;let s=null;const o=l=>{s!=null&&(s.remove(),s=null),n.isDraped&&l!=null&&(s=jh(a,l,()=>{e.geometry=l}))},r=()=>{const l=Za(k(n));l!=null&&js(n.elevationInfo)&&(l.z=0),o(l),e.geometry=l};t.push(n.on("committed",r),Es(()=>s)),r()}function jh(i,e,t){const a=i.elevationProvider.spatialReference;zr(e,ge,a);const n=ge[0],s=ge[1];return i.elevationProvider.on("elevation-change",o=>{Ts(o.extent,n,s)&&t()})}const ge=M(),Th=Pr();function Zi(i){switch(k(i.object)?.type){case"point":case"mesh":return Sh(i);case"polygon":case"polyline":return bh(i);default:return null}}const So=128,Oe=70,Ih=80,Oo=.02,Rh=54,Ah=100,$o=Math.ceil(Oe/3*2),lt=160,ea=.5,ta=24,bt=9,Ph=lt+30,Bn=lt+53,zh=60,Ch=23,Lh=5*Math.PI/12,kh=1*Math.PI/3,Nn=10,Wn=.2,Yn=30,qn=53,Hh=.2,Gh=.3,Vh=200,Fh=3,Uh=1e6;let ii=class{constructor(){this._available=!0}set location(e){this._forEachManipulator3D(t=>t.location=e)}set elevationAlignedLocation(e){this._forEachManipulator3D(t=>t.elevationAlignedLocation=e)}set elevationInfo(e){this._forEachManipulator3D(t=>t.elevationInfo=e)}get renderLocation(){let e;return this._forEachManipulator3D(t=>{e||(e=t.renderLocation)}),e}set renderLocation(e){this._forEachManipulator3D(t=>t.renderLocation=e)}get available(){return this._available}set available(e){this._available=e,this._forEachManipulator3D(t=>t.available=e)}get hovering(){return this.someManipulator(e=>e.hovering)}get grabbing(){return this.someManipulator(e=>e.grabbing)}get dragging(){return this.someManipulator(e=>e.dragging)}get selected(){return this.someManipulator(e=>e.selected)}hasManipulator(e){return this.someManipulator(t=>t===e)}someManipulator(e){let t=!1;return this.forEachManipulator(a=>{!t&&e(a)&&(t=!0)}),t}_forEachManipulator3D(e){this.forEachManipulator((t,a)=>{t instanceof ee&&e(t,a)})}},Zh=class extends ii{constructor(){super(...arguments),this._interactive=!0}get interactive(){return this._interactive}set interactive(e){this._interactive!==e&&(this._interactive=e),this._updateManipulatorInteractivity()}_updateManipulatorInteractivity(){const e=!this.grabbing&&this._interactive;this.forEachManipulator(t=>{t.interactive=e||t.grabbing})}},x=class{constructor(e,t=0){this.geometry=e,this.stateMask=t}};function Bi(i,e){return Do(i,()=>e)}function Bh(i){return Do(i,e=>e.plane)}function Do(i,e){const t=M(),a=M();let n=!1;return s=>{const o=e(s);if(s.action==="start"){const c=Mi(s.screenStart,vi(sn.get())),h=Ot(i.state.camera,c,Xn);h!=null&&(n=jt(o,h,t))}if(!n)return null;const r=Mi(s.screenEnd,vi(sn.get())),l=Ot(i.state.camera,r,Xn);return l==null?null:jt(o,l,a)?{...s,renderStart:t,renderEnd:a,plane:o,ray:l}:null}}function Nh(i,e,t=0,a=null,n=null){let s=null;return o=>{if(o.action==="start"&&(s=i.sceneIntersectionHelper.intersectElevationFromScreen(Me(o.screenStart.x,o.screenStart.y),e,t,n),s!=null&&a!=null&&!wi(s,s,a))||s==null)return null;const r=i.sceneIntersectionHelper.intersectElevationFromScreen(Me(o.screenEnd.x,o.screenEnd.y),e,t,n);return r!=null&&(a==null||wi(r,r,a))?{...o,mapStart:s,mapEnd:r}:null}}function Jt(i,e,t,a=null,n=null){return Nh(i,t,Ra(e,i,t),a,n)}function Wh(i,e,t,a){const n=t.toMap(i.screenStart);return n!=null?Jt(e,n,t.elevationInfo,a):null}function Yh(i,e){const t=Xh,a=Jh,n=Kt();i.renderCoordsHelper.worldUpAtPosition(e,t);const s=de(gt(n),t,$(a,e,i.state.camera.eye));return de(s,s,t),dt(e,s,n)}function Eo(i,e,t){let a=null;const n=new Vi;return n.next(Bi(i,Yh(i,e))).next(qh(i,e)).next(jo(i,t)).next(s=>{s.mapEnd.x=s.mapStart.x,s.mapEnd.y=s.mapStart.y,a=s}),s=>(a=null,n.execute(s),a)}function qh(i,e){const t=M(),a=$e(e);i.renderCoordsHelper.worldUpAtPosition(e,t);const n=M(),s=M(),o=r=>($(r,r,e),Cr(t,r,r),i.viewingMode==="global"&&$e(r)*Math.sign(he(t,r))<.001-a&&$(r,U(r,t,.001),e),P(r,r,e),r);return r=>(r.renderStart=o(Z(n,r.renderStart)),r.renderEnd=o(Z(s,r.renderEnd)),r)}function jo(i,e){const t=i.renderCoordsHelper;return a=>{const n=t.fromRenderCoords(a.renderStart,new me({spatialReference:e})),s=t.fromRenderCoords(a.renderEnd,new me({spatialReference:e}));return n!=null&&s!=null?{...a,mapStart:n,mapEnd:s}:null}}const Xh=M(),Jh=M(),Xn=Qt();function Ni(i,e,t){const a=(n,s)=>{e({action:n,object:i,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY})};return t((n,s,o)=>(s.next(r=>(r.action==="start"&&a("start",r),r)).next(pc(i)).next(r=>{switch(r.action){case"start":case"update":(r.translationX||r.translationY||r.translationZ)&&a("update",r);break;case"end":a("end",r)}return r}),{steps:s,cancel:o=o.next(gc(i)).next(r=>(a("end",{screenDeltaX:0,screenDeltaY:0}),r))}))}function To(i){if(i?.axis==null)return 1;const{mapStart:e,mapEnd:t,axis:a}=i,n=[t.x-e.x,t.y-e.y];return n[0]*a[0]+n[1]*a[1]>0?1:-1}let Qh=class extends ii{constructor(e){super(),this._handles=new Li,this._arrowManipulatorInfos=new Array,this._angle=0,this._scale=1,this._radius=Oe,this._updateAfterDrag=!1,this.events=new ze,this._tool=e.tool,this._view=e.view,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),e.radius!=null&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator(t=>this._tool.manipulators.add(t))}set orthogonalAvailable(e){this._arrowManipulatorInfos.length>=3&&(this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e)}destroy(){this._handles=C(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){for(const{manipulator:t}of this._arrowManipulatorInfos)e(t,1)}createManipulatedObjectDragPipeline(e,t,a){if(!t.operations)return L();const n=t.operations.data.spatialReference,s=t.graphic;return Ni(t,a,o=>this.createDragPipeline((r,l,c,h,p)=>({steps:l,cancel:c}=e(r,l,c,h,p),o(r,l,c)),t.elevationInfo,n,s))}createDragPipeline(e,t,a,n){return F(this._arrowManipulatorInfos.map(({manipulator:s},o)=>ye(s,(r,l,c,h,p)=>{const g=l.next(_=>({..._,manipulatorType:1})).next(Bt(this._view,r.elevationAlignedLocation)).next(Jt(this._view,r.elevationAlignedLocation,t,a,n)).next(_c(r.location,this.angle+(o+1)*Math.PI*.5)).next(Rt());e(r,g,c,h,p)})))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:e,transform:t},a){const n=this._radius/Oe,s=Rh*n,o=s*Math.sqrt(3)/2,r=Ti(this._opaqueMaterial,o,s/2,s/2,Oo);Fs(r,yi(q.get(),B(b.get(),0,-o/3,0))),e.renderObjects=[new x(r,2),new x(r.instantiate({material:this._transparentMaterial}),1)],e.radius=o/3*2*1.2;const l=Is(q.get(),a*Math.PI/2),c=yi(q.get(),B(b.get(),0,Ah*n,0));Re(t,l,c)}_createManipulators(){for(let e=0;e<4;e++){const t=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(t)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const e=this.angle,t=Rs(q.get(),e,R(0,0,1));if(t==null)return;const a=Si(q.get(),B(b.get(),this.displayScale,this.displayScale,this.displayScale)),n=Re(q.get(),a,t);for(const s of this._arrowManipulatorInfos){const o=Re(q.get(),n,s.transform);s.manipulator.modelTransform=o}}_createArrowManipulator(e){const t=new ee({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:R(0,0,1)}}),a={manipulator:t,transform:le()};return this._updateArrowManipulator(a,e),this._handles.add(t.events.on("drag",n=>{this._updateAfterDrag&&n.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),a}_createMaterial(e=1){const t=new fe({cullFace:2,renderOccluded:2,isDecoration:!0});return this._handles.add(w(()=>J.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>{a[3]*=e,t.setParameters({color:a})},A)),t}get test(){}},Kh=class{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&this._lastDragEvent!=null&&this._next!=null){const t=this._lastDragEvent.mapEnd,a=this._snap(this._lastDragEvent.screenEnd);if(a!=null){const n={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:e===!0?a:t,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this._next.execute(n)}}this._enabled=e}_snap(e){const t=this._view!=null?this._view.toMap(e,{exclude:[]}):null;return t!=null&&this._view!=null&&(t.z=Ra(t,this._view,this._elevationInfo)),t}createDragEventPipelineStep(e,t){this._view=e,this._elevationInfo=t,this._lastDragEvent=null;const a=new Vi;return this._next=a,[n=>{if(this._lastDragEvent=n.action!=="end"?{...n}:null,this._enabled){const s=this._snap(n.screenEnd);return s!=null?{action:n.action,mapStart:n.mapStart,mapEnd:s,screenStart:n.screenStart,screenEnd:n.screenEnd}:null}return{action:n.action,mapStart:n.mapStart,mapEnd:n.mapEnd,screenStart:n.screenStart,screenEnd:n.screenEnd}},a]}},eu=class extends ii{constructor(e){super(),this._handles=new Li,this._snapToScene=new Kh,this._scale=1,this._radius=Oe,this._view=e.view,this._tool=e.tool,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),e.snapToScene!=null&&(this.snapToScene=e.snapToScene),e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(t=>this._tool.manipulators.add(t))}destroy(){this._handles=C(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,1)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}get discManipulator(){return this._manipulator}createManipulatedObjectDragPipeline(e,t,a){if(!t.operations)return L();const n=t.graphic,s=t.elevationInfo,o=t.operations.data.spatialReference;return Ni(t,a,r=>this.createDragPipeline((l,c,h,p,g)=>({steps:c,cancel:h}=e(l,c,h,p,g),r(l,c,h)),s,o,n))}createDragPipeline(e,t,a,n){const s=this._view;return ye(this._manipulator,(o,r,l,c,h)=>{const p=r.next(Bt(s,o.elevationAlignedLocation)).next(Jt(s,o.elevationAlignedLocation,t,a,n)).next(...this._snapToScene.createDragEventPipelineStep(s,t)).next(g=>({...g,manipulatorType:1})).next(Rt());e(o,p,l,c,h)})}_updateManipulatorTransform(){const e=Si(q.get(),B(b.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new ee({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:R(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=yl(this._discMaterial,Oo,1,So,R(0,0,1),R(0,0,0));e.transformation=Si(le(),R(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new x(e,2),new x(e.instantiate({material:this._discMaterialTransparent}),1)],this._manipulator.radius=Ih*(this._radius/Oe)}_createMaterial(e=1){const t=new fe({cullFace:2,renderOccluded:2,isDecoration:!0});return this._handles.add(w(()=>J.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>{a[3]*=e,t.setParameters({color:a})},A)),t}get test(){}};function Ie(i,e=4,t=!0){const a=Hs(i),n=!(i[3]<1);return t?new Sa({color:a,writeDepth:n,cullFace:2,renderOccluded:e,isDecoration:!0}):new fe({color:a,writeDepth:n,cullFace:2,renderOccluded:e,isDecoration:!0})}function Ct(i,e=4){const t=Hs(i);return new fe({color:t,writeDepth:!0,cullFace:1,renderOccluded:e,isDecoration:!0})}const Io=Object.freeze({calloutLength:40,calloutWidth:1,discRadius:27,focusMultiplier:1.1}),tu=Object.freeze({autoScaleRenderObjects:!1,worldSized:!0});function Ro(i,e,t,a){const n=$(b.get(),i,t),s=Ao(n,de(b.get(),a,n),t,q.get());Lr(s,s);const o=wt(b.get(),e,s);return Math.atan2(o[1],o[0])}function Ao(i,e,t,a){const n=te(b.get(),i),s=te(b.get(),e),o=de(b.get(),n,s);return a[0]=n[0],a[1]=n[1],a[2]=n[2],a[3]=0,a[4]=s[0],a[5]=s[1],a[6]=s[2],a[7]=0,a[8]=o[0],a[9]=o[1],a[10]=o[2],a[11]=0,a[12]=t[0],a[13]=t[1],a[14]=t[2],a[15]=1,a}function iu(i,e){const t=i.getViewForGraphic(e);return t!=null&&"computeAttachmentOrigin"in t?t.computeAttachmentOrigin(e,i.spatialReference):null}function Po(i,e){const t=e.origin;t==null?au(i,k(e)):i.elevationAlignedLocation=t}function au(i,e){if(e==null)return;const t=e.type==="mesh"?e.origin:Ml(e);t!=null&&(i.location=xc(t))}class nu extends ii{constructor(e){super(),this._radius=Oe,this.events=new ze,this._tool=e.tool,this._view=e.view;const t=new _t({getTheme:()=>this._view.effectiveTheme});this._settings=t,e.radius!=null&&(this._radius=e.radius);const a=this._view.effectiveTheme.accentColor;this._materials={materialUnfocused:Ie(Ve(a,1,.25),1),materialFocused:Ie(Ve(a,1,0),1),materialOccludedUnfocused:Ie(Ve(a,.7,0),t.zManipulator.renderOccluded),materialOccludedFocused:Ie(Ve(a,.85,0),t.zManipulator.renderOccluded)},this._themeHandle=w(()=>this._view.effectiveTheme.accentColor,n=>{const s=Ve(n,1,.25),o=Ve(n,1,0),r=Ve(n,.7,0),l=Ve(n,.85,0),{materialUnfocused:c,materialFocused:h,materialOccludedUnfocused:p,materialOccludedFocused:g}=this._materials;c.setParameters({color:s}),h.setParameters({color:o}),p.setParameters({color:r}),g.setParameters({color:l})}),this._createManipulator(),this.forEachManipulator(n=>this._tool.manipulators.add(n))}destroy(){this._themeHandle=De(this._themeHandle),this._manipulator.applyObjectTransform=ou,this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()})}forEachManipulator(e){e(this._manipulator,0)}createManipulatedObjectDragPipeline(e,t,a){if(!t.operations)return L();const n=t.operations.data.spatialReference;return Ni(t,a,s=>this.createDragPipeline((o,r,l,c,h)=>({steps:r,cancel:l}=e(o,r,l,c,h),s(o,r,l)),n))}createDragPipeline(e,t){const a=this._view;return ye(this._manipulator,(n,s,o,r,l)=>{const c=s.next(h=>({...h,manipulatorType:0})).next(Eo(a,n.renderLocation,t)).next(Rt());e(n,c,o,r,l)})}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}_updateManipulator(){const e=this._settings,t=this._radius/Oe,a=e.zManipulator.height*t,n=e.zManipulator.coneHeight*t,s=e.zManipulator.coneWidth*t,o=e.zManipulator.width*t,r=[R(0,0,0),R(0,0,a)],l=[R(0,0,0),R(0,0,a+n)],c=(()=>{const y=le();return va(y,y,[0,0,a]),As(y,y,Math.PI/2),y})(),{materialUnfocused:h,materialFocused:p,materialOccludedUnfocused:g,materialOccludedFocused:_}=this._materials,f=wl(h,r,o/2,16,!1),m=ya(h,n,s/2,16,!1);m.transformation=c,this._manipulator.renderObjects=[new x(m,1),new x(f,1),new x(m.instantiate({material:p}),2),new x(f.instantiate({material:p}),2),new x(m.instantiate({material:g}),1),new x(f.instantiate({material:g}),1),new x(m.instantiate({material:_}),2),new x(f.instantiate({material:_}),2)],this._manipulator.radius=o/2+2,this._manipulator.collisionType={type:"line",paths:[l]}}_createManipulator(){const e=this._view,t=new ee({view:e,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});t.applyObjectTransform=a=>{const n=e.state.camera,s=Jn;e.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,s);const o=kr(n.eye,s),r=n.computeRenderPixelSizeAtDist(o),l=$(yt,s,n.eye);te(l,l);const c=su;e.renderCoordsHelper.worldUpAtPosition(Jn,c);const h=Math.abs(he(l,c)),p=de(yt,l,c),g=de(yt,p,c),_=bi(h,.01,1),f=1-Math.sqrt(1-_*_)/_/n.fullWidth,m=this._settings,y=this._radius/Oe,v=m.zManipulator.width*y;U(g,te(g,g),(1/f-1)*o+r*v),a[12]-=yt[0],a[13]-=yt[1],a[14]-=yt[2]},this._manipulator=t,this._updateManipulator()}get test(){}}function Ve(i,e,t){const a=pl(i,t);return a.a*=e,J.toUnitRGBA(a)}const Jn=M(),yt=M(),su=M(),ou=()=>{};let ut=class extends Zh{constructor(e){super(),this._handles=new Li;const{tool:t,view:a,snapToScene:n,radius:s}=e;this._view=a,this.xyManipulation=new eu({tool:t,view:a,snapToScene:n,radius:s}),this.xyAxisManipulation=new Qh({tool:t,view:a,radius:s}),this.zManipulation=new nu({tool:t,view:a,radius:s}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(o=>this._handles.add(o.events.on("grab-changed",()=>this._updateManipulatorInteractivity())))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createManipulatedObjectDragPipeline(e,t,a){return F([this.xyManipulation.createManipulatedObjectDragPipeline((n,s,o,r,l)=>e(0,n,s,o,r,l),t,a),this.xyAxisManipulation.createManipulatedObjectDragPipeline((n,s,o,r,l)=>e(1,n,s,o,r,l),t,a),this.zManipulation.createManipulatedObjectDragPipeline((n,s,o,r,l)=>e(2,n,s,o,r,l),t,a)])}createDragPipeline(e,t,a,n){return F([this.xyManipulation.createDragPipeline((s,o,r,l,c)=>e(0,s,o,r,l,c),t,a,n),this.xyAxisManipulation.createDragPipeline((s,o,r,l,c)=>e(1,s,o,r,l,c),t,a,n),this.zManipulation.createDragPipeline((s,o,r,l,c)=>e(2,s,o,r,l,c),a)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this.xyAxisManipulation.angle=e}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator(t=>e(t,1)),this.xyAxisManipulation.forEachManipulator(t=>e(t,1)),this.zManipulation.forEachManipulator(t=>e(t,0))}get _xyAxisVisible(){const e=this.xyManipulation.someManipulator(t=>t.focused)||this.xyAxisManipulation.someManipulator(t=>t.focused);return this._view.inputManager&&this._view.inputManager.latestPointerInfo?.type==="touch"||e}_autoHideXYAxis(){const e=this.xyAxisManipulation,t=this.xyManipulation;if(Ps("esri-mobile"))return;const a=[];t.forEachManipulator(s=>a.push(s)),e.forEachManipulator(s=>a.push(s));const n=()=>{const s=[];this._xyAxisVisible||e.forEachManipulator(o=>s.push(o.disableDisplay())),this._handles.remove(Qn),this._handles.add(s,Qn)};for(const s of a)this._handles.add(s.events.on("focus-changed",n));this._view.inputManager&&this._handles.add(Dt(()=>this._view.inputManager?.latestPointerInfo?.type,n)),n()}static radiusForSymbol(e){const t=e!=null&&e.type==="point-3d"&&e.symbolLayers;return t&&t.some(a=>a.type==="icon")?$o:Oe}};const Qn="disable-xy-axis-display";let Ba=class extends ii{constructor(e){super(),this._view=e.view,this._tool=e.tool,this._object=e.object,this._manipulator=this._object.createManipulator?.({selectable:!0,cursor:"move"}),this.forEachManipulator(t=>this._tool.manipulators.add(t))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){this._manipulator&&e(this._manipulator,1)}createManipulatedObjectDragPipeline(e){return Ni(this._object,e,t=>this.createDragPipeline(t))}createDragPipeline(e){if(!this._manipulator)return L();const t=this._view;return ye(this._manipulator,(a,n,s,o,r)=>{const l=this._object.operations?.data.spatialReference,c=n.next(h=>l?h:null).next(Wh(r,t,this._object,l)).next(xt()).next(Rt());e(a,c,s,o,r)})}},St=class extends ei{constructor(e){super(e),this.type="translate-xy",this.distance=we}};u([d()],St.prototype,"type",void 0),u([d()],St.prototype,"distance",void 0),St=u([H("esri.views.interactive.tooltip.infos.TranslateXYTooltipInfo")],St);let ct=class extends ei{constructor(e){super(e),this.type="translate-z",this.distance=we}clear(){this.distance=we}};u([d()],ct.prototype,"type",void 0),u([d()],ct.prototype,"distance",void 0),ct=u([H("esri.views.interactive.tooltip.infos.TranslateZTooltipInfo")],ct);class Kn{constructor(e){this.objects=e,this.type="move-start"}}class es{constructor(e,t,a){this.dx=e,this.dy=t,this.objects=a,this.type="move"}}let ia=class{constructor(e){this.objects=e,this.type="move-stop"}};const Se=Symbol("manipulators"),ts=Symbol("tooltips");let ie=class extends Fi{constructor(i){super(i),this._infos=new Map,this.events=new ze,this.objects=new Hr,this.enableZ=!0,this.sketchOptions=new tt,this.type="move-3d",this._latestTooltipInfo=null,this._translateTooltipInfo=null,this._translateXYTooltipInfo=null,this._translateZTooltipInfo=null,this._updatingHandles=new ki,this._moveManipulation=null}initialize(){const{view:i}=this;this.tooltip=Hi(()=>({view:i,options:this.sketchOptions.tooltips})),this.addHandles([this.objects.on("change",t=>{t.removed.forEach(a=>this.removeHandles(a)),this._updateObjectInfos(t),this._setupFastTransformUpdates(t.added),this._refreshManipulators()}),this.objects.on("change",()=>this._connectTooltips())]);const e=this.objects.toArray();this._updateObjectInfos({added:e,removed:[]}),this._setupFastTransformUpdates(e),this._refreshManipulators(),this._connectTooltips(),this.finishToolCreation()}destroy(){this.tooltip=C(this.tooltip),this._moveManipulation=C(this._moveManipulation),this._set("view",null),this._updatingHandles.destroy()}onInputEvent(i){if(!this.destroyed&&!Di(i,this.tooltip))return super.onInputEvent(i)}get updating(){return this._updatingHandles.updating}get _shouldShowMovePointTooltip(){const{objects:i}=this;if(i.length!==1)return!1;const e=k(i.at(0))?.type;return e==="point"||e==="mesh"}get activeTooltipInfo(){return this._shouldShowMovePointTooltip?this._movePointTooltipInfo:this._latestTooltipInfo}reset(){}_updateObjectInfos({added:i,removed:e}){for(const t of i){if(Gr(t)!==0)continue;const a=new ru(t);this._infos.set(t,a)}for(const t of e)this._infos.delete(t)}_setupFastTransformUpdates(i){for(const e of i){const t=this._infos.get(e);this.addHandles(Fa(t.object),e)}}_refreshManipulators(){if(this.removeHandles(Se),this._moveManipulation=C(this._moveManipulation),this.manipulators.removeAll(),this._infos.size===0)return;const i=Array.from(this._infos.values());this._createManipulators(i),this._createVisualElements(i),this._updateMoveManipulation(i)}_createManipulators(i){for(const e of i){const t=e.object;e.manipulationXY=new Ba({tool:this,view:this.view,object:t}),e.manipulationXY.forEachManipulator(a=>{this.addHandles([a.events.on("immediate-click",n=>{this.events.emit("immediate-click",{...n,object:t}),n.stopPropagation()}),a.events.on("grab-changed",({action:n})=>{n==="start"?this._showTooltip(0):this._hideTooltip()})],Se)}),this.addHandles(e.manipulationXY.createDragPipeline((a,n,s,o)=>this._buildDragEventPipeline(i,0,a,n,s,o)),Se)}this._createMoveManipulation(i)}_createMoveManipulation(i){const e=new ut({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:i.length===1?ut.radiusForSymbol(i[0].object.graphic?.symbol):Oe});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator(r=>{this.addHandles(r.events.on("immediate-click",l=>{const c=this.objects.at(0);!e.zManipulation.hasManipulator(r)&&this.objects.length===1&&c&&this.events.emit("immediate-click",{...l,object:c}),l.stopPropagation()}),Se)});const t=r=>l=>{this.addHandles([l.events.on("focus-changed",({action:c})=>{c==="focus"?this._showTooltip(r):this._hideTooltip()}),l.events.on("grab-changed",()=>{this._latestTooltipInfo&&(this._latestTooltipInfo.distance=we)})],Se)};this._moveManipulation.xyManipulation.forEachManipulator(t(0)),this._moveManipulation.xyAxisManipulation.forEachManipulator(t(1)),this._moveManipulation.zManipulation.forEachManipulator(t(2));const a=()=>this._updateMoveManipulation(i);for(const r of i)this.addHandles([r.object.on("committed",a),w(()=>r.object.visible,a)],Se);const n=i[i.length-1];this.addHandles(n.object.on("committed",()=>this._updateMoveManipulationAngle(n)),Se);const{object:s}=n,{operations:o}=s;if(o){const r=s.graphic;this.addHandles(e.createDragPipeline((l,c,h,p,g)=>this._buildDragEventPipeline(i,l,c,h,p,g),s.elevationInfo,o.data.spatialReference,r),Se)}this._updateMoveManipulationAngle(n)}_createVisualElements(i){for(const e of i){const t=e.object,a=Zi({view:this.view,object:t,forEachManipulator:n=>{e.manipulationXY?.forEachManipulator(n),this._moveManipulation?.forEachManipulator(n)},onManipulatorsChanged:()=>L()});a!=null&&(e.geometryRepresentation=a.visualElement,e.geometryRepresentation instanceof pt&&this.addHandles([e.geometryRepresentation.events.on("attachment-origin-changed",()=>{e.object.isDraped||this._updateMoveManipulation(i)}),w(()=>e.object.isDraped,()=>this._updateMoveManipulation(i))],Se),this.addHandles(a,Se))}}_updateMoveManipulationAngle(i){this._moveManipulation&&(this._moveManipulation.angle=Ua(k(i.object)))}_updateMoveManipulation(i){const e=It(0,0,0,this.view.spatialReference);let t=0,a=!1;const n=this._moveManipulation;if(n){for(const s of i){if(!s.object.visible)continue;this.enableZ&&ht(s.object.operations,s.object.elevationInfo)&&(a=!0);const o=s.geometryRepresentation instanceof pt&&!s.object.isDraped?s.geometryRepresentation.attachmentOrigin:s.object.origin;if(o!=null){const{x:r,y:l,z:c}=o;e.x+=r,e.y+=l,c&&(e.z??=0,e.z+=c),t++}}t>0?(e.x/=t,e.y/=t,e.z??=0,e.z/=t,n.location=e,n.xyManipulation.available=!0,n.xyAxisManipulation.available=!0,n.zManipulation.available=a):n.available=!1}}_buildDragEventPipeline(i,e,t,a,n,s){const o=[],r=[];let l=null,c=null;const h=()=>{for(const p of o)p.dragging=!1;o.length=0,r.length=0,l=null,c=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(i.length===1&&e===0){const p=i[0].object;({steps:a,cancel:n}=this._buildSnappingPipelineSteps(p,p.elevationInfo,a,n,s))}return n=n.next(p=>c?.(p)).next(()=>(r.length&&this.events.emit("move-stop",new ia(r)),this.destroyed||h(),null)),{steps:a=a.next(p=>{if(p.action==="start"){o.length=0,r.length=0;for(const g of i)g.dragging||!g.manipulationXY?.hasManipulator(t)&&g.manipulationXY?.grabbing||(o.push(g),r.push(g.object),g.dragging=!0);if(r.length!==0&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),l=fc(r),c=mc(r),this._emitRecordUndo(),this.events.emit("move-start",new Kn(r)),this.destroyed))return null}return r.length!==0?p:null}).next(p=>l?.(p)).next(p=>(this._updateMoveTooltip(e,p),p)).next(p=>{switch(p.action){case"start":case"update":if(p.translationX||p.translationY||p.translationZ){const g=this.view.toScreen(p.mapStart),_=this.view.toScreen(p.mapEnd);if(!g||!_)return null;const f=_.x-g.x,m=_.y-g.y;if(this.events.emit("move",new es(f,m,r)),this.destroyed)return null}break;case"end":if(this.events.emit("move-stop",new ia(r)),this.destroyed)return null;h()}return null}),cancel:n}}_connectTooltips(){let i;if(this.removeHandles(ts),this._shouldShowMovePointTooltip){const e=this.objects.at(0),{events:t}=this;this._movePointTooltipInfo??=new go({viewType:this.view.type,sketchOptions:this.sketchOptions});const a={onBeforeUpdate:()=>this.endDrag(),onMoveStart:()=>{this._emitRecordUndo(),t.emit("move-start",new Kn([e]))},onMove:()=>t.emit("move",new es(0,0,[e])),onMoveStop:()=>t.emit("move-stop",new ia([e])),onRotateStart:()=>{},onRotate:()=>{},onRotateStop:()=>{},onScaleStart:()=>{},onScale:()=>{},onScaleStop:()=>{}};i=bo(this.tooltip,e,()=>({sketchOptions:this.sketchOptions,activeTooltipInfo:this._movePointTooltipInfo,callbacks:a}))}else i=w(()=>this.sketchOptions.tooltips.effectiveEnabled?this._latestTooltipInfo:null,e=>{this.tooltip.info=e},Ke);this.addHandles(i,ts)}_showTooltip(i){this._shouldShowMovePointTooltip||this._updateMoveTooltip(i)}_hideTooltip(){this._shouldShowMovePointTooltip||(this.tooltip?.clear(),this._latestTooltipInfo=null)}_updateMoveTooltip(i,e){if(this._shouldShowMovePointTooltip)return;const{sketchOptions:t,autoLengthMeasurementUtils:a}=this;switch(i){case 0:this._latestTooltipInfo=this._translateTooltipInfo??=new Ga({sketchOptions:t}),aa(this._latestTooltipInfo,e,(n,s)=>a.autoDistanceBetweenPoints2D(li(n),li(s)));break;case 1:this._latestTooltipInfo=this._translateXYTooltipInfo??=new St({sketchOptions:t}),aa(this._latestTooltipInfo,e,(n,s)=>Aa(a.autoDistanceBetweenPoints2D(li(n),li(s)),To(e)));break;case 2:this._latestTooltipInfo=this._translateZTooltipInfo??=new ct({sketchOptions:t}),aa(this._latestTooltipInfo,e,Cs)}this._latestTooltipInfo.sketchOptions=t}_emitRecordUndo(){const i=this.objects.toArray().map(e=>e.createUndoRecord?.()).filter(zs);i.length>0&&this.events.emit("record-undo",{updates:i})}_buildSnappingPipelineSteps(i,e,t,a,n){const s=k(i);if(s==null||s.type!=="point"&&s.type!=="mesh")return{steps:t,cancel:a};const o=(s.type==="point"?s:s.origin).clone(),r=new Ri({elevationInfo:e,pointer:n,editGeometryOperations:Ha.fromGeometry(o,this.view.state.viewingMode),visualizer:new Xt,excludeFeature:i.graphic}),l=this.snappingManager,{snappingStep:c,cancelSnapping:h}=Ai({snappingContext:r,snappingManager:l,updatingHandles:this._updatingHandles});return a=a.next(h),{steps:t=t.next(p=>(o.z=Vr(this.view,o,i.elevationInfo,{mode:"absolute-height",offset:0}),{...p,snapOrigin:r.coordinateHelper.pointToVector(o)})).next(...c),cancel:a}}};u([d({constructOnly:!0,nonNullable:!0})],ie.prototype,"view",void 0),u([d({constructOnly:!0})],ie.prototype,"autoLengthMeasurementUtils",void 0),u([d()],ie.prototype,"objects",void 0),u([d({constructOnly:!0,nonNullable:!0})],ie.prototype,"enableZ",void 0),u([d({constructOnly:!0,type:tt})],ie.prototype,"sketchOptions",void 0),u([d({constructOnly:!0})],ie.prototype,"snappingManager",void 0),u([d()],ie.prototype,"type",void 0),u([d()],ie.prototype,"updating",null),u([d()],ie.prototype,"_latestTooltipInfo",void 0),u([d()],ie.prototype,"_shouldShowMovePointTooltip",null),u([d()],ie.prototype,"activeTooltipInfo",null),ie=u([H("esri.views.3d.interactive.editingTools.move.MoveTool3D")],ie);const li=Ls(me);class ru{constructor(e){this.object=e,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1}}function aa(i,e,t){if(e==null||e.action==="end")return void(i.distance=we);const{mapStart:a,mapEnd:n}=e,s=t(a,n);i.distance=s??we}function na(i,e,t){const a=t.mode==="on-the-ground"?1:0;return new Ql(i,a,e,0)}function is(i,e,t){const a=M();if(!i.renderCoordsHelper.toRenderCoords(e,a))return null;const n=as(i,e,gt(t.plane)),s=as(i,e,t.edgeDirection);if(n==null||s==null)return null;const o=de(M(),n,s);return dt(a,o,Kt())}function as(i,e,t){const a=It(e.x+t[0],e.y+t[1],e.z+t[2],e.spatialReference),n=M(),s=M();return i.renderCoordsHelper.toRenderCoords(e,n)&&i.renderCoordsHelper.toRenderCoords(a,s)?ks(s,n,s):null}function lu(i,e,t){const a=gt(i),n=ks(M(),e,t),s=de(M(),n,a),o=de(M(),n,s);return Fr(n[0],n[1],n[2],0,s[0],s[1],s[2],0,o[0],o[1],o[2],0,0,0,0,1)}function cu(i,e,t){const a=t.projectToRenderScreen(i,fa()),n=t.projectToRenderScreen(e,fa());return a!=null&&n!=null?Ur($(a,a,n)):0}function ns(i,e,t,a){const{elevationInfo:n,operations:s}=t;if(!s||!i)return null;const o=a.manipulator.elevationAlignedLocation,r=Ra(o,e,n),l=e.sceneIntersectionHelper.intersectElevationFromScreen(Me(i.x,i.y),n,r);return l&&wi(l,l,s.data.spatialReference)?l:null}function hu(i,e,t,{data:{coordinateHelper:a,spatialReference:n}}){const s=Zr(i,"meters"),o=Br(n),r=Math.sign(s*t.selectedArrow),l=Nr(n),c=gt(t.plane),h=a.pointToXYZ(e),p=M();qe(p,h,c,r*(uu/o));const g=s*t.selectedArrow/o;if(!l||!Je(h,n,h,l)||!Je(p,n,p,l))return g;const _=new Yr;if(Wr(_,h,p,l),qr(p,h,_.azimuth,s,l),!Je(p,l,p,n))return g;const f=p[0]-e.x,m=p[1]-e.y,y=Math.sqrt(f*f+m*m)*r,[v,S]=c,j=Math.sqrt(v*v+S*S);return j===0?0:y/j}const uu=10;let Ze=class extends ei{constructor(e){super(e),this.type="reshape-edge-offset",this.distance=Kl({lockable:!1}),this.area=ec({visible:!1}),this.totalLength=tc({visible:!1})}get allFields(){return[this.distance,this.area,this.totalLength]}};u([d()],Ze.prototype,"type",void 0),u([d()],Ze.prototype,"distance",void 0),u([d()],Ze.prototype,"area",void 0),u([d()],Ze.prototype,"totalLength",void 0),u([d()],Ze.prototype,"allFields",null),Ze=u([H("esri.views.interactive.tooltip.infos.ReshapeEdgeOffsetTooltipInfo")],Ze);function du(i,e){const t=e?.type;return{edgeOffset:new Ze({sketchOptions:i,viewType:t}),movePoint:new go({sketchOptions:i,viewType:t}),selectedVertex:new Sc({sketchOptions:i,viewType:t}),translate:new Ga({sketchOptions:i,viewType:t}),translateXY:new St({sketchOptions:i,viewType:t}),translateZ:new ct({sketchOptions:i,viewType:t})}}function pu(i,e,t){function a(){const r=t(),l=r.sketchOptions.tooltips.effectiveEnabled?r.activeTooltipInfo:null;return{...r,activeTooltipInfo:l}}let n=!1;function s(r){n||(n=!0,r(),n=!1)}function o(r){s(()=>{_u(e,r),i.info=r.activeTooltipInfo})}return F([w(a,o,Ke),w(()=>{const r=a(),{activeTooltipInfo:l}=r;if(l&&"key"in l)return{context:r,activeTooltipInfo:l,key:l.key,geometry:k(e)}},(r,l)=>{r&&l&&l.key!==r.key&&s(()=>ss(e,r.context))},Et),e.on("committed",()=>o(a())),Gs(i,{onBeforePaste:()=>{n=!0},onAfterPaste:()=>{ss(e,a()),n=!1}})])}function ss(i,{activeTooltipInfo:e,selectedVertexManipulatorInfo:t,callbacks:a}){if(!e)return;a.onBeforeReshape();const n=k(i);switch(n?.type){case"mesh":e.type==="move-point"&&Ci(e,n.origin,i,a);break;case"point":e.type==="move-point"&&Ci(e,n,i,a);break;case"polyline":case"polygon":e.type==="selected-vertex"&&gu(e,t,i,a)}}function gu(i,e,t,a){if(!e)return;const{dx:n,dy:s,dz:o}=Vs(i,e.manipulator.location);n===0&&s===0&&o===0||(a.onReshapeStart(),t.operations?.moveVertices([e.handle],n,s,o,0),a.onReshape(),a.onReshapeStop())}function _u(i,e){const{activeTooltipInfo:t,selectedVertexManipulatorInfo:a,sketchOptions:n}=e;if(t)switch(t.sketchOptions=n,t?.type){case"move-point":yo(t,i);break;case"selected-vertex":fu(t,a,i,e)}}function fu(i,e,t,{automaticAreaMeasurementUtils:a,automaticLengthMeasurementUtils:n}){if(!i||i.type!=="selected-vertex")return;const s=e?.manipulator.location;i.setLocationFromPoint(s),Mo(i,s,t);const o=t.operations?.data.geometry;switch(o?.type){case"polygon":i.geometryType="polygon",i.totalLength.visible=!1,i.area.actual=a.autoArea2D(o);break;case"polyline":i.geometryType="polyline",i.totalLength.actual=n.autoLength2D(o),i.area.visible=!1}}const ci=Ls(me);function mu(i,e,{sketchOptions:t,tooltipInfos:a,automaticLengthMeasurementUtils:n}){let s=null;switch(i){case 0:s=a.translate,sa(s,e,(o,r)=>n.autoDistanceBetweenPoints2D(ci(o),ci(r)));break;case 1:s=a.translateXY,sa(s,e,(o,r)=>Aa(n.autoDistanceBetweenPoints2D(ci(o),ci(r)),To(e)));break;case 2:s=a.translateZ,sa(s,e,Cs)}return s.sketchOptions=t,s}function sa(i,e,t){if(e!=null&&e.action!=="end"){const{mapStart:a,mapEnd:n}=e,s=t(a,n);i.distance=s??we}else i.distance=we}function os({operations:i},e,{sketchOptions:t,tooltipInfos:a,automaticAreaMeasurementUtils:n,automaticLengthMeasurementUtils:s}){const o=a.edgeOffset;if(o.distance.committed=null,e!=null&&e.signedDistance!=null&&e.action!=="end"&&i!=null){const l=i.data.coordinateHelper,{start:c,end:h}=e.operation.clampedStartAndEnd(e.mapEnd),p=s.autoDistance2D(c,h,l.spatialReference),g=Math.sign(e.signedDistance*e.operation.selectedArrow);o.distance.actual=p!=null?Aa(p,g):null}else o.distance.actual=we;const r=i?.data.geometry;switch(o.area.actual=null,o.area.visible=!1,o.totalLength.actual=null,o.totalLength.visible=!1,r?.type){case"polygon":o.area.actual=n.autoArea2D(r),o.area.visible=!0;break;case"polyline":o.totalLength.actual=s.autoLength2D(r),o.totalLength.visible=!0}return o.sketchOptions=t,o}const rs={Left:0,Right:2},ls=Symbol();let I=class extends et{get _operations(){return this.object.operations}constructor(i){super(i),this._selectedIndex=0,this._manipulatorHandles=new Li,this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=0,this._pendingEdgeOffsetInfo=null,this._updatingHandles=new ki,this._recreatingManipulators=!1,this._settings=new _t({getTheme:()=>this.view.effectiveTheme}),this.events=new ze,this.activeTooltipInfo=null,this._vertexLaserLineVisualElement=null,this._tooltipCallbacks={onBeforeReshape:()=>this.tool.endDrag(),onReshapeStart:()=>this._updateEventState(2),onReshape:()=>this.events.emit("reshape",{type:"reshape",object:this.object}),onReshapeStop:()=>this._updateEventState(0,{forceEnd:!0}),onMoveStart:()=>this._updateEventState(1),onMove:()=>this.events.emit("move",{type:"move",object:this.object,dx:0,dy:0}),onMoveStop:()=>this._updateEventState(0,{forceEnd:!0})}}initialize(){const{view:i}=this,e=this._settings.manipulators,t=e.vertex;this.tooltipInfos=du(this._sketchOptions,i),this._vertexManipulatorMaterial=Ie(K(t.color),t.renderOccluded),this._vertexManipulatorOutlineMaterial=Ct(K(t.outlineColor),t.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=Ct(K(t.hoverOutlineColor),t.renderOccluded);const a=e.edge;this._edgeManipulatorMaterial=Ie(K(a.color),a.renderOccluded),this._edgeManipulatorOutlineMaterial=Ct(K(a.outlineColor),a.renderOccluded);const n=e.edgeOffset;this._edgeOffsetManipulatorMaterial=Ie(K(n.color),n.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=Ie(K(n.hoverColor),n.renderOccluded,!1);const s=e.selected;this._selectedManipulatorMaterial=Ie(K(s.color),s.renderOccluded),this._selectedManipulatorOutlineMaterial=Ct(K(s.outlineColor),s.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=Ct(K(s.hoverOutlineColor),s.renderOccluded),this.tooltip=Hi(()=>({view:i,options:this._sketchOptions.tooltips})),this.addHandles([w(()=>{const o=this._settings.manipulators;return{vertexSettings:o.vertex,edgeSettings:o.edge,edgeOffsetSettings:o.edgeOffset,selectedSettings:o.selected}},({vertexSettings:o,edgeSettings:r,edgeOffsetSettings:l,selectedSettings:c})=>{o.applyColor(this._vertexManipulatorMaterial),o.applyOutline(this._vertexManipulatorOutlineMaterial),o.applyHoverOutline(this._vertexManipulatorHoverOutlineMaterial),r.applyColor(this._edgeManipulatorMaterial),r.applyOutline(this._edgeManipulatorOutlineMaterial),l.applyColor(this._edgeOffsetManipulatorMaterial),l.applyHover(this._edgeOffsetManipulatorHoverMaterial),c.applyColor(this._selectedManipulatorMaterial),c.applyOutline(this._selectedManipulatorOutlineMaterial),c.applyHoverOutline(this._selectedManipulatorHoverOutlineMaterial)}),w(()=>this.object.visible,o=>{for(const r of this._manipulatorInfos)r.manipulator.available=o,ra(r)&&(r.edgeManipulator.available=o)}),w(()=>this._numGrabbing+this._numDragging===0,o=>this._toggleAutoHideManipulators(o)),w(()=>({labels:this._segmentLabels,enabled:this._sketchOptions.labels.enabled,edgeOffsetEnabled:this.enableEdgeOffset}),({labels:o,enabled:r,edgeOffsetEnabled:l})=>{o!=null&&(o.visible=r,o.edgeDistance=l?"far":"default")},A),pu(this.tooltip,this.object,()=>this._tooltipsContext),w(()=>this.tooltip.mode,(o,r)=>{r==="input"&&o!=="input"&&this._resetTooltip()}),Ft(()=>this._operations,"vertex-update",o=>this._updateManipulatorPositions(o.vertices),{onListenerAdd:()=>this._recreateManipulators()}),Ft(()=>this._operations?.data,"change",o=>{o.operation!=="undo"&&o.operation!=="redo"||this._recreateManipulators()})])}destroy(){this._removeManipulators(),this._updatingHandles.destroy(),this._segmentLabels=C(this._segmentLabels),this.tooltip=C(this.tooltip)}get updating(){return this._updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get automaticAreaMeasurementUtils(){return this.tool.automaticAreaMeasurementUtils}get automaticLengthMeasurementUtils(){return this.tool.automaticLengthMeasurementUtils}get object(){return this.tool.object}get enableZShape(){return this.tool.enableZShape}get enableDeleteVertices(){return this.tool.enableDeleteVertices}get enableZVertex(){return this.tool.enableZVertex}get autoHideManipulators(){return this.tool.autoHideManipulators}get enableMoveObject(){return this.tool.enableMoveObject}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _sketchOptions(){return this.tool.sketchOptions}get _accentColor(){return this.view.effectiveTheme.accentColor}enterInputModeIfAvailable(i){return i.type==="key-down"&&i.key===Xr.enterInputMode&&(this.activeTooltipInfo?.type==="reshape-edge-offset"?this._enterInputModeDuringEdgeOffset(i):!!Di(i,this.tooltip)&&(this.tool.endDrag(),!0))}removeSelectedVertices(){const i=this._manipulatorInfos.filter(e=>e.manipulator.selected&&e.type==="vertex");return this._removeVertices(i),i.length}onManipulatorSelectionChanged(){this.events.emit("manipulators-changed")}_removeManipulators(){this._manipulatorHandles.removeAll(),this._moveManipulation=C(this._moveManipulation),this._objectMoveManipulation=C(this._objectMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0}_createManipulators(i){if(this._operations==null)return;const e=this.object.elevationInfo;for(const{vertices:t,segments:a,index:n}of this._operations.data.parts){const s=i?.byPartIndex.get(n);for(const o of t){const r=s?.has(o.index);this._createVertexOrEdgeManipulator(o,e,r)}for(const o of a)o.type==="line"&&this._createVertexOrEdgeManipulator(o,e)}this._createObjectMoveManipulation(),this._createMoveManipulation(e),this._createVisualElements()}recordUndo(i){this._operations?.recordUndo(i)}get canRedo(){return this._operations?.canRedo??!1}get canUndo(){return this._operations?.canUndo??!1}redo(){return this._operations?.redo()}undo(){return this.events.emit("undo"),this._operations?.undo()}_recreateManipulators(){if(!this._recreatingManipulators){if(this._recreatingManipulators=!0,this._removeManipulators(),this._resetTooltip(),this._operations&&this._segmentLabels?.context?.editGeometryOperations===this._operations||(this._segmentLabels=C(this._segmentLabels)),this._createManipulators(),!this._segmentLabels&&this._operations){const i=this._sketchOptions.labels;this._segmentLabels=new zi({context:{view:this.view,editGeometryOperations:this._operations,elevationInfo:this.object.elevationInfo,labelOptions:i,automaticLengthMeasurementUtils:this.automaticLengthMeasurementUtils},visible:i.enabled})}this._recreatingManipulators=!1}}_perObjectManipulatorDragAction(i,e){if(e.action==="end")return e;let t=0;const a=[],n=this._manipulatorInfos.some(o=>o.type==="vertex"&&o.manipulator.selected),s=i===1&&n;for(const o of this._manipulatorInfos)o.type==="vertex"&&(o.manipulator.grabbing||s&&!o.manipulator.selected||a.push(o),t++);if(this._moveVertices(a,e),a.length===t){if(this._updateEventState(1),this.destroyed)return e;this.events.emit("move",{type:"move",dx:e.screenDeltaX,dy:e.screenDeltaY,object:this.object})}else{if(this._updateEventState(2),this.destroyed)return e;this.events.emit("reshape",{type:"reshape",object:this.object})}return e}_toggleAutoHideManipulators(i){this.autoHideManipulators&&(i?this.removeHandles(ls):this.tool.manipulators.forEach(({manipulator:e})=>{const t=e.disableDisplay?.();t&&this.addHandles(t,ls)}))}_isMultiVertexSelection(){return this._manipulatorInfos.reduce((i,e)=>e.type==="vertex"&&e.manipulator.selected?i+1:i,0)>1}_perVertexManipulatorDragAction(i){if(this._updateEventState(2),this.destroyed)return;const{mapDeltaX:e,mapDeltaY:t,mapDeltaZ:a}=i;if(!e&&!t&&!a)return;const n=[];for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.selected&&!s.manipulator.grabbing||s===i.info)&&n.push(s);this._moveVertices(n,i,1),this.events.emit("reshape",{type:"reshape",object:this.object})}_updateEventState(i,e={}){if(i===this._reshapeEventState)return!1;switch(i){case 0:if(!e.forceEnd&&(this._numGrabbing!==0||this._numDragging!==0))return!1;switch(this._reshapeEventState){case 1:this.events.emit("move",{type:"move-stop",dx:0,dy:0,object:this.object});break;case 2:this.events.emit("reshape",{type:"reshape-stop",object:this.object})}break;case 1:switch(this._reshapeEventState){case 0:this.events.emit("move",{type:"move-start",dx:0,dy:0,object:this.object});break;case 2:this.events.emit("reshape",{type:"reshape-stop",object:this.object}),this.destroyed||this.events.emit("move",{type:"move-start",dx:0,dy:0,object:this.object})}break;case 2:switch(this._reshapeEventState){case 0:this.events.emit("reshape",{type:"reshape-start",object:this.object});break;case 1:this.events.emit("move",{type:"move-stop",dx:0,dy:0,object:this.object}),this.destroyed||this.events.emit("reshape",{type:"reshape-start",object:this.object})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==i;return this._reshapeEventState=i,t}_createObjectMoveManipulation(){const{tool:i,view:e,object:t,_operations:a}=this;if(a){if(this._objectMoveManipulation=new Ba({tool:i,view:e,object:t}),this.enableMoveObject){let n=null;this._manipulatorHandles.add(this._objectMoveManipulation.createDragPipeline((s,o,r)=>{o.next(l=>this._trackNumDragging(l)).next(l=>(l.action==="start"&&(n=a.createUndoGroup()),l)).next(l=>this._perObjectManipulatorDragAction(0,l)).next(l=>(this._updateTranslateObjectTooltip(0,l),l)).next(l=>{l.action==="end"&&(this._resetTooltip(),n=De(n))}),r.next(()=>this._onDragCancel(!0,()=>n=De(n)))})),this._objectMoveManipulation.forEachManipulator(s=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(s,!1)))}else this._objectMoveManipulation.forEachManipulator(n=>{n.grabbable=!1,n.cursor=null});this._objectMoveManipulation.forEachManipulator(n=>this._manipulatorHandles.add(n.events.on("immediate-click",s=>{this._manipulatorInfos.some(o=>o.manipulator.selected)?this._clearSelection():this.events.emit("immediate-click",{...s,object:this.object}),s.stopPropagation()})))}}_createMoveManipulation(i){const{object:e,tool:t,view:a,_operations:n}=this;if(!n)return;this._moveManipulation=new ut({tool:t,view:a,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&ht(e.operations,e.elevationInfo),snapToScene:!1,radius:ut.radiusForSymbol(e.graphic?.symbol)}),this._moveManipulation.forEachManipulator(r=>this.addHandles([r.events.on("immediate-click",l=>{this._moveManipulation.zManipulation.hasManipulator(r)||this._manipulatorInfos.some(c=>c.manipulator.selected)||this.events.emit("immediate-click",{...l,object:this.object}),l.stopPropagation()}),this._watchAndUpdateGrabState(r,!1)]));const s=r=>l=>{this.addHandles([l.events.on("focus-changed",({action:c})=>{c==="focus"?this._updateTranslateTooltip(r):this._resetTooltip()})])};this._moveManipulation.xyManipulation.forEachManipulator(s(0)),this._moveManipulation.xyAxisManipulation.forEachManipulator(s(1)),this._moveManipulation.zManipulation.forEachManipulator(s(2)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const o=n.data.spatialReference;this.addHandles([this._moveManipulation.createDragPipeline((r,l,c,h,p)=>{const{snappingStep:g,cancelSnapping:_}=Ai({predicate:f=>!!f.info,snappingManager:t.snappingManager,snappingContext:new Ri({editGeometryOperations:n,elevationInfo:i,pointer:p,excludeFeature:e.graphic,visualizer:new Xt}),updatingHandles:this._updatingHandles,useZ:!1});return h=h.next(f=>(this._onDragCancel(),f)).next(_),{steps:c=c.next(f=>this._trackNumDragging(f)).next(f=>{const m=this._manipulatorInfos.filter(y=>y.type==="vertex"&&y.manipulator.selected);return f.manipulatorType===1&&m.length===1?{...f,info:m[0],snapOrigin:m[0].handle.pos}:f}).next(mn(this.view,i,e.graphic??void 0)).next(...g).next(xt()).next(f=>this._perObjectManipulatorDragAction(1,f)).next(f=>(this._updateTranslateTooltip(r,f),f)),cancel:h}},i,o,e.graphic),w(()=>e.visible,()=>this._updateMoveManipulationPosition(),A),e.on("committed",()=>{this._recreatingManipulators||this._updateMoveManipulationPosition()}),w(()=>e.isDraped,r=>{this._updateMoveManipulationPosition();const l="align-move-manipulation";r?this.addHandles(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),l):this.removeHandles(l)},A)])}_createVisualElements(){const{object:i,view:e}=this,t=Zi({view:e,object:i,forEachManipulator:n=>{if(!this.destroyed&&!this._recreatingManipulators){this._objectMoveManipulation.forEachManipulator(n),this._moveManipulation.forEachManipulator(n);for(const s of this._manipulatorInfos)n(s.manipulator,1)}},onManipulatorsChanged:n=>this.events.on("manipulators-changed",n)});t!=null&&(this._outlineVisualElement=t.visualElement instanceof pt?t.visualElement:null);const a=this._outlineVisualElement;if(a!=null){const n=()=>{i.isDraped||this._updateMoveManipulationPosition()};this._manipulatorHandles.add(Ft(()=>a.events,"attachment-origin-changed",n,{onListenerAdd:n}))}this._manipulatorHandles.add(t)}_createEdgeOffsetManipulator(i,e=this.object.elevationInfo){const t=this.view,a=this._operations;if(i.part.vertices.length<=2||!a)return null;const n=a.data.spatialReference,s=this._settings.manipulators.edgeOffset,o=s.size/2,r=o+s.collisionPadding,l=o/r,c=l/2,h=l*Math.sqrt(3)/2,{height:p,offset:g}=s,_=this._edgeOffsetManipulatorMaterial;if(!this._edgeOffsetManipulatorGeometryInside){const T=Ti(_,h,c,c,p,g);this._edgeOffsetManipulatorGeometryInside=T}if(!this._edgeOffsetManipulatorGeometryOutside){const T=Ti(_,-h,c,c,p,-g);this._edgeOffsetManipulatorGeometryOutside=T}const f=[new x(this._edgeOffsetManipulatorGeometryInside.instantiate(),1),new x(this._edgeOffsetManipulatorGeometryInside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),2),new x(this._edgeOffsetManipulatorGeometryOutside.instantiate(),1),new x(this._edgeOffsetManipulatorGeometryOutside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),2)],m=new ee({view:t,renderObjects:f,elevationInfo:e.mode!=="on-the-ground"||bn(this.object.graphic?.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:r,available:this.object.visible,collisionType:{type:"disc",direction:R(0,0,1)},collisionPriority:1,metadata:{deleting:!1},location:oa(n)}),y=new ee({view:t,worldSized:!0,worldOriented:!1,available:this.object.visible,collisionPriority:-10,cursor:this.enableMoveObject?"move":"default",metadata:{deleting:!1},location:oa(n)}),v={manipulator:m,handle:i,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:y,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(v,s.minSquaredEdgeLength);const S=()=>this._updateEdgeOffsetManipulator(v);S(),v.locationUpdateHandle=F([i.leftVertex,i.rightVertex].map(T=>this._getManipulatorInfoFromHandle(T)?.manipulator.events.on("location-update",S)));const j=T=>{this._manipulatorInfos.some(D=>D.manipulator.selected)?this._clearSelection():this.events.emit("immediate-click",{...T,object:this.object}),T.stopPropagation()};return this._manipulatorHandles.add([v.locationUpdateHandle,this._watchAndUpdateGrabState(m,!0),this._watchAndUpdateGrabState(y,!0),ye(m,this._createEdgeOffsetPipeline(v,e,a)),ye(y,this._createEdgePipeline(v,e,a)),y.events.on("immediate-click",j),m.events.on("immediate-click",j),m.events.on("focus-changed",()=>this._resetTooltip()),m.events.on("grab-changed",({screenPoint:T,action:D})=>{v.grabMapPoint=D==="start"?ns(T,this.view,this.object,v):null})],m),this._manipulatorInfos.push(v),this.manipulators.addMany([m,y]),this.events.emit("manipulators-changed"),v}_autoHideEdgeOffsetManipulator(i,e){const t=i.manipulator,a=i.edgeManipulator,n=()=>{i.visibilityHandle=De(i.visibilityHandle);const s=this._getManipulatorInfoFromHandle(i.handle.leftVertex),o=this._getManipulatorInfoFromHandle(i.handle.rightVertex),r=s!=null&&o!=null&&cu(s.manipulator.renderLocation,o.manipulator.renderLocation,this.view.state.camera)<e;(!t.focused&&!a.focused||r)&&(t.grabbable=!r,a.grabbable=!r,i.visibilityHandle=F([t.disableDisplay(),L(()=>{t.grabbable=!0,a.grabbable=this.enableMoveObject})]))};this._manipulatorHandles.add([t.events.on("focus-changed",n),a.events.on("focus-changed",n),L(()=>{De(i.visibilityHandle),a.metadata.deleting=!0,this.manipulators.remove(a)})],t),n()}_updateEdgeOffsetManipulator(i){if(!this._operations)return;this._updateManipulatorPosition(i);const{coordinateHelper:e}=this._operations.data,t=is(this.view,i.manipulator.elevationAlignedLocation,na(e,i.handle,i.manipulator.elevationInfo)),a=this._getManipulatorInfoFromHandle(i.handle.leftVertex),n=this._getManipulatorInfoFromHandle(i.handle.rightVertex);if(a==null||n==null)return;const s=a.manipulator.renderLocation,o=n.manipulator.renderLocation,r=t!=null?lu(t,s,o):Jr;i.manipulator.modelTransform=r,i.edgeManipulator.elevationAlignedLocation=i.manipulator.elevationAlignedLocation,i.edgeManipulator.modelTransform=r;const l=$e($(hi,s,o))/2;i.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}}_createEdgePipeline(i,e,t){return(a,n,s,o)=>{if(o==="touch")this._createEdgeOffsetPipeline(i,e,t)(a,n,s);else if(this.enableMoveObject){const r=this.object.graphic,l=t.data.spatialReference,{elevationAlignedLocation:c}=a;n.next(h=>this._trackNumDragging(h)).next(Bt(this.view,c)).next(Jt(this.view,c,e,l,r)).next(Rt()).next(xt()).next(h=>this._perObjectManipulatorDragAction(0,h)).next(h=>(this._updateTranslateObjectTooltip(0,h),h)).next(h=>{h.action==="end"&&this._resetTooltip()}),s.next(()=>this._onDragCancel(!a.metadata.deleting))}}}_createEdgeOffsetPipeline(i,e,t){return(a,n,s)=>{const o=this._pendingEdgeOffsetInfo;if(o?.manipulatorInfo===i&&o.mode!=="drag")return void s.execute({action:"cancel"});this._clearSelection();const{initializeStep:r,cleanup:l}=this._initializeEdgeOffset(i,e,t,s),c=this._applyEdgeOffsetStep(i);n.next(h=>this._trackNumDragging(h)).next(Bt(this.view,a.elevationAlignedLocation)).next(r).next(Bh(this.view)).next(jo(this.view,t.data.spatialReference)).next(xt()).next(vu()).next(h=>this._pendingEdgeOffsetInfo?h:c(h)).next(h=>{h.action!=="end"||this._pendingEdgeOffsetInfo||l()}),s.next(()=>{this._exitEdgeOffsetInputMode(),a.metadata.deleting||(l(),this._onDragCancel())})}}_initializeEdgeOffset(i,e,t,a){const{view:n,object:s}=this,o=na(t.data.coordinateHelper,i.handle,e),r=t.createUndoGroup(),l=is(n,i.manipulator.elevationAlignedLocation,o);let c;this._splitEdgesBeforeEdgeOffset(i,o),this._selectEdgeOffsetArrow(i,o);const h=()=>{this._cleanEdgeOffsetCollapsedEdges(i,t),c=De(c)},p=this.events.on("undo",h);return c=F([this._initializeEdgeOffsetVisualElement(i,s,e,t),r,p,this._connectEdgeOffsetTooltip(i,o,t,()=>{a.execute({action:"cancel"})})]),{initializeStep:g=>o==null||l==null?(h(),null):{...g,operation:o,plane:l},cleanup:h}}_initializeEdgeOffsetVisualElement(i,e,t,a){const n=()=>new Qr({paths:[[i.handle.leftVertex.pos,i.handle.rightVertex.pos]],spatialReference:a.data.spatialReference}),s=new pt({view:this.view,isDraped:e.isDraped,geometry:n(),elevationInfo:t,width:this._settings.visualElements.lineObjects.outline.width,attached:!1,isDecoration:!0}),o=F([w(()=>({color:this._accentColor,draped:e.isDraped}),({color:r,draped:l})=>{s.color=K(r),s.isDraped=l},Ke),e.on("committed",()=>{s.geometry=n()}),re(s)]);return s.attached=!0,o}_applyEdgeOffsetStep(i){return e=>(this.destroyed||e.operation==null||!this._operations||(this._updateEventState(2),e.signedDistance==null?this._resetTooltip():((e.mapDeltaX||e.mapDeltaY||e.mapDeltaZ)&&(this._offsetEdge(i,e.operation,e.signedDistance),this.events.emit("reshape",{type:"reshape",object:this.object})),this._updateEdgeOffsetTooltip(e))),e)}_cleanEdgeOffsetCollapsedEdges(i,e){const t=i.handle.leftVertex.leftSegment?.leftVertex,a=i.handle.leftVertex,n=i.handle.rightVertex.rightSegment?.rightVertex,s=i.handle.rightVertex,o=e.data.coordinateHelper,r=this.view.pixelSizeAt(o.vectorToDehydratedPoint(a.pos),o.spatialReference),l=[];if(t&&o.distance(t.pos,a.pos)<us){const c=this._getManipulatorInfoFromHandle(a);c!=null&&l.push(c)}if(o.distance(a.pos,s.pos)<r||n&&o.distance(n.pos,s.pos)<us){const c=this._getManipulatorInfoFromHandle(s);c!=null&&l.push(c)}l.length&&this._removeVertices(l)}_enterInputModeDuringEdgeOffset(i){const e=this._findActiveEdgeOffsetManipulatorInfo();return!!e&&!!Di(i,this.tooltip)&&(e.manipulator.dragging?(this._pendingEdgeOffsetInfo={manipulatorInfo:e,mode:"drag"},!0):(this._clearSelection(),this._pendingEdgeOffsetInfo={manipulatorInfo:e,mode:"hover"},this._connectEdgeOffsetTooltipOnHover(e),!0))}_exitEdgeOffsetInputMode(){this.tooltip&&(this._pendingEdgeOffsetInfo=null,this._resetTooltip(),this.tooltip.exitInputMode())}_findActiveEdgeOffsetManipulatorInfo(){return this._manipulatorInfos.filter(ra).find(({manipulator:i})=>i.hovering||i.grabbing||i.dragging)}_connectEdgeOffsetTooltipOnHover(i){const{_operations:e,object:t}=this;if(!e)return;const{elevationInfo:a}=t,n=na(e.data.coordinateHelper,i.handle,a);this._selectEdgeOffsetArrow(i,n),this.addHandles([this._initializeEdgeOffsetVisualElement(i,t,a,e),this._connectEdgeOffsetTooltip(i,n,e,()=>{this.removeHandles(n),this._exitEdgeOffsetInputMode()})],n)}_splitEdgesBeforeEdgeOffset(i,e){if(e.requiresSplitEdgeLeft){const t=this._getManipulatorInfoFromHandle(i.handle.leftVertex.leftSegment);t!=null&&this._splitEdgeManipulator(t,1)}if(e.requiresSplitEdgeRight){const t=this._getManipulatorInfoFromHandle(i.handle.rightVertex.rightSegment);t!=null&&this._splitEdgeManipulator(t,0)}}_selectEdgeOffsetArrow(i,e){const t=i.grabMapPoint??ns(this.view.inputManager?.latestPointerInfo?.location,this.view,this.object,i);t&&e.selectArrowFromStartPoint(t)}_connectEdgeOffsetTooltip(i,e,t,a){const n=()=>this.tooltipInfos.edgeOffset.distance.actual,s=r=>{a(),queueMicrotask(()=>{this.view.focus();const l=t.createUndoGroup();this._tooltipCallbacks.onReshapeStart?.(),this._splitEdgesBeforeEdgeOffset(i,e),this._offsetEdge(i,e,hu(r,i.manipulator.location,e,t)),this._tooltipCallbacks.onReshape?.(),this._tooltipCallbacks.onReshapeStop?.(),this._cleanEdgeOffsetCollapsedEdges(i,t),l.remove()})},o=()=>{const r=n();r!=null?s(r):a()};return F([Dt(()=>this.tooltip&&!this.tooltip.focused,()=>o(),Et),this.tooltip.on("discard",a),this.tooltip.on("commit",r=>{r.type==="commit-and-exit"&&o()})])}_createVertexOrEdgeManipulator(i,e=this.object.elevationInfo,t=!1){const a=this.view,n=this._operations,s=this._settings;if(!n)return null;const o=n.data.type,r=n.data.spatialReference;if(i.type==="line"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(i,e);if(!this.enableMidpoints)return null}if(this._vertexManipulatorGeometry==null||this._vertexManipulatorOutlineGeometry==null){const{size:g,outlineSize:_}=cs(s.manipulators.vertex);this._vertexManipulatorGeometry=Gt(this._vertexManipulatorMaterial,g,16,16),this._vertexManipulatorOutlineGeometry=Gt(this._vertexManipulatorOutlineMaterial,_,16,16)}if(this._edgeManipulatorGeometry==null||this._edgeManipulatorOutlineGeometry==null){const{size:g,outlineSize:_}=cs(s.manipulators.edge);this._edgeManipulatorGeometry=Gt(this._edgeManipulatorMaterial,g,16,16),this._edgeManipulatorOutlineGeometry=Gt(this._edgeManipulatorOutlineMaterial,_,16,16)}const l=o==="point"||o==="mesh"?[]:[new x(this._vertexManipulatorGeometry.instantiate(),4|ui),new x(this._vertexManipulatorOutlineGeometry.instantiate(),5|ui),new x(this._vertexManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),6|ui),new x(this._vertexManipulatorGeometry.instantiate({material:this._selectedManipulatorMaterial}),8),new x(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorOutlineMaterial}),9),new x(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorHoverOutlineMaterial}),10)];this.enableMidpoints&&l.push(new x(this._edgeManipulatorGeometry.instantiate({material:this._vertexManipulatorMaterial}),6|kt),new x(this._edgeManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),6|kt),new x(this._edgeManipulatorGeometry.instantiate(),5|kt),new x(this._edgeManipulatorOutlineGeometry.instantiate(),5|kt));const c=new ee({view:a,renderObjects:l,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:this.object.visible,metadata:{deleting:!1},location:oa(r)});c.selected=t,this._setTypeSpecificManipulatorSettings(c,i,e);const h=i.type==="vertex"?{manipulator:c,handle:i,type:"vertex",selectedIndex:0}:{manipulator:c,handle:i,locationUpdateHandle:null,type:"edge",selectedIndex:0};if(this._manipulatorInfos.push(h),this.manipulators.add(c),this._updateManipulatorPosition(h),h.type==="edge"){const g=[];for(const _ of[h.handle.leftVertex,h.handle.rightVertex]){const f=this._getManipulatorInfoFromHandle(_);f!=null&&g.push(f.manipulator.events.on("location-update",()=>this._updateManipulatorPosition(h)))}h.locationUpdateHandle=F(g),this._manipulatorHandles.add(h.locationUpdateHandle,c)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(c,!0),c);const p=ye(c,(g,_,f,m)=>{let y=null;const{snappingStep:v,cancelSnapping:S}=Ai({predicate:()=>!this._isMultiVertexSelection(),snappingManager:this.tool.snappingManager,snappingContext:new Ri({editGeometryOperations:n,elevationInfo:e,pointer:m,excludeFeature:this.object.graphic,visualizer:new Xt}),updatingHandles:this._updatingHandles,useZ:!1});f=f.next(D=>(this._onDragCancel(!g.metadata.deleting,()=>y=De(y)),D)).next(S);const{elevationAlignedLocation:j}=g,T=this.object.graphic??void 0;_.next(D=>this._trackNumDragging(D)).next(D=>{if(D.action==="start"&&n&&(y=n.createUndoGroup()),h.type==="edge"){const W=this._splitEdgeManipulator(h);return{...D,info:W,snapOrigin:W.handle.pos}}return{...D,info:h,snapOrigin:h.handle.pos}}).next(Bt(a,j)).next(Jt(a,j,e,r,T)).next(mn(a,e,T)).next(...v).next(xt()).next(D=>{this._perVertexManipulatorDragAction(D),D.action==="end"&&(y=De(y)),this._resetTooltip()})});return this._manipulatorHandles.add([p,c.events.on("immediate-click",g=>this._manipulatorClickCallback(g,h)),c.events.on("select-changed",()=>{h.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition(),this._resetTooltip()}),c.events.on("focus-changed",()=>{this._resetTooltip()})],c),this.events.emit("manipulators-changed"),h}_trackNumDragging(i){switch(i.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return i}_onDragCancel(i=!0,e){switch(this._numDragging--,i&&this.undo(),this.tool.snappingManager?.doneSnapping(),this._resetTooltip(),this._reshapeEventState){case 0:break;case 1:this.events.emit("move",{type:"move",dx:0,dy:0,object:this.object});break;case 2:this.events.emit("reshape",{type:"reshape",object:this.object})}e?.(),this.destroyed||this._updateEventState(0)}_setTypeSpecificManipulatorSettings(i,e,t){const a=this._settings;switch(e.type){case"vertex":{i.state=ui,i.selectable=!0,i.cursor="move",i.collisionPriority=2;const{size:n,collisionPadding:s}=a.manipulators.vertex;i.radius=n/2+s,i.elevationInfo=t;const o=this._operations?.data.type;i.interactive=o!=null&&o!=="point"&&o!=="mesh";break}case"line":{i.state=kt,i.selectable=!1,i.cursor="copy",i.collisionPriority=-1;const{size:n,collisionPadding:s}=a.manipulators.edge;i.radius=n/2+s,i.elevationInfo=t.mode!=="on-the-ground"||bn(this.object.graphic?.symbol)?{mode:"absolute-height",offset:0}:t;break}}}_watchAndUpdateGrabState(i,e){return i.events.on("grab-changed",t=>{this._onGrabStateChanged(i,e,t.action,t.pointerType)})}_onGrabStateChanged(i,e,t,a="mouse"){if(!this._recreatingManipulators){if(t==="start")e&&this._updateSelection(i),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(0),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(a!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(n=>{const{manipulator:s}=n,o=this._operations?.data.type;s.interactive=s.grabbing||!this._numGrabbing&&o!=null&&o!=="point"&&o!=="mesh",ra(n)&&(n.edgeManipulator.interactive=n.edgeManipulator.grabbing||!this._numGrabbing)}),this._objectMoveManipulation.forEachManipulator(n=>{n.interactive=n.grabbing||!this._numGrabbing}))}}_clearSelection(){for(const i of this._manipulatorInfos)i.manipulator.grabbing||(i.manipulator.selected=!1);this._pendingEdgeOffsetInfo=null}_updateSelection(i){i.grabbing&&!i.selected&&i.selectable&&(this._clearSelection(),i.selected=!0,this.events.emit("manipulators-changed"))}_removeManipulator(i){i!=null&&(i.manipulator.metadata.deleting=!0,this.manipulators.remove(i.manipulator),this._manipulatorHandles.remove(i.manipulator),Kr(this._manipulatorInfos,i),this.events.emit("manipulators-changed"),this._resetTooltip())}_getManipulatorInfoFromHandle(i){return this._manipulatorInfos.find(e=>e.handle===i)}_updateManipulatorPositions(i){for(const e of i)this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e))}_updateManipulatorPosition(i){const e=this._operations;if(i!=null&&e){if(i.type==="vertex")i.manipulator.location=e.data.coordinateHelper.vectorToDehydratedPoint(i.handle.pos,Lt),i.manipulator.grabbing&&this._vertexLaserLineVisualElement!=null&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=i.manipulator.renderLocation);else if(i.type==="edge"){const t=this._getManipulatorInfoFromHandle(i.handle.leftVertex),a=this._getManipulatorInfoFromHandle(i.handle.rightVertex);if(t==null||a==null)return;const n=t.manipulator,s=a.manipulator;if(i.manipulator.elevationInfo?.mode==="on-the-ground"){const o=n.location,r=s.location,l=.5,c=o.x+l*(r.x-o.x),h=o.y+l*(r.y-o.y),p=o.hasZ&&r.hasZ?0:void 0;i.manipulator.location=It(c,h,p,e.data.spatialReference)}else Ye(hi,n.renderLocation,s.renderLocation,.5),i.manipulator.renderLocation=hi}}}_splitEdgeManipulator(i,e=.5){const t=this._operations,a=t.splitSegment(i.handle,e).createdVertex;i.locationUpdateHandle=De(i.locationUpdateHandle);const n=this.object.elevationInfo;let s;this.enableEdgeOffset?(this._removeManipulator(i),s=this._createVertexOrEdgeManipulator(a)):(s=i,s.handle=a,s.type="vertex",this._setTypeSpecificManipulatorSettings(i.manipulator,i.handle,n)),a.leftSegment&&a.leftSegment.type==="line"&&this._createVertexOrEdgeManipulator(a.leftSegment),a.rightSegment&&a.rightSegment.type==="line"&&this._createVertexOrEdgeManipulator(a.rightSegment),this._updateManipulatorPosition(s),this.enableEdgeOffset||this._resetTooltip(),this._updateSelection(i.manipulator);const o=this._updateEventState(2),r=t.data.coordinateHelper.vectorToArray(s.handle.pos),l=t.data.parts.indexOf(a.part);return this.events.emit("vertex-add",{type:"vertex-add",object:this.object,vertices:[{coordinates:r,componentIndex:l,vertexIndex:a.index}],added:r}),o&&this._updateEventState(0),s}_updateMoveManipulationPosition(){const i=B(hi,0,0,0);let e=0,t=!1,a=null,n=null;for(const r of this._manipulatorInfos)r.type==="vertex"&&(r.manipulator.selected?(e++,P(i,i,r.manipulator.renderLocation),a==null||r.selectedIndex>a.selectedIndex?(n=a,a=r):(n==null||r.selectedIndex>n.selectedIndex)&&(n=r)):t=!0);const s=this.object,o=this._operations?.data.geometry;if(e===0){const r=s.visible&&this.enableMoveObject;this._moveManipulation.xyManipulation.available=r,this._moveManipulation.xyAxisManipulation.available=r,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=r,this._moveManipulation.zManipulation.available=r&&this.enableZShape&&ht(this._operations,s.elevationInfo),this._moveManipulation.angle=Ua(o),this._moveManipulation.radius=ut.radiusForSymbol(s.graphic?.symbol)}else{const r=s.visible;this._moveManipulation.xyManipulation.available=r,this._moveManipulation.xyAxisManipulation.available=r,this._moveManipulation.zManipulation.available=r&&this.enableZVertex&&ht(this._operations,this.object.elevationInfo),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=r&&e!==1;let l=0;if(a!=null){const c=a.handle.pos,h=n!=null?n.handle.pos:a.handle.leftSegment?.leftVertex?a.handle.leftSegment.leftVertex.pos:null,p=n==null&&a.handle.rightSegment?.rightVertex?a.handle.rightSegment.rightVertex.pos:null;h&&p?this._moveManipulation.xyAxisManipulation.available=!1:h?l=hs(h,c):p&&(l=hs(c,p))}this._moveManipulation.angle=l,this._moveManipulation.radius=$o}e!==0&&t?(U(i,i,1/e),Lt.spatialReference=this._operations.data.spatialReference,Lt.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(i,Lt),this._moveManipulation.elevationAlignedLocation=Lt):this._outlineVisualElement==null||this.object.isDraped||this._outlineVisualElement.attachmentOrigin==null?Po(this._moveManipulation,this.object):this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin}_removeVertices(i){const e=new Array,t=this._operations;if(t){for(const a of i){const n=a.handle.part;if(a.type==="vertex"&&t.canRemoveVertex(n)){e.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftSegment)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightSegment));const s=t.removeVertices([a.handle]),o=s.removedVertices?.[0].createdSegment;o&&o.type==="line"?this._createVertexOrEdgeManipulator(o):this.enableEdgeOffset&&n.vertices.length<=2&&this._removeManipulator(this._getManipulatorInfoFromHandle(n.segments[0]))}}if(e.length>0){const a=e.map(s=>{const o=t.data.parts.indexOf(s.part);return{coordinates:t.data.coordinateHelper.vectorToArray(s.pos),componentIndex:o,vertexIndex:s.index}}),n=this._updateEventState(2);if(this.destroyed||(this.events.emit("vertex-remove",{type:"vertex-remove",object:this.object,removed:a.map(s=>s.coordinates),vertices:a}),this.destroyed)||n&&(this._updateEventState(0),this.destroyed))return;this._updateMoveManipulationPosition()}}}_moveVertices(i,e,t=e.action==="start"?0:1){const a=this._operations;if(a){i.length>0&&a.moveVertices(i.map(n=>n.handle),e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,t);for(const n of i)this._updateManipulatorPosition(n)}}_offsetEdge(i,e,t){if(!this._operations)return;const a=e.clone();a.distance=t,this._operations.updateVertices([i.handle.leftVertex,i.handle.rightVertex],a),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(i.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(i.handle.rightVertex))}_manipulatorClickCallback(i,e){i.shiftKey||this._clearSelection(),e.type==="vertex"&&(e.manipulator.selected=!e.manipulator.selected,this.enableDeleteVertices&&i.button===rs.Right&&this._removeVertices([e])),e.type==="edge"&&i.button===rs.Left&&this._splitEdgeManipulator(e),i.stopPropagation()}_updateTranslateTooltip(i,e){this._defaultTooltipInfo!=null?this._resetTooltip():this._updateTranslateObjectTooltip(i,e)}_updateTranslateObjectTooltip(i,e){this._pendingEdgeOffsetInfo||(this.activeTooltipInfo=mu(i,e,this._tooltipsContext))}_updateEdgeOffsetTooltip(i){this._pendingEdgeOffsetInfo||(this.activeTooltipInfo=os(this.object,i,this._tooltipsContext))}_resetTooltip(){const i=this.activeTooltipInfo;if(this._pendingEdgeOffsetInfo&&i?.type==="reshape-edge-offset")return;let e=null;e=this._pendingEdgeOffsetInfo||this._findActiveEdgeOffsetManipulatorInfo()!=null?os(this.object,null,this._tooltipsContext):this._defaultTooltipInfo,e!==i&&(i!=null&&e!=null&&this.tooltip.mode==="input"||(this.activeTooltipInfo=e))}get _defaultTooltipInfo(){switch(this._operations?.data.type){case"polyline":case"polygon":return this._selectedVertexManipulatorInfo?this.tooltipInfos.selectedVertex:null;case"point":case"mesh":return this.tooltipInfos.movePoint;default:return null}}get _selectedVertexManipulatorInfo(){const i=this._manipulatorInfos.filter(e=>e.type==="vertex"&&e.manipulator.selected);return i.length===1?i[0]:null}get _tooltipsContext(){const{tooltipInfos:i,activeTooltipInfo:e,automaticAreaMeasurementUtils:t,automaticLengthMeasurementUtils:a}=this;return{sketchOptions:this._sketchOptions,tooltipInfos:i,activeTooltipInfo:e,selectedVertexManipulatorInfo:this._selectedVertexManipulatorInfo,callbacks:this._tooltipCallbacks,automaticAreaMeasurementUtils:t,automaticLengthMeasurementUtils:a}}get test(){}};function vu(){return i=>{const{operation:e,mapEnd:t}=i;return e==null||t==null?i:{...i,signedDistance:e.signedDistanceToPoint(t)}}}function cs(i){const e=i.size/2,t=e+i.collisionPadding;return{size:e/t,outlineSize:(e+i.outlineSize)/t}}function hs(i,e){return Math.atan2(e[1]-i[1],e[0]-i[0])+Math.PI/2}function oa(i){return new me({x:0,y:0,z:0,spatialReference:i})}function ra(i){return i.type==="edge"&&"edgeManipulator"in i}u([d()],I.prototype,"_numGrabbing",void 0),u([d()],I.prototype,"_numDragging",void 0),u([d()],I.prototype,"_pendingEdgeOffsetInfo",void 0),u([d()],I.prototype,"_operations",null),u([d()],I.prototype,"_segmentLabels",void 0),u([d({constructOnly:!0})],I.prototype,"tool",void 0),u([d()],I.prototype,"tooltip",void 0),u([d()],I.prototype,"activeTooltipInfo",void 0),u([d({readOnly:!0})],I.prototype,"updating",null),u([d()],I.prototype,"manipulators",null),u([d()],I.prototype,"view",null),u([d()],I.prototype,"automaticAreaMeasurementUtils",null),u([d()],I.prototype,"automaticLengthMeasurementUtils",null),u([d()],I.prototype,"object",null),u([d()],I.prototype,"enableZShape",null),u([d()],I.prototype,"enableDeleteVertices",null),u([d()],I.prototype,"enableZVertex",null),u([d()],I.prototype,"autoHideManipulators",null),u([d()],I.prototype,"enableMoveObject",null),u([d()],I.prototype,"enableMidpoints",null),u([d()],I.prototype,"enableEdgeOffset",null),u([d()],I.prototype,"_sketchOptions",null),u([d()],I.prototype,"_accentColor",null),u([d()],I.prototype,"_tooltipsContext",null),I=u([H("esri.views.3d.interactive.editingTools.reshape.ReshapeOperation")],I);const Lt=It(0,0,void 0,el.WGS84),hi=M(),us=1e-6,ui=16,kt=32;let z=class extends Fi{constructor(e){super(e),this._reshapeOperation=null,this.events=new ze,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveObject=!0,this.enableDeleteVertices=!0,this.autoHideManipulators=!1,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.sketchOptions=new tt,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const e=this._reshapeOperation=new I({tool:this});this.addHandles([e.events.on("reshape",t=>this.events.emit("reshape",t)),e.events.on("move",t=>this.events.emit("move",t)),e.events.on("vertex-add",t=>this.events.emit("vertex-add",t)),e.events.on("vertex-remove",t=>this.events.emit("vertex-remove",t)),e.events.on("immediate-click",t=>this.events.emit("immediate-click",{...t,object:this.object})),this.view.on("pointer-down",["Shift"],t=>t.stopPropagation())]),this.finishToolCreation()}destroy(){this._reshapeOperation=C(this._reshapeOperation)}get updating(){return((this.object.updating??!1)||this._reshapeOperation?.updating||this.snappingManager?.updating)??!1}get activeTooltipInfo(){return this._reshapeOperation?.activeTooltipInfo??null}get tooltip(){return this._reshapeOperation?.tooltip??null}onManipulatorSelectionChanged(){this._reshapeOperation?.onManipulatorSelectionChanged()}recordUndo(e,t){this._reshapeOperation?.recordUndo({apply:e,undo:t,accumulate:()=>!1})}get canUndo(){return this._reshapeOperation?.canUndo??!1}undo(){this.snappingManager?.doneSnapping(),this._reshapeOperation?.undo()}get canRedo(){return this._reshapeOperation?.canRedo??!1}redo(){this.snappingManager?.doneSnapping(),this._reshapeOperation?.redo()}onInputEvent(e){const t=this._reshapeOperation;t&&!t.enterInputModeIfAvailable(e)&&this.enableDeleteVertices&&e.type==="key-down"&&tl.delete.includes(e.key)&&t.removeSelectedVertices()>0&&e.stopPropagation()}reset(){}};u([d()],z.prototype,"_reshapeOperation",void 0),u([d({constructOnly:!0})],z.prototype,"view",void 0),u([d({constructOnly:!0})],z.prototype,"automaticAreaMeasurementUtils",void 0),u([d({constructOnly:!0})],z.prototype,"automaticLengthMeasurementUtils",void 0),u([d({constructOnly:!0})],z.prototype,"object",void 0),u([d()],z.prototype,"enableZShape",void 0),u([d()],z.prototype,"enableZVertex",void 0),u([d()],z.prototype,"enableMoveObject",void 0),u([d()],z.prototype,"enableDeleteVertices",void 0),u([d()],z.prototype,"autoHideManipulators",void 0),u([d()],z.prototype,"enableMidpoints",void 0),u([d()],z.prototype,"enableEdgeOffset",void 0),u([d()],z.prototype,"type",void 0),u([d({type:tt})],z.prototype,"sketchOptions",void 0),u([d()],z.prototype,"snappingManager",void 0),u([d()],z.prototype,"updating",null),u([d()],z.prototype,"activeTooltipInfo",null),u([d()],z.prototype,"tooltip",null),u([d()],z.prototype,"automaticManipulatorSelection",void 0),z=u([H("esri.views.3d.interactive.editingTools.reshape.ReshapeTool3D")],z);let oe=class extends et{constructor(e){super(e),this._interactionState=null}initialize(){this.addHandles([Dt(()=>{const e=this._interactionState;return e&&e.angle!==e.previousAngle?{interactionState:e,angle:e.state.angle}:null},({interactionState:e})=>{this._updateMeshRotation(e)},Et),Dt(()=>{const e=this._interactionState;return e&&e.scale!==e.previousScale?{interactionState:e,scale:e.state.scale}:null},({interactionState:e})=>{this._updateMeshSize(e)},Et)])}get geometry(){const e=k(this.object);return e?.type==="mesh"?e:null}get initialAngle(){return this._interactionState?.initialAngle??0}get angle(){const e=this.geometry?.transform;if(e==null)return this._interactionState?.angle??0;const t=Oc(e.rotation)[2];return Math.abs(t)>.999999?Qe($c(e.rotation))*Math.sign(t):0}get angleClockwise(){return-this.angle}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){return this._interactionState?.scale??1}startInteraction(){const e=new Ee({angle:this.angle});this._interactionState=e;const t=()=>{this._interactionState=null};return{state:e,done:t,cancel:()=>{e.cancel(),t()}}}createUndoRecord(){return this.object.createUndoRecord()}_updateMeshRotation(e){const{geometry:t}=this;if(t==null)return;const{angle:a,previousAngle:n}=e;e.previousAngle=a;const s=qt(a-n);t.rotate(0,0,s)}_updateMeshSize(e){const{geometry:t}=this;if(t==null)return;const{scale:a,previousScale:n}=e;e.previousScale=a;const s=a/n;t.scale(s)}};u([d({constructOnly:!0})],oe.prototype,"object",void 0),u([d()],oe.prototype,"geometry",null),u([d({constructOnly:!0})],oe.prototype,"viewingMode",void 0),u([d()],oe.prototype,"initialAngle",null),u([d()],oe.prototype,"angle",null),u([d()],oe.prototype,"angleClockwise",null),u([d()],oe.prototype,"relativeAngle",null),u([d()],oe.prototype,"relativeAngleClockwise",null),u([d()],oe.prototype,"scale",null),u([d()],oe.prototype,"_interactionState",void 0),oe=u([H("esri.views.3d.interactive.editingTools.transform.ScaleRotateMeshAdapter")],oe);let Ee=class extends et{get state(){const{angle:e,scale:t}=this;return{angle:e,scale:t}}constructor(e){super(e),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=e.angle,this.previousAngle=e.angle}cancel(){this.angle=this.initialAngle,this.scale=1}};u([d()],Ee.prototype,"angle",void 0),u([d()],Ee.prototype,"initialAngle",void 0),u([d()],Ee.prototype,"previousAngle",void 0),u([d()],Ee.prototype,"previousScale",void 0),u([d()],Ee.prototype,"scale",void 0),u([d()],Ee.prototype,"state",null),Ee=u([H("esri.views.3d.interactive.editingTools.transform.ScaleRotateMeshAdapter.InteractionState")],Ee);let G=class extends et{constructor(e){super(e),this.sizeAxis=null,this._interactionState=null}initialize(){this.addHandles(Dt(()=>this._interactionState!=null?this._interactionState.state:null,e=>{this._updateSymbol(e)},Et))}get initialAngle(){return this._interactionState?.initialAngle??0}get angle(){return this._interactionState!=null?this._interactionState.angle:this._orientationReferenceSymbolLayer!=null?bu(this._orientationReferenceSymbolLayer.heading??0):0}get angleClockwise(){return-this.angle}get orientation(){return this.angle}get orientationClockwise(){return this.angleClockwise}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){return this._interactionState?.scale??1}get size(){const e=this._sizeReferenceSymbolLayer;if(e==null)return null;const t=this.findLayerView(),a=this._graphicSymbol;if(t==null||a==null||a.type!=="point-3d")return null;const n=t.getSymbolLayerSize(a,e);if("size"in n&&n.size!=null)return n.size;const s=this.sizeAxis;return!("width"in n)||n.width==null||s!=null&&s!=="width"&&s!=="all"&&s!=="width-and-depth"?!("depth"in n)||e.depth==null||s!=null&&s!=="depth"&&s!=="all"&&s!=="width-and-depth"?!("height"in n)||e.height==null||s!=null&&s!=="height"&&s!=="all"?null:n.height:n.depth:n.width}get _sizeReferenceSymbolLayer(){const e=this._graphicSymbol;return e==null||e.symbolLayers.length===0?null:e.symbolLayers.find(t=>t.type==="object")}get _orientationReferenceSymbolLayer(){const e=this._graphicSymbol;return e==null||e.symbolLayers.length===0?null:e.symbolLayers.find(t=>t.type==="object"&&t.heading!=null)}get _graphicSymbol(){return this.graphic?.symbol!=null&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:null}set _graphicSymbol(e){this.graphic.symbol=e}startInteraction(){const e=this._graphicSymbol,t=this.findLayerView();if(this._interactionState!=null||e==null||t==null)return yu;const a=e.symbolLayers.map(l=>l.type==="object"?t.getSymbolLayerSize(e,l):null).toArray(),n=e.clone(),s=this.angle,o=new je({originalSymbol:n,angle:s,initialSizes:a});this._interactionState=o;const r=()=>{this._interactionState=null};return{state:o,done:r,cancel:()=>{this._graphicSymbol=n,r()}}}createUndoRecord(){let e=this.graphic.symbol,t=null;return{undo:a=>{t=a.symbol,a.symbol=e},redo:a=>{e=a.symbol,a.symbol=t}}}_updateSymbol({scale:e,angle:t,originalSymbol:a,initialSizes:n}){const s=this._graphicSymbol;if(s==null||s.type!=="point-3d")return;const o=s.clone(),r=-qt(t-this.initialAngle);let l=!1;this._forEachObjectSymbolLayerPair(a,o,(c,h,p)=>{const g=(c.heading??0)+r;h.heading!==g&&(h.heading=g,l=!0);const _=n[p];if(_!=null&&"width"in _){_.width=this.sizeFilter(_.width),_.height=this.sizeFilter(_.height),_.depth=this.sizeFilter(_.depth);const f=_.width*e;h.width!==f&&(h.width=f,l=!0);const m=_.depth*e;h.depth!==m&&(h.depth=m,l=!0);const y=_.height*e;h.height!==y&&(h.height=y,l=!0)}}),l&&(this._graphicSymbol=o)}_forEachObjectSymbolLayerPair(e,t,a){e.symbolLayers.forEach((n,s)=>{const o=t.symbolLayers.at(s);n.type==="object"&&o.type==="object"&&a(n,o,s)})}};function bu(i){return-Qe(i)}u([d()],G.prototype,"initialAngle",null),u([d()],G.prototype,"angle",null),u([d()],G.prototype,"angleClockwise",null),u([d()],G.prototype,"orientation",null),u([d()],G.prototype,"orientationClockwise",null),u([d()],G.prototype,"relativeAngle",null),u([d()],G.prototype,"relativeAngleClockwise",null),u([d()],G.prototype,"scale",null),u([d()],G.prototype,"size",null),u([d()],G.prototype,"sizeAxis",void 0),u([d({constructOnly:!0})],G.prototype,"graphic",void 0),u([d()],G.prototype,"_interactionState",void 0),u([d({constructOnly:!0})],G.prototype,"findLayerView",void 0),u([d({constructOnly:!0})],G.prototype,"sizeFilter",void 0),u([d()],G.prototype,"_sizeReferenceSymbolLayer",null),u([d()],G.prototype,"_orientationReferenceSymbolLayer",null),u([d()],G.prototype,"_graphicSymbol",null),G=u([H("esri.views.3d.interactive.editingTools.transform.ScaleRotateObjectSymbol3DAdapter")],G);const yu={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let je=class extends et{get state(){const{originalSymbol:e,angle:t,initialAngle:a,scale:n,initialSizes:s}=this;return{originalSymbol:e,angle:t,initialAngle:a,scale:n,initialSizes:s}}constructor(e){super(e),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=e.angle}};u([d()],je.prototype,"originalSymbol",void 0),u([d()],je.prototype,"angle",void 0),u([d()],je.prototype,"initialAngle",void 0),u([d()],je.prototype,"initialSizes",void 0),u([d()],je.prototype,"scale",void 0),u([d()],je.prototype,"state",null),je=u([H("esri.views.3d.interactive.editingTools.transform.ScaleRotateObjectSymbol3DAdapter.InteractionState")],je);const E={ScaleIn:32,ScaleOut:64,RotateLeft:128,RotateRight:256,Unlocked:1024,DelayedFocused:2048};let Te=class extends et{get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(i){this._ringManipulator.location=i}set elevationAlignedLocation(i){this._ringManipulator.elevationAlignedLocation=i}get grabbing(){return this._ringManipulator.grabbing}set interactive(i){this._ringManipulator.interactive=i}get updating(){return!!this._activeAnimation}constructor(i){super(i),this.mode=null,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=Vh,this.events=new ze,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>this._scaleRotateDragData?.mode==="scale"?this.adapter.scale:1}initialize(){this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this.addHandles([w(()=>{const{adapter:i}=this;return[i.angle,i.scale]},()=>this._updateManipulatorTransform())])}destroy(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=null,this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null}startAnimation(i){this.cancelActiveAnimation(),i.start();const e=il({update:({deltaTime:t})=>{i.update(t)&&this.cancelActiveAnimation()}});this._activeAnimation={...i,frameTask:e}}cancelActiveAnimation(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=C(this._activeAnimation)}forEachManipulator(i){i(this._ringManipulator,4)}_createManipulator(){const i=this._createRingManipulator();this._ringManipulator=i,this.tool.manipulators.add(i);const e=this.tool.object,t=ye(i,(a,n,s)=>{this._scaleRotateDragData=null;const o=this.adapter.startInteraction(),r={mode:"none",origin:Zt(a.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=r,this._updateDragState();const l=b.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(a.renderLocation,l),n.next(Bi(this.tool.view,dt(a.renderLocation,l,Kt()))).next(c=>{const h=gt(c.plane),p=Ro(c.renderStart,c.renderEnd,r.origin,h),g=al.shortestSignedDiff(r.angle,p);r.angleDir=bi(r.angleDir+g,-.3,Gh),r.angle=p;const _=Mu(r,c),f=_-this.adapter.scale;if(r.scaleDir=bi(r.scaleDir+f,-.2,Hh),this._onScaleChanged(),r.mode==="none"){const m=this.mode||wu(c,c.plane,r.origin,this.tool.view.state.camera);if(m!=null){switch(m){case"rotate":this.tool.events.emit("rotate-start",{object:e,angle:0}),this.tool.events.emit("record-undo",{updates:[this.adapter.createUndoRecord()]});break;case"scale":this.tool.events.emit("scale-start",{object:e,xScale:1,yScale:1}),this.tool.events.emit("record-undo",{updates:[this.adapter.createUndoRecord()]})}r.mode=m}}switch(r.mode){case"rotate":o.state.angle=r.initialAngle+p;break;case"scale":o.state.scale=_,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),c.action){case"start":case"update":switch(r.mode){case"rotate":this.tool.events.emit("rotate",{object:e,angle:qt(r.angle)});break;case"scale":this.tool.events.emit("scale",{object:e,xScale:_,yScale:_})}break;case"end":switch(r.mode){case"rotate":this.tool.events.emit("rotate-stop",{object:e,angle:qt(r.angle)});break;case"scale":this.tool.events.emit("scale-stop",{object:e,xScale:_,yScale:_})}}return c.action==="end"&&(this.startAnimation(ds(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),o.done()),c}),s.next(()=>{if(o.cancel(),this._scaleRotateDragData!=null){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.events.emit("rotate-stop",{object:e,angle:0});break;case"scale":this.tool.events.emit("scale-stop",{object:e,xScale:1,yScale:1})}this.startAnimation(ds(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}})});this.addHandles([t,i.events.on("focus-changed",a=>{a.action==="focus"?this.startAnimation(xu(this,()=>this._updateDelayedFocusedState(),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()}),i.events.on("immediate-click",a=>{a.stopPropagation()}),w(()=>this.tool.object.visible,a=>this._ringManipulator.available=a,A)])}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(E.DelayedFocused,this.getFocused())}_updateDragState(){if(this._ringManipulator.updateStateEnabled(E.Unlocked,!(this._scaleRotateDragData!=null&&this._scaleRotateDragData?.mode!=="none")),this._scaleRotateDragData!=null)switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(E.ScaleIn|E.ScaleOut,!1),this._ringManipulator.updateStateEnabled(E.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(E.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(E.RotateLeft|E.RotateRight,!1),this._ringManipulator.updateStateEnabled(E.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(E.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(E.ScaleIn|E.ScaleOut|E.RotateLeft|E.RotateRight,!1)}_updateManipulatorTransform(){const i=Rs(q.get(),this.adapter.angle,R(0,0,1));if(i==null)return;const e=this.getScale(),t=Si(q.get(),B(b.get(),e,e,e));this._ringManipulator.modelTransform=Re(q.get(),t,i)}_createRingManipulator(){const i=(O,V,Q)=>{const Ce=[],Le=Math.ceil(So*(V-O)/(2*Math.PI));for(let X=0;X<Le+1;X++){const At=O+X*(V-O)/Le;Ce.push(R(Q*Math.cos(At),Q*Math.sin(At),0))}return Ce},e=O=>i(0,2*Math.PI,O),t=O=>[[-O/2,0],[O/2,0],[O/2,ea/2],[-O/2,ea/2]],a=this._createMaterial(1),n=(O,V,Q=a)=>Us(Q,t(V),O,[],[],!1),s=e(lt),o=n(s,ta),r={left:new Array,right:new Array},l=[];for(let O=0;O<2;O++){const V=O*Math.PI-Math.PI/4,Q=Math.PI/2-Lh,Ce=V+Q,Le=V+Math.PI/2-Q,X=i(Ce,Le,Ph),At=n(X,bt);l.push(X),l.push(i(Ce,Le,Bn-ta/2)),r.left.push(At),r.right.push(At.instantiate());for(let Yi=0;Yi<2;Yi++){const Na=Yi===0,se=le();if(Na){Yt(se,se,[1,-1,1]),on(se,se,-Ce,[0,0,1]);const it=Math.round(Wn*(X.length-1));se[12]=X[it][0],se[13]=X[it][1],se[14]=X[it][2]}else{on(se,se,Le,[0,0,1]);const it=Math.round((1-Wn)*(X.length-1));se[12]=X[it][0],se[13]=X[it][1],se[14]=X[it][2]}const Wa=Ti(a,zh,0,Ch,ea);Fs(Wa,se),(Na?r.left:r.right).push(Wa)}}const c=[];for(let O=0;O<2;O++){const V=O*Math.PI-Math.PI/4,Q=Math.PI/2-kh,Ce=V+Q,Le=V+Math.PI/2-Q,X=i(Ce,Le,Bn);c.push(n(X,bt))}const h=this._createMaterial(.66),p=this._createMaterial(.5),g=this._createMaterial(.33),_=e(lt+Yn),f=e(lt+qn),m=n(_,bt,h),y=n(f,bt,g),v=e(lt-Yn),S=e(lt-qn),j=n(v,bt,h),T=n(S,bt,g);let D=[new x(o,E.DelayedFocused),new x(o.instantiate({material:p}),0)];this.mode&&this.mode!=="scale"||(D=D.concat([...c.map(O=>new x(O,E.DelayedFocused|E.Unlocked)),new x(m,E.DelayedFocused|E.ScaleIn),new x(y,E.DelayedFocused|E.ScaleIn),new x(j,E.DelayedFocused|E.ScaleOut),new x(T,E.DelayedFocused|E.ScaleOut)])),this.mode&&this.mode!=="rotate"||(D=D.concat([...r.right.map(O=>new x(O.instantiate(),E.DelayedFocused|E.Unlocked)),...r.left.map(O=>new x(O,E.DelayedFocused|E.RotateLeft)),...r.right.map(O=>new x(O,E.DelayedFocused|E.RotateRight))]));const W=[s,...l];return new ee({view:this.tool.view,renderObjects:D,autoScaleRenderObjects:!1,worldOriented:!0,radius:ta,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:this.tool.object.elevationInfo,collisionType:{type:"ribbon",paths:W,direction:R(0,0,1)}})}_createMaterial(i){const e=new fe({cullFace:2,renderOccluded:2,isDecoration:!0});return this.addHandles(w(()=>gl(this.tool.view.effectiveTheme.accentColor,i),t=>e.setParameters({color:t}),A)),e}get test(){}};function Mu(i,e){const t=$(b.get(),e.renderStart,i.origin),a=$(b.get(),e.renderEnd,i.origin),n=$e(t),s=$e(a);return n===0?0:s/n}function wu(i,e,t,a){const{renderStart:n,renderEnd:s}=i,o=di(n,a,b.get()),r=di(s,a,b.get());if(Ds(o,r)<Nn*Nn)return null;const l=$(b.get(),n,t),c=de(b.get(),l,gt(e)),h=n,p=P(b.get(),h,c),g=di(t,a,b.get()),_=o,f=di(p,a,b.get()),m=$(b.get(),f,_),y=$(b.get(),o,g),v=rn(_,m),S=rn(g,y);return ln(v,r)<ln(S,r)?"rotate":"scale"}function di(i,e,t){return e.projectToScreen(i,la),B(t,la[0],la[1],0)}function ds(i,e){let t=null,a=1;const n=()=>a;return{start:()=>{a=i.getScale(),t=i.getScale,i.getScale=n,e()},update:s=>(a+=((a+1)/2-a)*Math.min(s*Fh,1),e(),Math.abs(a-1)<.01?1:0),destroy:()=>{t&&(i.getScale=t),e()}}}function xu(i,e,t){let a=0,n=null;const s=()=>!1;return{start:()=>{n=i.getFocused,i.getFocused=s,a=0,e()},update:o=>(a+=o,!n?.()||a>=t.delayMs?1:0),destroy:()=>{n&&(i.getFocused=n),e()}}}u([d({constructOnly:!0})],Te.prototype,"tool",void 0),u([d({constructOnly:!0})],Te.prototype,"adapter",void 0),u([d({constructOnly:!0})],Te.prototype,"sketchOptions",void 0),u([d()],Te.prototype,"mode",void 0),u([d()],Te.prototype,"_activeAnimation",void 0),u([d()],Te.prototype,"updating",null),Te=u([H("esri.views.3d.interactive.editingTools.transform.ScaleRotateTransform")],Te);const la=Me();let Vt=class extends so(ei){constructor(e){super(e),this.type="transform-mesh",this.orientation=oo(),this.scale=ic(),this.allFields.forEach(t=>{t.lockable=!1,t.setActual(null)})}get key(){return{longitude:this.longitude.actual,latitude:this.latitude.actual,x:this.x.actual,y:this.y.actual,elevation:this.elevation.actual,geographic:this.geographic,orientation:this.orientation.actual,scale:this.scale.actual}}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation,this.orientation,this.scale]}};u([d()],Vt.prototype,"key",null),u([d()],Vt.prototype,"allFields",null),Vt=u([H("esri.views.interactive.tooltip.infos.TransformMeshTooltipInfo")],Vt);let gi=class extends so(ei){constructor(i){super(i),this.type="transform-point",this.orientation=oo({readOnly:!0}),this.size=ac({readOnly:!0}),this.allFields.forEach(e=>{e.lockable=!1,e.setActual(null)})}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation,this.orientation,this.size]}};u([d()],gi.prototype,"allFields",null),gi=u([H("esri.views.interactive.tooltip.infos.TransformPointTooltipInfo")],gi);let ae=class extends Fi{constructor(i){super(i),this.events=new ze,this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.sketchOptions=new tt,this.type="transform-3d",this._updatingHandles=new ki,this._scaleRotate=null}initialize(){const{events:i,object:e,view:t}=this;this.tooltip=Hi(()=>({view:t,options:this.sketchOptions.tooltips})),this._moveManipulation=new ut({tool:this,view:t,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&ht(e.operations,e.elevationInfo),radius:ut.radiusForSymbol(e.graphic?.symbol)}),this._moveManipulation.forEachManipulator(l=>this.addHandles(l.events.on("immediate-click",c=>{i.emit("immediate-click",{...c,object:this.object}),c.stopPropagation()})));const a=e.elevationInfo;if(this._moveManipulation.elevationInfo=a,this.addHandles(Fa(e)),this._moveManipulation.createManipulatedObjectDragPipeline((l,c,h,p,g)=>{if(l===0){const{snappingStep:_,cancelSnapping:f}=Ai({snappingContext:new Ri({elevationInfo:a,pointer:g,editGeometryOperations:Ha.fromGeometry(new me({spatialReference:e.operations?.data.spatialReference}),t.state.viewingMode),visualizer:new Xt,excludeFeature:e.graphic}),snappingManager:this.snappingManager,updatingHandles:this._updatingHandles,useZ:!1});p=p.next(f),h=h.next(vc(this.view,a)).next(..._)}return{steps:h,cancel:p}},e,l=>{const{action:c,object:h,dxScreen:p,dyScreen:g}=l,_={object:h,dxScreen:p,dyScreen:g};switch(c){case"start":this._emitRecordUndo(),i.emit("translate-start",_);break;case"update":i.emit("translate",_);break;case"end":i.emit("translate-stop",_)}}),this._moveManipulation.angle=this._scaleRotate!=null?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.addHandles(w(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const l=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new Te({tool:this,mode:l,adapter:this._scaleRotateAdapter,sketchOptions:this.sketchOptions}),this.addHandles(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.addHandles([Zi({view:this.view,object:e,forEachManipulator:l=>this._forEachManipulator(l),onManipulatorsChanged:()=>L()}),e.on("committed",()=>this._onGeometryChanged()),this._hideManipulatorsForObjectState(),w(()=>t.scale,()=>this._updateMoveAngle())].filter(zs)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(l=>{l instanceof ee&&this.addHandles(l.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))});const n=t?.type,{sketchOptions:s}=this;this._meshTooltipInfo=new Vt({viewType:n,sketchOptions:s}),this._pointTooltipInfo=new gi({viewType:n,sketchOptions:s});const o={object:e,dxScreen:0,dyScreen:0},r={onBeforeUpdate:()=>this.endDrag(),onMoveStart:()=>{this._emitRecordUndo(),i.emit("translate-start",{...o})},onMove:()=>i.emit("translate",{...o}),onMoveStop:()=>i.emit("translate-stop",{...o}),onRotateStart:l=>{this._emitRecordUndo(),i.emit("rotate-start",{object:e,angle:l})},onRotate:l=>i.emit("rotate",{object:e,angle:l}),onRotateStop:l=>i.emit("rotate-stop",{object:e,angle:l}),onScaleStart:(l,c)=>{this._emitRecordUndo(),i.emit("scale-start",{object:e,xScale:l,yScale:c})},onScale:(l,c)=>i.emit("scale",{object:e,xScale:l,yScale:c}),onScaleStop:(l,c)=>i.emit("scale-stop",{object:e,xScale:l,yScale:c})};this.addHandles(bo(this.tooltip,this.object,()=>({sketchOptions:this.sketchOptions,activeTooltipInfo:this.activeTooltipInfo,callbacks:r,scaleRotateTransform:this._scaleRotate}))),this.finishToolCreation()}destroy(){this.tooltip.destroy(),this._moveManipulation.destroy(),this._scaleRotate=C(this._scaleRotate),this._scaleRotateAdapter=C(this._scaleRotateAdapter),this._updatingHandles.destroy(),this._set("view",null),this._set("object",null)}onInputEvent(i){if(!this.destroyed&&!Di(i,this.tooltip))return super.onInputEvent(i)}_updateManipulatorsInteractive(){this._scaleRotate!=null&&(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return k(this.object)?.type==="mesh"?new oe({object:this.object,viewingMode:this.view.state.viewingMode}):new G({graphic:this.object.graphic,sizeFilter:e=>this._enforceNonZeroSize(e),findLayerView:()=>this.view.allLayerViews.find(e=>e.layer===this.object.graphic?.layer),sizeAxis:this.sketchOptions?.tooltips?.visualVariables?.size?.axis??null})}_forEachManipulator(i){this._moveManipulation?.forEachManipulator(i),this._scaleRotate?.forEachManipulator(i)}_hideManipulatorsForObjectState(){return w(()=>this.object.visible,i=>{this._forEachManipulator(e=>e.available=i),this._moveManipulation.zManipulation.available=i&&this.enableZ&&ht(this.object.operations,this.object.elevationInfo)})}_emitRecordUndo(){this.events.emit("record-undo",{updates:[this.object.createUndoRecord()]})}set snapToScene(i){this._moveManipulation&&(this._moveManipulation.snapToScene=i),this._set("snapToScene",i)}get updating(){return this._updatingHandles.updating||!!this._scaleRotate?.updating}get activeTooltipInfo(){return k(this.object)?.type==="mesh"?this._meshTooltipInfo:this._pointTooltipInfo}set location(i){this._moveManipulation.location=i,this._scaleRotate&&(this._scaleRotate.location=i)}set elevationAlignedLocation(i){this._moveManipulation.elevationAlignedLocation=i,this._scaleRotate&&(this._scaleRotate.elevationAlignedLocation=i)}reset(){}onHide(){this._scaleRotate?.cancelActiveAnimation()}_onScaleChanged(){this._scaleRotate!=null&&(this._moveManipulation.displayScale=this._scaleRotate.getScale())}_updateMoveAngle(){const{view:i}=this,e=i.state.viewingMode===2||i.scale<Uh;this._moveManipulation.angle=e?this._scaleRotateAdapter.angle:0}_onGeometryChanged(){Po(this,this.object)}_enforceNonZeroSize(i){return i||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}get test(){}};u([d({constructOnly:!0,nonNullable:!0})],ae.prototype,"view",void 0),u([d({constructOnly:!0,nonNullable:!0})],ae.prototype,"object",void 0),u([d({constructOnly:!0,nonNullable:!0})],ae.prototype,"enableZ",void 0),u([d()],ae.prototype,"enableRotation",void 0),u([d()],ae.prototype,"enableScaling",void 0),u([d({constructOnly:!0,type:tt})],ae.prototype,"sketchOptions",void 0),u([d({value:!1})],ae.prototype,"snapToScene",null),u([d({constructOnly:!0})],ae.prototype,"snappingManager",void 0),u([d({readOnly:!0})],ae.prototype,"type",void 0),u([d({readOnly:!0})],ae.prototype,"updating",null),u([d()],ae.prototype,"activeTooltipInfo",null),ae=u([H("esri.views.3d.interactive.editingTools.transform.TransformTool3D")],ae);let Fe=class extends nl(sl){constructor(e){super(e),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}equals(e){return this.heading===e.heading&&this.tilt===e.tilt&&this.width===e.width&&this.height===e.height&&ol(this.position,e.position)}};u([d({type:["plane"],readOnly:!0,json:{read:!1,write:{isRequired:!0}}})],Fe.prototype,"type",void 0),u([d({type:me,json:{write:{isRequired:!0}}})],Fe.prototype,"position",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:360},json:{write:{isRequired:!0}}}),cn(i=>hn.normalize(un(i),0,!0))],Fe.prototype,"heading",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:360},json:{write:{isRequired:!0}}}),cn(i=>hn.normalize(un(i),0,!0))],Fe.prototype,"tilt",void 0),u([d({type:Number,nonNullable:!0,range:{min:0},json:{write:{isRequired:!0}}})],Fe.prototype,"width",void 0),u([d({type:Number,nonNullable:!0,range:{min:0},json:{write:{isRequired:!0}}})],Fe.prototype,"height",void 0),Fe=u([H("esri.analysis.SlicePlane")],Fe);Ps("mac");const Su=2,Ou=1.15,$u=1.15,Du=3,zo=11,$a=22.5,ca=40,ps=48,Eu=2.25,ju=4,gs=1,Tu=.3,Iu=6,Ru=4;function Au(i){const e=new Va,{vertex:t,fragment:a,attributes:n,varyings:s}=e;return La(t,i),n.add("position","vec3"),n.add("uv0","vec2"),s.add("vUV","vec2"),t.main.add(ue`vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);`),a.uniforms.add(new Ii("backgroundColor",o=>o.backgroundColor),new Ii("gridColor",o=>o.gridColor),new Ca("gridWidth",o=>o.gridWidth)).main.add(ue`const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
fragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;`),e}Object.freeze(Object.defineProperty({__proto__:null,build:Au},Symbol.toStringTag,{value:"Module"}));function Pu(i,e){return Ao(i.basis1,i.basis2,i.origin,e)}function zu(i,e,t,a){const n=e.worldUpAtPosition(i.origin,b.get()),s=b.get();switch(t){case 1:Z(s,n);break;case 2:Z(s,i.basis1)}return dt(i.origin,s,a)}function Cu(i,e,t,a){const n=$e(a.basis1),s=$e(a.basis2),o=Co(a),r=Da(a),l=B(b.get(),0,0,0);P(l,U(b.get(),a.basis1,e.direction[0]),U(b.get(),a.basis2,e.direction[1])),P(l,a.origin,l);let c=0,h=1;if(Wi(e))e.direction[0]===1&&e.direction[1]===-1?c=_s:e.direction[0]===1&&e.direction[1]===1?c=Math.PI:e.direction[0]===-1&&e.direction[1]===1&&(c=3*Math.PI/2),h=r;else{const g=e.direction[0]!==0?1:2;c=g===1?_s:0,h=(g===1?s:n)-o}const p=Is(q.get(),c);Yt(p,p,B(b.get(),h,h,h)),Re(p,t,p),p[12]=0,p[13]=0,p[14]=0,i.modelTransform=p,i.renderLocation=l}function Co(i){const e=$e(i.basis1),t=$e(i.basis2);return Tu*Math.min(e,t)}function Da(i){return Co(i)}function Wi(i){return i.direction[0]!==0&&i.direction[1]!==0}const Be=16,Ea=32;Qt();const _s=Math.PI/2,_i=16,Lo=32;let Lu=class extends ee{constructor(e,t){const a=new be({width:1,renderOccluded:4,isDecoration:!0},e.state.isGlobal),n=new fe({cullFace:2,renderOccluded:16,isDecoration:!0}),s=new fe({cullFace:2,renderOccluded:16,isDecoration:!0}),o=new fe({cullFace:2,renderOccluded:16,isDecoration:!0}),r=new fe({writeDepth:!1,cullFace:1,renderOccluded:2,isDecoration:!0});super({view:e,...ku({offsetMode:t,tubeMaterial:n,tipMaterial:s,capMaterial:o,outlineMaterial:r,calloutMaterial:a})}),this._themeHandle=w(()=>e.effectiveTheme.accentColor,l=>{const c=$i(l),h=J.toUnitRGBA(l),p=J.toUnitRGBA(c),g=J.toUnitRGBA(J.blendColors(c,l,.4)),_=J.toUnitRGBA(J.blendColors(c,l,.14));a.setParameters({color:h}),n.setParameters({color:_}),s.setParameters({color:p}),o.setParameters({color:g}),r.setParameters({color:h})},A)}destroy(){this._themeHandle.remove(),super.destroy()}};function ku({offsetMode:i,tubeMaterial:e,tipMaterial:t,capMaterial:a,outlineMaterial:n,calloutMaterial:s}){const o=i===0?ca:0,r=[R(o,0,-ps/2),R(o,0,ps/2)],l=Gu(r),c=fs({vertices:r,padding:0,materials:{tube:e,tip:t,cap:a}}),h=fs({vertices:r,padding:Eu,materials:{tube:n,tip:n,cap:n}}),p=ve(s,[[o,0,0],[o-ca,0,0]]),g=ve(s,[[o,0,0],[o-ca,0,0]]);return{renderObjects:[...c.normal.map(_=>new x(_,1|Be)),...h.normal.map(_=>new x(_,1|Be)),new x(p,1|Be|Ea),...c.focused.map(_=>new x(_,2|Be)),...h.focused.map(_=>new x(_,2|Be)),new x(g,2|Be|Ea)],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[l]},collisionPriority:1,radius:zo,state:Be}}function fs({vertices:i,padding:e,materials:t}){const a=n=>{const s=i.slice(),o=$(b.get(),s[0],s[1]);te(o,o);const r=$(b.get(),s[s.length-1],s[s.length-2]);if(te(r,r),e>0){const O=U(M(),r,-e);s[s.length-1]=P(O,O,s[s.length-1]);const V=U(M(),o,-e);s[0]=P(V,V,s[0])}const l=n?$u:1,c=$a*l,h=zo*l,p=ma(q.get());if(e>0){const O=c/4,V=B(b.get(),0,O,0),Q=1+e/O;va(p,p,V),Yt(p,p,B(b.get(),Q,Q,Q)),va(p,p,U(V,V,-1/Q))}const g=ma(le()),_=R(0,1,0),f=dn(le(),pn(gn.get(),_,r));f[12]=s[s.length-1][0],f[13]=s[s.length-1][1],f[14]=s[s.length-1][2],Re(f,f,p);const m=t.tube,y=Hu(Du*(n?Ou:1)+e,s,m);y.transformation=g;const v=[y],S=t.tip,j=ya(S,c,h,24,!1,!1,!0);j.transformation=f,v.push(j);const T=t.cap,D=ya(T,c,h,24,!1,!0,!1);D.transformation=f,v.push(D);const W=dn(le(),pn(gn.get(),_,o));return W[12]=s[0][0],W[13]=s[0][1],W[14]=s[0][2],Re(W,W,p),v.push(j.instantiate({transformation:W})),v.push(D.instantiate({transformation:W})),v};return{normal:a(!1),focused:a(!0)}}function Hu(i,e,t){const a=[];for(let s=0;s<12;s++){const o=s/12*2*Math.PI;a.push([Math.cos(o)*i,Math.sin(o)*i])}return Us(t,a,e,[],[],!1)}function Gu(i,e){const t=$(M(),i[i.length-1],i[i.length-2]);te(t,t),U(t,t,$a),P(t,t,i[i.length-1]);{const a=$(M(),i[0],i[1]);return te(a,a),U(a,a,$a),P(a,a,i[0]),[a,...i,t]}}let Vu=class{get _object(){return this._tool.object}get _operations(){return this._object.operations}constructor(e,t,a){this._tool=e,this._bounds=t,this._automaticLengthMeasurementUtils=a,this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null;const n=this._tool,s=n.view;this.moveXYObjectManipulation=new Ba({view:s,tool:n,object:this._object}),n.addHandles(this._createMoveXYObjectDragPipeline()),this.moveZManipulator=new Lu(s,0),this.moveZManipulator.state|=Ea,n.manipulators.add(this.moveZManipulator),n.addHandles(this._createMoveZDragPipeline()),n.addHandles(n.events.on("translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null}))}destroy(){this.moveXYObjectManipulation.destroy(),this._tool.manipulators.remove(this.moveZManipulator),this.moveZManipulator.destroy()}forEachManipulator(e){this.moveXYObjectManipulation.forEachManipulator(e),e(this.moveZManipulator,0)}updateManipulators(e,t){const a=this.moveZManipulator,n=rl(q.get(),e,Math.PI);n[12]=0,n[13]=0,n[14]=0,a.modelTransform=n,a.renderLocation=$(b.get(),t.origin,t.basis1)}getUpdatedTooltipInfo(){return this.moveXYObjectManipulation.grabbing||this.moveXYObjectManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():null}_computeMoveXYTooltipInfo(){const e=this._tool,t=this._moveXYTooltipInfo??=new Ga({sketchOptions:e.sketchOptions});if(this.moveXYObjectManipulation.dragging){const a=this._bounds,n=a.mapBoundsStart.origin,s=a.mapBounds.origin,{renderSpatialReference:o}=e.view;if(!o)return null;const r=this._automaticLengthMeasurementUtils.autoDistance2D(n,s,o);if(r==null)return null;t.distance=r}else t.distance=we;return t}_computeMoveZTooltipInfo(){const e=this._tool,t=this._moveZTooltipInfo??=new ct({sketchOptions:e.sketchOptions});if(this.moveZManipulator.dragging){const a=this._bounds,n=a.mapBoundsStart.origin,s=a.mapBounds.origin,{renderSpatialReference:o}=e.view;if(!o)return null;const r=ll(n,s,o);if(r==null)return null;t.distance=r}else t.distance=we;return t}_createMoveXYObjectDragPipeline(){return this.moveXYObjectManipulation.createDragPipeline((e,t,a)=>this._buildMoveDragPipeline(t,a))}_createMoveZDragPipeline(){if(!this._operations)return L();const e=this._operations.data.spatialReference;return ye(this.moveZManipulator,(t,a,n)=>{const s=Zt(t.renderLocation),o=a.next(Eo(this._tool.view,s,e)).next(Rt());this._buildMoveDragPipeline(o,n)})}_buildMoveDragPipeline(e,t){const{_tool:a,_object:n}=this;e.next(s=>(s.action==="start"&&(a.inputState={type:"move"},this._bounds.backupMapBounds(),a.events.emit("translate-start",{object:n,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY})),s)).next(xt()).next(this._updateGeometry()).next(s=>{const o={object:n,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY};switch(s.action){case"start":case"update":(s.mapEnd.x-s.mapStart.x||s.mapEnd.y-s.mapStart.y||(s.mapEnd.z??0)-(s.mapStart.z??0))&&a.events.emit("translate",o);break;case"end":a.inputState=null,a.events.emit("translate-stop",o)}return s}),t.next(()=>{a.inputState!=null&&a.events.emit("translate-stop",{object:n,dxScreen:0,dyScreen:0}),a.cancelDrag()})}_updateGeometry(){const e=this._tool;return t=>{if(e.inputState==null||e.inputState.type!=="move")return t;const a=t.action==="start"?0:1;if(this._operations){const n=this._operations.move(t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,a);this._bounds.updateMapBoundsFromOperation(n)}return t}}};const Fu="theme-style";function Uu(i,e){return Wu(Nu(Zu(Bu(i),e)),e.size)}function Zu(i,{accentColor:e,contrastColor:t}){const a=e.toHex(),n=e.a,s=t.toHex(),o=t.a,r=i.getElementsByTagNameNS("http://www.w3.org/2000/svg","style").namedItem(Fu);return r&&(r.innerHTML=`
      .contrast-fill { fill: ${s}; fill-opacity: ${o}; }
      .contrast-stroke { stroke: ${s}; stroke-opacity: ${o};  }
      .accent-fill { fill: ${a}; fill-opacity: ${n}; }
      .accent-stroke { stroke: ${a}; stroke-opacity:  ${n}; }`),i}function Bu(i){const e=i.split(",")[1],t=atob(e);return new DOMParser().parseFromString(t,"image/svg+xml")}function Nu(i){const e=new XMLSerializer().serializeToString(i);return`data:image/svg+xml;base64,${btoa(e)}`}function Wu(i,e){const t=new Image(e,e);return t.src=i,t}const Yu="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NiIgaGVpZ2h0PSI1NiIgZmlsbD0ibm9uZSI+PHN0eWxlIGlkPSJ0aGVtZS1zdHlsZSI+LmNvbnRyYXN0LWZpbGx7ZmlsbDojZmZmfS5jb250cmFzdC1zdHJva2V7c3Ryb2tlOiNmZmZ9LmFjY2VudC1maWxse2ZpbGw6I2ZmN2YwMDtmaWxsLW9wYWNpdHk6LjV9PC9zdHlsZT48cGF0aCBkPSJNMjggMGEyOCAyOCAwIDEgMSAwIDU2IDI4IDI4IDAgMCAxIDAtNTYiIGNsYXNzPSJhY2NlbnQtZmlsbCIvPjxwYXRoIHN0cm9rZS13aWR0aD0iNC45OSIgZD0iTTIwLjA1IDQwLjg2YTE1LjA1IDE1LjA1IDAgMCAwIDE3LjE0LTEuNSAxNS4wNSAxNS4wNSAwIDAgMCA0LjQ3LTE2LjY1IDE1LjA1IDE1LjA1IDAgMCAwLTIyLjcyLTcuMTUgMTUuMDUgMTUuMDUgMCAwIDAtNS41IDcuMTUiIGNsYXNzPSJjb250cmFzdC1zdHJva2UiLz48cGF0aCBkPSJtMTAuOTcgMzUuNTcgNS4zOCAxMi4wNyA3Ljc5LTEzLjQ3eiIgY2xhc3M9ImNvbnRyYXN0LWZpbGwiLz48L3N2Zz4=",ms=64;function qu(i,e){const{accentColor:t,contrastColor:a,preMultiplyAlpha:n}=e;return i.fromData(`heading-rotate:[accent:${t},contrast:${a},size:${ms}]`,()=>new Ec(Uu(Yu,{accentColor:t,contrastColor:a,size:ms}),{mipmap:!0,reloadable:!0,preMultiplyAlpha:n}))}function Xu(i){return!!i.update}class ko extends Ll{}function Ho(i){const e=new Va,{vertex:t,fragment:a,varyings:n}=e,{output:s,perspectiveInterpolation:o}=i;return La(t,i),e.include(lo),e.include(qs,i),e.fragment.include(Ws,i),e.include(kl,i),e.include(Ys,i),e.attributes.add("position","vec3"),e.attributes.add("uv0","vec2"),o&&e.attributes.add("perspectiveDivide","float"),t.main.add(ue`
    vpos = position;
    forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
    vTexCoord = uv0;
    gl_Position = transformPosition(proj, view, vpos);
    ${Ma(o,"gl_Position *= perspectiveDivide;")}`),n.add("vpos","vec3",{invariant:!0}),n.add("vTexCoord","vec2"),a.include(Xs),a.uniforms.add(new Ca("opacity",r=>r.opacity),new Hl("tex",r=>r.glTexture)).main.add(ue`
    discardBySlice(vpos);
    discardByTerrainDepth();
    ${Ma(s===10,"fragColor = vec4(0, 0, 0, 1); return;")}
    vec4 finalColor = texture(tex, vTexCoord) * opacity;
    outputColorHighlightOID(finalColor, vpos, finalColor.rgb);`),e}const Ju=Object.freeze(Object.defineProperty({__proto__:null,ImageMaterialPassParameters:ko,build:Ho},Symbol.toStringTag,{value:"Module"}));let Qu=class extends Js{constructor(e,t){super(e,t,new Qs(Ju,()=>$s(()=>Promise.resolve().then(()=>wd),void 0)),Go(t).locations)}_getPipelineState(e,t){const{oitPass:a,output:n,hasOccludees:s,cullFace:o}=e;return co({blending:ka(n)?to(a,!0):null,culling:uo(o),depthTest:{func:Zl(a)},depthWrite:eo(e),drawBuffers:Ks(a,n),colorWrite:ho,stencilWrite:s?Ul:null,stencilTest:s?t?Vl:Fl:null,polygonOffset:Gl(e)})}initializePipeline(e){return this._occludeePipeline=this._getPipelineState(e,!0),this._getPipelineState(e,!1)}getPipeline(e){return e?this._occludeePipeline:super.getPipeline()}};function Go(i){let e=Yl;return i.perspectiveInterpolation&&(e=e.clone().f32("perspectiveDivide")),e}let Ne=class extends io{constructor(e){super(),this.draped=e,this.cullFace=0,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.perspectiveInterpolation=!0,this.textureCoordinateType=0,this.emissionSource=0,this.discardInvisibleFragments=!0,this.occlusionPass=!1,this.olidColorInstanced=!1,this.snowCover=!1}};u([ne({count:3})],Ne.prototype,"cullFace",void 0),u([ne()],Ne.prototype,"enableOffset",void 0),u([ne()],Ne.prototype,"writeDepth",void 0),u([ne()],Ne.prototype,"hasOccludees",void 0),u([ne()],Ne.prototype,"terrainDepthTest",void 0),u([ne()],Ne.prototype,"cullAboveTerrain",void 0),u([ne()],Ne.prototype,"perspectiveInterpolation",void 0);let Ku=class extends ql{constructor(e){super(e,id),this.supportsEdges=!0,this.produces=new Map([[2,t=>_n(t)],[4,t=>Qi(t)&&this.parameters.writeDepth],[8,t=>Qi(t)&&!this.parameters.writeDepth],[18,t=>Qi(t)||_n(t)]]),this._configuration=new Ne(e.draped)}dispose(){this.setParameters({texture:void 0})}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=t.hasOccludees,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.camera.relativeElevation<Bl,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.perspectiveInterpolation=this.parameters.perspectiveInterpolation,this._configuration}get visible(){return!0}createGLMaterial(e){return new ed(e)}createBufferWriter(){return new td(Go(this.parameters))}};class ed extends no{constructor(e){super({...e,...e.material.parameters}),this.parameters=e;const t=this._material.parameters.texture;Xu(t)&&e.textures.updater.add(t)}dispose(){this.parameters.textures.updater.remove(this._material.parameters.texture)}beginSlot(e){return this.getTechnique(Qu,e)}}class td extends oc{write(e,t,a,n,s,o){for(const r of this.layout.fields.keys()){const l=a.get(r);if(l)if(r==="perspectiveDivide"){ro(l.size===1);const c=s.getField(r,sc);c&&Nl(l,c,o)}else Wl(r,l,e,t,s,o)}return null}}class id extends ao{constructor(e,t){super(),this.texture=e,this.draped=t,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=0,this.opacity=1,this.perspectiveInterpolation=!1}get glTexture(){return this.texture.glTexture}}let ad=class extends ee{constructor(e,t){const a=Oi(e.effectiveTheme.accentColor,.5),n=$i(e.effectiveTheme.accentColor),s=t(a,n),o=new Ku({draped:!1,texture:s.texture,writeDepth:!1,renderOccluded:16,isDecoration:!0}),r=Io.calloutWidth,l=new be({width:r,renderOccluded:4,isDecoration:!0},e.state.isGlobal);super({view:e,...nd({imageMaterial:o,calloutMaterial:l})}),this._material=o,this._textureHandle=s,this._themeHandle=w(()=>e.effectiveTheme.accentColor,c=>{const h=Oi(c,.5),p=$i(c),g=this._textureHandle;this._textureHandle=t(h,p),o.setParameters({texture:this._textureHandle.texture}),g?.release(),l.setParameters({color:J.toUnitRGBA(c)})},A)}destroy(){this._textureHandle=cl(this._textureHandle),this._themeHandle.remove(),this._material.dispose(),super.destroy()}};function nd({imageMaterial:i,calloutMaterial:e}){const{focusMultiplier:t,calloutLength:a,discRadius:n}=Io,s=n*t,o=(h,p)=>{const g=[0,1,2,2,3,0];return new Ns(p,[["position",new ga([a-h,-h,0,a+h,-h,0,a+h,h,0,a-h,h,0],g,3,!0)],["uv0",new ga([0,0,1,0,1,1,0,1],g,2,!0)]])},r=ve(e,[[0,0,0],[a-n,0,0]]),l=ve(e,[[0,0,0],[a-s,0,0]]),c=Be;return{autoScaleRenderObjects:!1,collisionPriority:1,collisionType:{type:"disc",direction:[0,0,1],offset:[a,0,0]},focusMultiplier:t,radius:n,renderObjects:[new x(o(n,i),1|c),new x(r,1|c),new x(o(s,i),2|c),new x(l,2|c)],state:c}}class sd{get _object(){return this._tool.object}get _operations(){return this._object.operations}constructor(e,t,a){this._tool=e,this._bounds=t,this._snapRotation=a,this._rotateTooltipInfo=null,this._startAngle=0,this._endAngle=0;const n=this._tool,s=n.view,o=!s.stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result;this.rotateManipulator=new ad(s,(r,l)=>qu(s.stage.textures,{accentColor:r,contrastColor:l,preMultiplyAlpha:o})),n.addHandles([this.rotateManipulator.events.on("grab-changed",r=>this._onGrabChanged(r)),this._createRotateDragPipeline(this.rotateManipulator)]),n.manipulators.add(this.rotateManipulator),n.addHandles([n.events.on("rotate-start",r=>this._startAngle=r.angle),n.events.on("rotate",r=>this._endAngle=r.angle),n.events.on("rotate-stop",()=>{this._startAngle=0,this._endAngle=0})])}destroy(){this._tool.manipulators.remove(this.rotateManipulator),this.rotateManipulator.destroy()}forEachManipulator(e){e(this.rotateManipulator,3)}updateManipulators(e,t){const a=this._bounds.mapBounds.plane[2]<0?Math.PI:0,n=As(q.get(),e,a);n[12]=0,n[13]=0,n[14]=0,this.rotateManipulator.modelTransform=n,this.rotateManipulator.renderLocation=P(b.get(),t.origin,t.basis1)}getUpdatedTooltipInfo(){return this.rotateManipulator.focused?this._computeRotateTooltipInfo():null}_computeRotateTooltipInfo(){const e=this._rotateTooltipInfo??=new jc({sketchOptions:this._tool.sketchOptions});return e.angle=this._startAngle-this._endAngle,e}_onGrabChanged({action:e,screenPoint:t}){const a=this._tool,n=this._bounds;if(e!=="start"||!t)return;const s=zu(n.displayBounds,a.view.renderCoordsHelper,1,Kt()),o=wo(a.view.state.camera,t);jt(s,o,b.get())&&(n.backupMapBounds(),a.inputState={type:"rotate",rotatePlane:s})}_createRotateDragPipeline(e){const{_tool:t,_object:a}=this;return ye(e,(n,s,o)=>{const r=t.inputState;r!=null&&(s.next(l=>(l.action==="start"&&t.events.emit("rotate-start",{object:a,angle:0}),l)).next(Bi(t.view,r.rotatePlane)).next(this._renderPlaneToAngle()).next(...this._snapRotation()).next(this._updateGeometry()).next(l=>{const c={object:a,angle:qt(l.rotateAngle)};switch(l.action){case"start":case"update":t.events.emit("rotate",c);break;case"end":t.inputState=null,t.events.emit("rotate-stop",c)}return l}),o.next(()=>{t.inputState!=null&&t.events.emit("rotate-stop",{object:a,angle:0}),t.cancelDrag()}))})}_renderPlaneToAngle(){return e=>{const t=Ro(e.renderStart,e.renderEnd,this._bounds.displayBounds.origin,gt(e.plane));return{...e,rotateAngle:t}}}_updateGeometry(){const e=this._bounds;return t=>{const a=Z(M(),e.mapBoundsStart.origin),n=t.action==="start"?0:1;if(this._operations){const s=this._operations.rotate(a,t.rotateAngle,n,1);Pi(e.mapBoundsStart,e.mapBounds),e.updateMapBoundsFromOperation(s)}return t}}}let od=class extends ee{constructor(e,t){const a=Wi(t),n=a?ju:gs,s=n*Su,o=gs,r={renderOccluded:4,isDecoration:!0},l=new be({...r,width:n},e.state.isGlobal),c=new be({...r,width:s},e.state.isGlobal),h=new be({...r,width:o},e.state.isGlobal);super({view:e,...tu,...rd({isCorner:a,unfocusedMaterial:l,focusedMaterial:c,outlineMaterial:h})}),this._themeHandle=w(()=>e.effectiveTheme.accentColor,p=>{const g=J.toUnitRGBA(p);l.setParameters({color:g}),c.setParameters({color:g}),h.setParameters({color:g})},A)}destroy(){this._themeHandle.remove(),super.destroy()}};function rd({isCorner:i,unfocusedMaterial:e,focusedMaterial:t,outlineMaterial:a}){const n=i?[R(1,0,0),R(0,0,0),R(0,1,0)]:[R(1,0,0),R(-1,0,0)];return{renderObjects:[new x(ve(e,n),1|_i),new x(ve(t,n),2|_i),new x(ve(a,n),Lo)],collisionType:{type:"line",paths:[n]},radius:i?Iu:Ru,state:_i}}class ld{constructor(e,t){this._tool=e,this.mapBounds=Nt(),this.mapBoundsStart=Nt(),this.displayBounds=Nt(),e.addHandles(Ft(()=>e.object,"modified-externally",()=>this._resetMapBounds(),{onListenerAdd:()=>this._resetMapBounds()})),this._onDisplayBoundsChanged=t}get displayBoundsMargin(){const{view:e,object:t}=this._tool,a=k(t),n=e.pointsOfInterest?.centerOnSurfaceFrequent.location??a?.extent?.center;return n?cd*e.pixelSizeAt(n):0}backupMapBounds(){Pi(this.mapBounds,this.mapBoundsStart)}updateDisplayBounds(){this._calculateDisplayBounds(),this._onDisplayBoundsChanged?.()}updateMapBoundsFromOperation(e){bc(e,this.mapBounds),this.updateDisplayBounds()}updateMapBoundsFromOperationInverse(e){yc(e,this.mapBounds),this.updateDisplayBounds()}_resetMapBounds(){this._calculateMapBounds(),this.updateDisplayBounds()}_calculateMapBounds(){const{view:e,attachmentOrigin:t,object:a}=this._tool,n=a.operations?.data;if(!n)return;const s=n.geometry;this.spatialReference=s.spatialReference;const o=hh(s);Ut(o,o,-1);const r=t?e.pixelSizeAt(t,s.spatialReference):0,l=hd*r,c=n.coordinateHelper.hasZ()&&a.elevationInfo.mode!=="on-the-ground";Mc(o,n,l,this.mapBounds,c)}_calculateDisplayBounds(){const{view:e,attachmentOrigin:t}=this._tool,a=t?.z??Gi(this.mapBounds.origin,e.elevationProvider,ti.fromElevationInfo(this._tool.object.elevationInfo),e.renderCoordsHelper);ud(this.mapBounds,a??0,e.renderCoordsHelper,this.spatialReference,this.displayBoundsMargin,this.displayBounds)}}const cd=10,hd=80;function ud(i,e,t,a,n=0,s){s||(s=Nt());const o=b.get();P(o,i.origin,i.basis1),P(o,o,i.basis2),t.toRenderCoords(o,a,o);const r=b.get();P(r,i.origin,i.basis1),$(r,r,i.basis2),t.toRenderCoords(r,a,r);const l=b.get();$(l,i.origin,i.basis1),$(l,l,i.basis2),t.toRenderCoords(l,a,l);const c=b.get();$(c,i.origin,i.basis1),P(c,c,i.basis2),t.toRenderCoords(c,a,c),P(s.origin,o,r),P(s.origin,s.origin,l),P(s.origin,s.origin,c),U(s.origin,s.origin,.25),$(o,o,s.origin),$(r,r,s.origin),$(l,l,s.origin),$(c,c,s.origin);const h=Ye(b.get(),o,r,.5),p=Ye(b.get(),l,c,.5);U(p,p,-1),Ye(s.basis1,h,p,.5);const g=Ye(b.get(),o,c,.5),_=Ye(b.get(),r,l,.5);U(_,_,-1),Ye(s.basis2,g,_,.5);const f=de(b.get(),s.basis1,s.basis2);de(s.basis2,f,s.basis1),te(s.basis1,s.basis1);const m=Math.max(Math.abs(he(s.basis1,o)),Math.abs(he(s.basis1,r)),Math.abs(he(s.basis1,l)),Math.abs(he(s.basis1,c)));te(s.basis2,s.basis2);const y=Math.max(Math.abs(he(s.basis2,o)),Math.abs(he(s.basis2,r)),Math.abs(he(s.basis2,l)),Math.abs(he(s.basis2,c)));U(s.basis1,s.basis1,m+n),U(s.basis2,s.basis2,y+n);const v=Z(b.get(),i.origin);return v[2]=e,t.toRenderCoords(v,a,v),dt(v,f,s.plane),hl(s.plane,s.origin,s.origin),Dc(s),s}function dd(i,e,t,a){return $(Mt,$(Mt,i.origin,i.basis1),i.basis2),qe(pi,Mt,i.basis1,2),qe(ua,pi,i.basis2,2),qe(ha,Mt,i.basis2,2),Mt[2]=pi[2]=ua[2]=ha[2]=e,Tc({topLeft:ha,topRight:ua,bottomRight:pi,bottomLeft:Mt,spatialReference:t,automaticLengthMeasurementUtils:a})}const ha=M(),ua=M(),pi=M(),Mt=M();class pd{get _object(){return this._tool.object}get _operations(){return this._object.operations}get zMax(){if(!this._zMaxDirty||!this._operations)return this._zMax;const e=this._operations.data;if(e.geometry.hasZ){const t=e.coordinateHelper;this._zMax=Number.NEGATIVE_INFINITY;for(const a of e.parts)for(const n of a.vertices){const s=t.getZ(n.pos)??0;this._zMax=Math.max(s,this._zMax)}}else this._zMax=0;return this._zMaxDirty=!1,this._zMax}constructor(e,t,a){this._tool=e,this._bounds=t,this._preserveAspectRatioStep=a,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._displayBoundsStart=Nt(),this._displayBoundsMarginStart=0,this._zMax=0,this._zMaxDirty=!0;const n=this._tool,s=n.view;this.resizeManipulators=this._resizeHandles.map(o=>{const r=new od(s,o);return n.addHandles([r.events.on("grab-changed",l=>this._onGrabChanged(l)),this._createResizeDragPipeline(r,o)]),r}),n.manipulators.addMany(this.resizeManipulators),this._operations&&n.addHandles(this._operations.data.on("change",()=>{n.inputState?.type!=="resize"&&(this._zMaxDirty=!0)}))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()})}forEachManipulator(e){this.resizeManipulators.forEach(t=>e(t,2))}updateManipulators(e,t){this.resizeManipulators.forEach((a,n)=>{Cu(a,this._resizeHandles[n],e,t)})}getUpdatedTooltipInfo(){if(!this.resizeManipulators.some(a=>a.focused))return null;const e=this._tooltipInfo??=new Ic({sketchOptions:this._tool.sketchOptions}),t=dd(this._bounds.mapBounds,this.zMax,this._bounds.spatialReference,this._tool.automaticLengthMeasurementUtils);return t&&(e.xSize=t.xSize,e.ySize=t.ySize),this.resizeManipulators.some(a=>a.dragging)||(e.xScale=1,e.yScale=1),e}_onGrabChanged({action:e,screenPoint:t}){const a=this._tool,n=this._bounds;if(e!=="start"||!t)return;const s=wo(a.view.state.camera,t);jt(n.displayBounds.plane,s,b.get())&&(n.backupMapBounds(),Pi(n.displayBounds,this._displayBoundsStart),this._displayBoundsMarginStart=n.displayBoundsMargin,a.inputState={type:"resize"})}_createResizeDragPipeline(e,t){const{_tool:a,_object:n}=this;return ye(e,(s,o,r)=>{a.inputState!=null&&(o.next(l=>(l.action==="start"&&a.events.emit("scale-start",{object:n,xScale:1,yScale:1}),{...l,handle:t})).next(Bi(a.view,this._displayBoundsStart.plane)).next(this._renderPlaneToFactors()).next(...this._preserveAspectRatioStep()).next(this._updateGeometry()).next(l=>{const c=this._tooltipInfo;c&&(c.xScale=l.factor1,c.yScale=l.factor2);const h={object:n,xScale:l.factor1,yScale:l.factor2};switch(l.action){case"start":case"update":a.events.emit("scale",h);break;case"end":a.inputState=null,a.events.emit("scale-stop",h)}return l}),r.next(()=>{a.inputState!=null&&a.events.emit("scale-stop",{object:n,xScale:1,yScale:1}),a.cancelDrag()}))})}_renderPlaneToFactors(){const e=this._bounds;return t=>{const a=this._displayBoundsStart,n=t.handle.direction,s=e.displayBoundsMargin,o=this._displayBoundsMarginStart,r=Z(b.get(),a.origin);qe(r,r,a.basis1,-n[0]),qe(r,r,a.basis2,-n[1]);const l=$(b.get(),t.renderEnd,r),c=$(b.get(),t.renderStart,r),h=Wi(t.handle),p=Da(a),g=Da(e.displayBounds)/p,_=(f,m)=>{if(f===0)return 1;let y=$e(m),v=.5*f*he(m,l)/y;const S=v<0?-1:1;h&&(v+=(y-.5*f*he(m,c)/y)*S*g);const j=y<1.5*o?1:vs;return y=Math.max(y-o,vs),S>0&&(v-=s),S*Math.max(S*(v/y),j)};return{...t,factor1:_(n[0],a.basis1),factor2:_(n[1],a.basis2)}}}_updateGeometry(){const e=this._bounds;return t=>{const a=Z(M(),e.mapBoundsStart.origin);qe(a,a,e.mapBoundsStart.basis1,-t.handle.direction[0]),qe(a,a,e.mapBoundsStart.basis2,-t.handle.direction[1]);const n=fi(Tt(),e.mapBoundsStart.basis1[0],e.mapBoundsStart.basis1[1]);ja(n,n);const s=t.action==="start"?0:1;if(this._operations){const o=this._operations.scale(a,n,t.factor1,t.factor2,s,1);Pi(e.mapBoundsStart,e.mapBounds),e.updateMapBoundsFromOperation(o)}return t}}}const vs=1e-6;class gd{constructor(){this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&this._lastDragEvent!=null&&this._next!=null){const t={...this._lastDragEvent,action:"update"};e&&bs(t),this._next.execute(t)}this._enabled=e}createDragEventPipelineStep(){this._lastDragEvent=null;const e=new Vi;return this._next=e,[t=>(this._lastDragEvent=t.action!=="end"?{...t}:null,this._enabled&&bs(t),t),e]}get test(){}}function bs(i){const e=Wi(i.handle)?Math.max(Math.abs(i.factor1),Math.abs(i.factor2)):i.handle.direction[0]===0?Math.abs(i.factor2):Math.abs(i.factor1);i.factor1=i.factor1<0?-e:e,i.factor2=i.factor2<0?-e:e}let _d=class{constructor(){this._lastDragEvent=null,this._next=null,this.incrementRadians=Qe(5),this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&this._lastDragEvent!=null&&this._next!=null){const t={...this._lastDragEvent,action:"update"};e&&this._adjustRotation(t),this._next.execute(t)}this._enabled=e}createDragEventPipelineStep(){this._lastDragEvent=null;const e=new Vi;return this._next=e,[t=>(this._lastDragEvent=t.action!=="end"?{...t}:null,this._enabled&&this._adjustRotation(t),t),e]}_adjustRotation(e){e.rotateAngle=Math.round(e.rotateAngle/this.incrementRadians)*this.incrementRadians}},Y=class extends Fi{get updating(){return!!this.object.updating}constructor(i){super(i),this.events=new ze,this.enableZ=!0,this.enableScaling=!0,this.enableRotation=!0,this.sketchOptions=new tt,this._preserveAspectRatio=new gd,this._snapRotation=new _d,this.grabbing=!1,this.inputState=null,this._attachmentOrigin=null,this.type="transform-3d",this._outlineVisualElement=null}initialize(){const{view:i,object:e}=this,t=this._bounds=new ld(this,()=>this._updateManipulators());this._extentMove=new Vu(this,t,this.automaticLengthMeasurementUtils),this._extentScale=new pd(this,t,()=>this._preserveAspectRatio.createDragEventPipelineStep()),this._extentRotate=new sd(this,t,()=>this._snapRotation.createDragEventPipelineStep()),this.addHandles([w(()=>this.enableZ,()=>this._updateManipulatorAvailability(this._extentMove.moveZManipulator,0)),w(()=>this.enableScaling,()=>this._extentScale.forEachManipulator(o=>this._updateManipulatorAvailability(o,2))),w(()=>this.enableRotation,()=>this._updateManipulatorAvailability(this._extentRotate.rotateManipulator,3))]),this._updateManipulators(),this._updateAllManipulatorAvailability();const a=Zi({view:i,object:e,forEachManipulator:o=>this._forEachManipulator(o),onManipulatorsChanged:()=>L()});if(a!=null){const{visualElement:o}=a;o instanceof pt&&(this._outlineVisualElement=o,this.addHandles(o.events.on("attachment-origin-changed",()=>this._bounds.updateDisplayBounds()))),this.addHandles(a)}this.addHandles([e.on("committed",()=>this._onGeometryChanged()),w(()=>this.object.visible,()=>this._updateAllManipulatorAvailability()),w(()=>this.object.isDraped,()=>this._graphicDrapedChanged(),A),w(()=>i.pointsOfInterest?.centerOnSurfaceFrequent.location,()=>t.updateDisplayBounds())]);const n=o=>{this.addHandles(o.events.on("grab-changed",()=>{this.grabbing=o.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(n);const s=(o,r)=>{this.addHandles(o.events.on("immediate-click",l=>{r===1&&this.events.emit("immediate-click",{...l,object:e}),l.stopPropagation()}))};this._forEachManipulator(s),this._initializeTooltip(),this.finishToolCreation()}destroy(){this._extentMove.destroy(),this._extentScale.destroy(),this._extentRotate.destroy(),this.tooltip.destroy(),this._set("view",null),this._set("object",null)}_initializeTooltip(){const{view:i}=this;this.tooltip=Hi(()=>({view:i,options:this.sketchOptions.tooltips}));const e=()=>{this.tooltip.info=this._getUpdatedTooltipInfo()};this.addHandles([w(()=>this.sketchOptions.tooltips.effectiveEnabled,e),w(()=>this.preserveAspectRatio,e)]),this._forEachManipulator(t=>{this.addHandles([t.events.on(["focus-changed","grab-changed"],e),t.events.on("drag",a=>{a.action==="cancel"?this.tooltip.clear():e()})])})}_getUpdatedTooltipInfo(){return this.sketchOptions.tooltips.effectiveEnabled?this._extentMove.getUpdatedTooltipInfo()??this._extentScale.getUpdatedTooltipInfo()??this._extentRotate.getUpdatedTooltipInfo():null}_onGeometryChanged(){this._bounds.updateDisplayBounds()}_graphicDrapedChanged(){this.removeHandles(ys),this._bounds.updateDisplayBounds(),this.object.isDraped&&this.addHandles(this.view.elevationProvider.on("elevation-change",i=>{this._attachmentOrigin!=null&&Ts(i.extent,this._attachmentOrigin.x,this._attachmentOrigin.y)&&this._bounds.updateDisplayBounds()}),ys)}_updateManipulators(){if(!this.visible)return;const i=this._bounds.displayBounds,e=Pu(i,q.get());this._extentMove.updateManipulators(e,i),this._extentScale.updateManipulators(e,i),this._extentRotate.updateManipulators(e,i)}_updateAllManipulatorAvailability(){this._forEachManipulator((i,e)=>this._updateManipulatorAvailability(i,e))}_updateManipulatorAvailability(i,e){const t=this.grabbing&&!i.grabbing;if(i.interactive=!t,i instanceof ee){const a=this.object.visible,n=this.enableZ&&ht(this.object.operations,this.object.elevationInfo);switch(e){case 3:i.available=a&&this.enableRotation;break;case 2:i.available=a&&(this.enableScaling||this.enableRotation||n),i.interactive=!t&&this.enableScaling,i.state=this.enableScaling?_i:Lo;break;case 0:i.available=a&&n;break;default:i.available=a}}}_forEachManipulator(i){this._extentMove.forEachManipulator(i),this._extentScale.forEachManipulator(i),this._extentRotate.forEachManipulator(i)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(i){this._preserveAspectRatio.enabled=i,this._set("preserveAspectRatio",i)}get snapRotation(){return this._snapRotation.enabled}set snapRotation(i){this._snapRotation.enabled=i,this._set("snapRotation",i)}get attachmentOrigin(){const i=this.object.isDraped?null:this._outlineVisualElement?.attachmentOrigin;return this._attachmentOrigin=i??this.object.origin??k(this.object)?.extent?.center,this._attachmentOrigin}reset(){}cancelDrag(){if(this.canUndo){const i=this.object.operations?.undo();i&&this._bounds.updateMapBoundsFromOperationInverse(i)}this.inputState=null}get canUndo(){return!!this.object.operations?.canUndo}undo(){if(this.inputState!=null)this.view.activeTool=null;else if(this.canUndo){const i=this.object.operations?.undo();i&&this._bounds.updateMapBoundsFromOperationInverse(i)}}get canRedo(){return!!this.object.operations?.canRedo}redo(){if(this.canRedo){const i=this.object.operations?.redo();i&&this._bounds.updateMapBoundsFromOperation(i)}}get test(){}};u([d()],Y.prototype,"updating",null),u([d({constructOnly:!0,nonNullable:!0})],Y.prototype,"view",void 0),u([d({constructOnly:!0})],Y.prototype,"automaticLengthMeasurementUtils",void 0),u([d({constructOnly:!0,nonNullable:!0})],Y.prototype,"object",void 0),u([d()],Y.prototype,"enableZ",void 0),u([d()],Y.prototype,"enableScaling",void 0),u([d()],Y.prototype,"enableRotation",void 0),u([d({constructOnly:!0,type:tt})],Y.prototype,"sketchOptions",void 0),u([d()],Y.prototype,"preserveAspectRatio",null),u([d()],Y.prototype,"snapRotation",null),u([d()],Y.prototype,"grabbing",void 0),u([d()],Y.prototype,"inputState",void 0),u([d({readOnly:!0})],Y.prototype,"type",void 0),u([d()],Y.prototype,"tooltip",void 0),Y=u([H("esri.views.3d.interactive.editingTools.transform.ExtentTransformTool")],Y);const ys="draped-elevation-changes";function fd(i){return i!=null&&i.type==="mesh"?md(i):vd(i)}function md(i){return Rc(i.vertexSpace)?bd(i,i.transform,i.vertexSpace):yd(i)}function vd(i){let e=i,t=null;return{undo(a){t=a.geometry,a.geometry=e},redo(a){e=a.geometry,a.geometry=t}}}function bd(i,e,t){let a=e?.clone(),n=Zt(t.origin),s=null,o=null;return{undo:()=>{s=i.transform?.clone(),o=Zt(t.origin),i.transform=a,i.vertexSpace.origin=n},redo:()=>{a=i.transform?.clone(),n=Zt(t.origin),i.transform=s,i.vertexSpace.origin=o}}}function yd(i){let e,t=i.vertexAttributes.clonePositional();return{undo:()=>{e=i.vertexAttributes.clonePositional(),i.vertexAttributes=t},redo:()=>{t=i.vertexAttributes.clonePositional(),i.vertexAttributes=e}}}const da=Symbol();let We=class extends ul{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}get elevationInfo(){return dl(this.graphic)}get visible(){return this._graphicState.displaying}get isDraped(){return this._graphicState.isDraped}get origin(){return iu(this.view,this.graphic)}constructor(i){super(i),this._updatingHandles=new ki}destroy(){this._operations=C(this._operations),this._updatingHandles.destroy()}initialize(){this._graphicState=new po({graphic:this.graphic}),this._graphicState.on("changed",()=>this.emit("committed")),this.addHandles(this.view.trackGraphicState(this._graphicState)),this.addHandles(this._updatingHandles.add(()=>this.graphic.geometry,i=>{const e=this._operations?.data.geometry;if(i!==e){if(!i||i?.type==="multipoint"||i?.type==="extent")return C(this._operations),this.removeHandles(da),void(this._operations=null);if(this._operations?.trySetGeometry(i))this.emit("modified-externally");else{C(this._operations),this.removeHandles(da);const t=Ha.fromGeometry(i,this.view.state.viewingMode);this._operations=t,this.addHandles(t.data.on("change",()=>this.graphic.geometry=t.data.geometry),da)}}},Ke))}createManipulator(i){return new Ac({view:this.view,graphic:this.graphic,...i})}maskOccludee(){return this.view.maskOccludee(this.graphic)}endInteraction(){this.graphic.geometry?.type==="mesh"&&this.graphic.notifyMeshTransformChanged({action:2})}toMap(i){return this.view.toMap(i,{include:[this.graphic]})}createUndoRecord(){const{graphic:{geometry:i}}=this;return fd(i)}};u([d({constructOnly:!0})],We.prototype,"view",void 0),u([d({constructOnly:!0})],We.prototype,"graphic",void 0),u([d()],We.prototype,"_operations",void 0),u([d()],We.prototype,"operations",null),u([d()],We.prototype,"updating",null),We=u([H("esri.views.3d.interactive.editingTools.ManipulatedObject3DGraphic")],We);const Bp=Object.freeze(Object.defineProperty({__proto__:null,get DrawGraphicTool3D(){return ot},get ExtentTransformTool(){return Y},get ManipulatedObject3DGraphic(){return We},get MoveTool3D(){return ie},get ReshapeTool3D(){return z},get TransformTool3D(){return ae}},Symbol.toStringTag,{value:"Module"})),Np=Object.freeze(Object.defineProperty({__proto__:null,build:Xl},Symbol.toStringTag,{value:"Module"})),Md=Object.freeze(Object.defineProperty({__proto__:null,build:mo},Symbol.toStringTag,{value:"Module"})),wd=Object.freeze(Object.defineProperty({__proto__:null,ImageMaterialPassParameters:ko,build:Ho},Symbol.toStringTag,{value:"Module"}));export{Np as C,Bp as e};
