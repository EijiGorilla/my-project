import{S as _,b,O as v,c as P,cR as f,P as H,ak as M,cS as $,cT as x,_ as n,d as r,e as g,t_ as R,an as G,l as E,a5 as S,mS as j,mG as V,at as N,bX as D,cN as T,a9 as A}from"./index-Bncuv2b3.js";import{i as z}from"./MediaLayerView3D-CSCLh6h8.js";import{a as k,g as I}from"./EditGeometryOperations-CyZHQtvA.js";import{E as L,V as F}from"./VideoElement-Dtb9UXjJ.js";import"./perspectiveUtils-D9fAEA8E.js";import"./normalizeUtilsSync-CBes_t8t.js";import"./LayerView3D-UMV3wBm1.js";import"./SnappingManagerPool-DYCW3Nod.js";import"./allLayerSnapping-QhQT5ZYK.js";import"./ImageMaterial.glsl-CjOKQK_o.js";import"./TriangleMaterial-OR2yZUrw.js";import"./DefaultLayouts-CE-gg6Xm.js";import"./LayerView-DinLbObD.js";import"./MediaLayerView-CHnVIAUB.js";import"./highlightOptionsUtils-BiLqICK5.js";import"./rotate-CQ-lGfeV.js";import"./curveOperationUtils-BdFGEFag.js";import"./mediaLayerUtils-BJ-DU5EY.js";import"./ControlPoint-Bf6r3myR.js";let c=class extends _{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new b}initialize(){this.addHandles([v(this._updatingHandles),this._updatingHandles.add(()=>{const e=this.element.georeference;return e?.type==="control-points"?e.controlPoints:null},e=>this._elementControlPointsChanged(e),P)])}_elementControlPointsChanged(e){const t=e?.map(({mapPoint:i})=>i).filter(f),o=this.view.spatialReference;this._updatingHandles.addPromise(this._whenProjected(t,o,i=>{if(!i)return void this._replaceOperations(null);const{_operations:s}=this,p=i.map(({x:a,y:m})=>[a,m]);p.push(p[0].slice());const h=new H({rings:[p],spatialReference:o});if(s?.trySetGeometry(h))return void this.onModifiedExternally();const y=this.view.state.viewingMode;this._replaceOperations(new z(k.fromGeometry(h,y),y,a=>this._operationsGeometryChanged(a)))}))}_operationsGeometryChanged(e){const{element:{georeference:t},_operations:o}=this;if(!o||!t||t.type!=="control-points"||!t.controlPoints)return;const i=o.data.geometry,s=t.controlPoints.map(({mapPoint:a})=>a).filter(f),p=o.data.parts[0].isClosed()?1:0;if(i.rings[0]?.length-p!==s.length)return;const h=i.rings[0].map(([a,m])=>new M({x:a,y:m,spatialReference:i.spatialReference}));h.length-=p;const y=s.map(({spatialReference:a})=>a);this._updatingHandles.addPromise(this._whenProjected(h,y,a=>this._updateElementControlPoints(a,e)))}_updateElementControlPoints(e,t){const{georeference:o}=this.element;if(!o||!e||o.type!=="control-points"||o.controlPoints?.length!==e?.length)return;const i=o.controlPoints;if(i?.length===e.length)for(let s=0;s<i.length;s++)t&&(i[s].sourcePoint=o.toSource(e[s])),i[s].mapPoint=e[s]}async _whenProjected(e,t,o){if(!e)return void o(e);const{_operations:i,element:{georeference:s}}=this,p=e.map(({spatialReference:a})=>a),h=Array.isArray(t)?t:new Array(p.length).fill(t);await $(Array.from(p).map((a,m)=>({source:a,dest:h[m]})));const y=e.map((a,m)=>x(a,h[m]));i===this._operations&&s===this.element.georeference&&o(y)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e}};n([r({constructOnly:!0})],c.prototype,"view",void 0),n([r({constructOnly:!0})],c.prototype,"layer",void 0),n([r({constructOnly:!0})],c.prototype,"element",void 0),n([r({constructOnly:!0})],c.prototype,"onModifiedExternally",void 0),n([r()],c.prototype,"_operations",void 0),n([r()],c.prototype,"operations",null),n([r()],c.prototype,"updating",null),c=n([g("esri.views.3d.interactive.editingTools.media.MediaElementControllerControlPoints")],c);let u=class extends _{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new b}initialize(){this.addHandles([v(this._updatingHandles),this._updatingHandles.add(()=>this.element.georeference?.coords,e=>this._elementCoordinatesChanged(e),P)])}_elementCoordinatesChanged(e){this._updatedElementCoordinates!==e&&this._updatingHandles.addPromise(this._whenProjected(e,this.view.spatialReference,t=>{if(!t)return void this._replaceOperations(null);const{_operations:o}=this;o?.trySetGeometry(t)?this.onModifiedExternally():this._replaceOperations(I.fromGeometry(t,this.view.state.viewingMode))}))}_operationsGeometryChanged(){const{element:{georeference:e},_operations:t}=this;if(!t||!e)return;const o=t.data.geometry;if(!e.coords)return void this._updateElementCoordinates(o);const i=e.coords.spatialReference;this._updatingHandles.addPromise(this._whenProjected(o,i,s=>this._updateElementCoordinates(s)))}_updateElementCoordinates(e){const{georeference:t}=this.element;t&&(t.coords=e,this._updatedElementCoordinates=t.coords)}async _whenProjected(e,t,o){if(!e)return void o(e);const{_operations:i,element:{georeference:s}}=this,p=await R(e,t);i===this._operations&&s===this.element.georeference&&o(p)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e,e&&this.addHandles(e.data.on("change",()=>this._operationsGeometryChanged()),e),this.onModifiedExternally()}};n([r({constructOnly:!0})],u.prototype,"view",void 0),n([r({constructOnly:!0})],u.prototype,"layer",void 0),n([r({constructOnly:!0})],u.prototype,"element",void 0),n([r({constructOnly:!0})],u.prototype,"onModifiedExternally",void 0),n([r()],u.prototype,"_operations",void 0),n([r()],u.prototype,"operations",null),n([r()],u.prototype,"updating",null),u=n([g("esri.views.3d.interactive.editingTools.media.MediaElementControllerShape")],u);function U(e,t,o){return O(e.allLayerViews.find(i=>i.layer===t),o)}function O(e,t){if(!e||e.type!=="media-3d"||e.suspended)return!1;const o=e.layer.source;return!!o&&(o instanceof L||o instanceof F?o===t:"hasElement"in o&&o.hasElement(t))}let l=class extends _{grabbableForEvent(){return!0}constructor(e){super(e),this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.grabbing=!1,this.dragging=!1,this.hovering=!0,this.selected=!1,this.cursor=null,this.consumesClicks=!0,this.events=new G,this.addHandles(E(()=>this.selected,t=>this.events.emit("select-changed",{action:t?"select":"deselect"}),S))}destroy(){this._set("view",null)}intersectionDistance(e){const{view:t,layer:o,element:i}=this;if(!U(t,o,i))return null;const s=t.toMap(e,{include:{layer:o,element:i}});return s&&V(s,w,t.renderSpatialReference)?j(w,t.state.camera.eye):null}onElevationChange(){}onViewChange(){}};n([r({constructOnly:!0,nonNullable:!0})],l.prototype,"element",void 0),n([r({constructOnly:!0,nonNullable:!0})],l.prototype,"layer",void 0),n([r({constructOnly:!0,nonNullable:!0})],l.prototype,"view",void 0),n([r()],l.prototype,"interactive",void 0),n([r()],l.prototype,"selectable",void 0),n([r()],l.prototype,"grabbable",void 0),n([r()],l.prototype,"grabbing",void 0),n([r()],l.prototype,"dragging",void 0),n([r()],l.prototype,"hovering",void 0),n([r()],l.prototype,"selected",void 0),n([r()],l.prototype,"cursor",void 0),l=n([g("esri.views.3d.interactive.editingTools.media.MediaElementManipulator3D")],l);const w=N(),C=Symbol();let d=class extends D{get operations(){return this._controller?.operations}get elevationInfo(){return{mode:"on-the-ground",offset:0}}get _layerView(){const e=this.view.allLayerViews.find(t=>t.layer===this.layer);return e?.type==="media-3d"?e:null}get visible(){return O(this._layerView,this.element)}get isDraped(){return!0}get origin(){return null}get updating(){return!!this._controller?.updating}get _controllerClass(){return this.tool==="transform"||this.element.georeference?.type!=="control-points"?u:c}constructor(e){super(e),this.tool="transform"}initialize(){this.addHandles([E(()=>this._controllerClass,e=>this._updateController(e),A),T(()=>this._layerView,"element-render-changed",({element:e})=>{this.element===e&&this.emit("committed")})])}toMap(e){const{layer:t,element:o}=this;return this.view.toMap(e,{include:{layer:t,element:o}})}createManipulator(e){const{view:t,layer:o,element:i}=this;return new l({view:t,layer:o,element:i,...e})}_updateController(e){if(this._controller&&this._controller instanceof e)return;this.removeHandles(C);const{view:t,layer:o,element:i}=this,s=()=>{this.emit("modified-externally")};this._controller=new e({view:t,layer:o,element:i,onModifiedExternally:s}),s(),this.addHandles(v(this._controller),C)}};n([r({constructOnly:!0})],d.prototype,"view",void 0),n([r({constructOnly:!0})],d.prototype,"layer",void 0),n([r({constructOnly:!0})],d.prototype,"element",void 0),n([r()],d.prototype,"tool",void 0),n([r()],d.prototype,"_controller",void 0),n([r()],d.prototype,"elevationInfo",null),n([r()],d.prototype,"_layerView",null),n([r()],d.prototype,"visible",null),n([r()],d.prototype,"updating",null),n([r()],d.prototype,"_controllerClass",null),d=n([g("esri.views.3d.interactive.editingTools.ManipulatedObject3DMediaElement")],d);export{d as ManipulatedObject3DMediaElement};
