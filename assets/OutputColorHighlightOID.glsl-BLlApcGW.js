import{eF as zt,d2 as os,av as hi,ll as it,wg as ls,aI as cs,e3 as N,dm as us,e4 as di,eS as Ke,e1 as p,eT as hs,jA as Pt,fL as D,wh as ds,eX as q,eW as O,wi as fs,kz as vt,fE as ce,jr as Ot,pO as ms,dG as ps,r as Ge,X as ee,fm as Ie,pF as K,wj as gs,ky as st,v$ as rt,vY as vs,wk as fi,wl as mi,fI as _e,fA as le,kG as $s,aN as Bt,qU as bs,aK as ys,qA as Fe,pP as Ye,e5 as pe,jz as xs,ej as j,mh as _s,ul as Oe,wm as Te,wn as ws,jq as Ss,s9 as Cs,jt as zs,jp as Ps,s4 as Ms,jf as As,ji as Fs,hS as Mt,so as Vt,wo as Ts,wp as ks,wq as pi,wr as Ls,fk as ge,tT as Ut,g5 as At,ws as Dt,ss as Is,fU as Os,wt as Bs,es as ke,fz as Z,er as de,el as me,fW as $t,ju as Nt,gt as Ht,a1 as gi,eL as vi,mi as Vs,wu as Us,cR as G,jE as bt,cS as yt,jc as $i,wv as Ds,ww as Ns,wx as Hs,wy as js,eV as Rs,wz as Es,wA as qs,wB as Gs,wC as Ws,fV as Xs,eP as bi,hy as Ks,wD as Qe,f_ as Ys,l5 as Js,wE as Zs,C as Qs,i0 as er,fO as tr,su as jt,fx as Rt,pD as xt,pE as yi,wF as ir,wG as Et,fR as qt,wH as sr,fH as rr,pQ as nr,js as xi,p4 as ar,wI as or,wJ as lr,jG as cr,wK as ur,fF as hr,ip as _i,df as dr,N as fr,di as mr,Y as Be,$ as pr,aG as wi,kY as _t,f6 as Gt}from"./index-DcRZY5kx.js";import{e as gr,A as vr}from"./Indices-DfQUWp03.js";import{l as $r,s as F,g as Si,h as br,o as nt,m as yr,T as Wt,f as Xt,J as Kt,p as xr,y as _r}from"./BufferView-BkGwg0rw.js";import{c as wr,e as Sr,l as Ci,r as Cr,T as zr,d as Pr}from"./renderState-CKc66y4x.js";import{t as f,n as R}from"./glsl-B5bJgrnA.js";import{n as zi}from"./VertexAttributeLocations-BfZbt_DV.js";import{t as Pi}from"./VertexElementDescriptor-BLyltQyJ.js";function po(t,e=!1){return t<=zt?e?new Array(t).fill(0):new Array(t):new Float32Array(t)}function go(t){return(Array.isArray(t)?t.length:t.byteLength/8)<=zt?Array.from(t):new Float32Array(t)}function vo(t,e,i){return Array.isArray(t)?t.slice(e,e+i):t.subarray(e,e+i)}const Ve=()=>hi.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),Mr=542327876,Ar=131072,Fr=4;function Ft(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}function Tr(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&255)}const kr=Ft("DXT1"),Lr=Ft("DXT3"),Ir=Ft("DXT5"),Or=31,Br=0,Vr=1,Ur=2,Dr=3,Nr=4,Hr=7,jr=20,Rr=21;function $o(t,e,i){const s=Er(i,e.hasMipmap??!1);if(s==null)throw new Error("DDS texture data is null");const{textureData:r,internalFormat:n,width:a,height:o}=s;return e.samplingMode=r.levels.length>1?9987:9729,e.hasMipmap=r.levels.length>1,e.internalFormat=n,e.width=a,e.height=o,new os(t,e,r)}function Er(t,e){const i=new Int32Array(t.buffer,t.byteOffset,Or);if(i[Br]!==Mr)return Ve().error("Invalid magic number in DDS header"),null;if(!(i[jr]&Fr))return Ve().error("Unsupported format, must contain a FourCC code"),null;const s=i[Rr];let r,n;switch(s){case kr:r=8,n=it.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Lr:r=16,n=it.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Ir:r=16,n=it.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return Ve().error("Unsupported FourCC code:",Tr(s)),null}let a=1,o=i[Nr],l=i[Dr];(3&o||3&l)&&(Ve().warn("Rounding up compressed texture size to nearest multiple of 4."),o=o+3&-4,l=l+3&-4);const u=o,c=l;let h,m;i[Ur]&Ar&&e!==!1&&(a=Math.max(1,i[Hr]));let g=t.byteOffset+i[Vr]+4;const d=[];for(let _=0;_<a;++_)m=(o+3>>2)*(l+3>>2)*r,h=new Uint8Array(t.buffer,g,m),d.push(h),g+=m,o=Math.max(1,o>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:d},internalFormat:n,width:u,height:c}}function qr(t){if(t.length<zt)return Array.from(t);if(Array.isArray(t))return Float64Array.from(t);if(!("BYTES_PER_ELEMENT"in t))return Array.from(t);switch(t.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(t);case 2:return ls(t)?$r().from(t):cs(t)?Uint16Array.from(t):Int16Array.from(t);case 4:return Float32Array.from(t);default:return Float64Array.from(t)}}let Gr=class Mi{get center(){return N(this._data[0],this._data[1],this._data[2])}get radius(){return this._data[3]}get bbMin(){return N(this._data[4],this._data[5],this._data[6])}get bbMax(){return N(this._data[7],this._data[8],this._data[9])}constructor(e,i,s){this.primitiveIndices=e,this._numIndexPerPrimitive=i,this.position=s,this._data=[.1,0,0,0,0,0,0,0,0,0],this._children=void 0,F(e.length>=1),F(s.size===3||s.size===4);const{data:r,size:n,indices:a}=s;F(a.length%this._numIndexPerPrimitive===0),F(a.length>=e.length*this._numIndexPerPrimitive);const o=e.length;let l=n*a[this._numIndexPerPrimitive*e[0]];ue.clear(),ue.push(l);const u=N(r[l],r[l+1],r[l+2]),c=di(u);for(let d=0;d<o;++d){const _=this._numIndexPerPrimitive*e[d];for(let M=0;M<this._numIndexPerPrimitive;++M){l=n*a[_+M],ue.push(l);let b=r[l];u[0]=Math.min(b,u[0]),c[0]=Math.max(b,c[0]),b=r[l+1],u[1]=Math.min(b,u[1]),c[1]=Math.max(b,c[1]),b=r[l+2],u[2]=Math.min(b,u[2]),c[2]=Math.max(b,c[2])}}for(let d=0;d<3;++d)this._data[4+d]=u[d],this._data[7+d]=c[d];const h=Ke(p(),this.bbMin,this.bbMax,.5);let m=.5*Math.max(Math.max(c[0]-u[0],c[1]-u[1]),c[2]-u[2]),g=m*m;for(let d=0;d<ue.length;++d){l=ue.at(d);const _=r[l]-h[0],M=r[l+1]-h[1],b=r[l+2]-h[2],A=_*_+M*M+b*b;if(A<=g)continue;const S=Math.sqrt(A),z=.5*(S-m);m+=z,g=m*m;const L=z/S;h[0]+=_*L,h[1]+=M*L,h[2]+=b*L}this._data[3]=m;for(let d=0;d<3;++d)this._data[0+d]=h[d];ue.clear()}getChildren(){if(this._children||hs(this.bbMin,this.bbMax)<=1)return this._children;const e=Ke(p(),this.bbMin,this.bbMax,.5),i=this.primitiveIndices.length,s=new Uint8Array(i),r=new Array(8);for(let c=0;c<8;++c)r[c]=0;const{data:n,size:a,indices:o}=this.position;for(let c=0;c<i;++c){let h=0;const m=this._numIndexPerPrimitive*this.primitiveIndices[c];let g=a*o[m],d=n[g],_=n[g+1],M=n[g+2];for(let b=1;b<this._numIndexPerPrimitive;++b){g=a*o[m+b];const A=n[g],S=n[g+1],z=n[g+2];A<d&&(d=A),S<_&&(_=S),z<M&&(M=z)}d<e[0]&&(h|=1),_<e[1]&&(h|=2),M<e[2]&&(h|=4),s[c]=h,++r[h]}let l=0;for(let c=0;c<8;++c)r[c]>0&&++l;if(l<2)return;const u=new Array(8);for(let c=0;c<8;++c)u[c]=r[c]>0?new Uint32Array(r[c]):void 0;for(let c=0;c<8;++c)r[c]=0;for(let c=0;c<i;++c){const h=s[c];u[h][r[h]++]=this.primitiveIndices[c]}this._children=new Array;for(let c=0;c<8;++c)u[c]!==void 0&&this._children.push(new Mi(u[c],this._numIndexPerPrimitive,this.position));return this._children}static prune(){ue.prune()}};const ue=new us({deallocator:null});let Wr=class{constructor(e){this.id=Pt(),this._attributes=new Map;for(const[i,s]of e)this._attributes.set(i,{...s,indices:gr(s.indices)})}get attributes(){return this._attributes}};function Xr(t,e){if(!t)return!1;const{size:i,data:s,indices:r}=t;D(e,0,0,0),D(E,0,0,0);let n=0,a=0;for(let o=0;o<r.length-2;o+=3){const l=r[o]*i,u=r[o+1]*i,c=r[o+2]*i;D(I,s[l],s[l+1],s[l+2]),D(te,s[u],s[u+1],s[u+2]),D(Ue,s[c],s[c+1],s[c+2]);const h=ds(I,te,Ue);h?(q(I,I,te),q(I,I,Ue),O(I,I,1/3*h),q(e,e,I),n+=h):(q(E,E,I),q(E,E,te),q(E,E,Ue),a+=3)}return(a!==0||n!==0)&&(n!==0?(O(e,e,1/n),!0):a!==0&&(O(e,E,1/a),!0))}function Kr(t,e){if(!t)return!1;const{size:i,data:s,indices:r}=t;D(e,0,0,0);let n=-1,a=0;for(let o=0;o<r.length;o++){const l=r[o]*i;n!==l&&(e[0]+=s[l],e[1]+=s[l+1],e[2]+=s[l+2],a++),n=l}return a>1&&O(e,e,1/a),a>0}function Yr(t,e,i){if(!t)return!1;D(i,0,0,0),D(E,0,0,0);let s=0,r=0;const{size:n,data:a,indices:o}=t,l=o.length-1,u=l+(e?2:0);for(let c=0;c<u;c+=2){const h=c<l?c+1:0,m=o[c<l?c:l]*n,g=o[h]*n;I[0]=a[m],I[1]=a[m+1],I[2]=a[m+2],te[0]=a[g],te[1]=a[g+1],te[2]=a[g+2],O(I,q(I,I,te),.5);const d=fs(I,te);d>0?(q(i,i,O(I,I,d)),s+=d):s===0&&(q(E,E,I),r++)}return s!==0?(O(i,i,1/s),!0):r!==0&&(O(i,E,1/r),!0)}const I=p(),te=p(),Ue=p(),E=p();let Ai=class{constructor(){this.uid=Pt()}},Jr=class extends Ai{constructor(e){super(),this.highlightName=e,this.channel=0}},_o=class extends Ai{constructor(){super(...arguments),this.channel=1}},So=class Fi extends Wr{constructor(e,i,s=null,r=0,n=null,a=-1,o){super(i),this.material=e,this.mapPositions=s,this.type=r,this.olidColor=n,this.edgeIndicesLength=a,this.baseGeometry=o,this._highlights=null,this._highlightOptionsCounts=null,this.visible=!0,this._boundingInfo=null;const l=this.positionAttribute;l!=null&&this.edgeIndicesLength<0&&(this.edgeIndicesLength=l.indices.length)}instantiate(e={}){const i=new Fi(e.material||this.material,[],this.mapPositions,this.type,this.olidColor,this.edgeIndicesLength,this.baseGeometry);return this._attributes.forEach((s,r)=>{s.exclusive=!1,i._attributes.set(r,s)}),i._boundingInfo=this._boundingInfo,i.transformation=e.transformation||this.transformation,i}getMutableAttribute(e){let i=this._attributes.get(e);return i&&!i.exclusive&&(i={...i,exclusive:!0,data:qr(i.data)},this._attributes.set(e,i)),i}setAttributeData(e,i){const s=this._attributes.get(e);s?this._attributes.set(e,{...s,exclusive:!0,data:i}):vt()&&console.warn(`Setting undefined attribute ${e} data`)}get positionAttribute(){return this.attributes.get("position")??this.baseGeometry?.attributes.get("position")}get indexCount(){return this._attributes.values().next().value?.indices?.length??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo??=this._calculateBoundingInfo(),this._boundingInfo}computeAttachmentOrigin(e){return!!(this.type===0?this._computeAttachmentOriginTriangles(e):this.type===2?this._computeAttachmentOriginLines(e):this._computeAttachmentOriginPoints(e))&&(this._transformation!=null&&ce(e,e,this._transformation),!0)}_computeAttachmentOriginTriangles(e){const i=this.positionAttribute;return Xr(i,e)}_computeAttachmentOriginLines(e){const i=this.positionAttribute;return Yr(i,Zr(this.material.parameters,i),e)}_computeAttachmentOriginPoints(e){const i=this.positionAttribute;return Kr(i,e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const e=this.positionAttribute;if(!e||e.indices.length===0)return null;const i=this.type===0?3:1;F(e.indices.length%i===0,"Indexing error: "+e.indices.length+" not divisible by "+i);const s=vr(e.indices.length/i);return new Gr(s,i,e)}get transformation(){return this._transformation??Ot}set transformation(e){this._transformation=e&&e!==Ot?ms(e):null}get highlights(){return this._highlights||Qr}get hasHighlights(){return(this._highlightOptionsCounts?.size??0)>0}foreachHighlightOptions(e){this._highlightOptionsCounts?.forEach((i,s)=>e(s))}allocateIdAndHighlight(e){const i=new Jr(e);return this.addHighlight(i)}addHighlight(e){this._ensureHighlights().add(e);const{highlightName:i}=e,s=(this._highlightOptionsCounts?.get(i)??0)+1;return this._ensureHighlightOptionsCounts().set(i,s),e}_ensureHighlights(){let e=this._highlights;return e||(e=new Set,this._highlights=e),e}_ensureHighlightOptionsCounts(){let e=this._highlightOptionsCounts;return e||(e=new Map,this._highlightOptionsCounts=e),e}removeHighlight(e){if(this._highlights?.delete(e)){const{highlightName:i}=e,s=this._highlightOptionsCounts?.get(i)??0;s<=1?this._highlightOptionsCounts?.delete(i):this._ensureHighlightOptionsCounts().set(i,s-1)}}};function Zr(t,e){return!(!("isClosed"in t)||!t.isClosed)&&e.indices.length>2}const Qr=new Set;function en(t){return t===4||t===5||t===6||t===7||t===8}function Co(t){return sn(t)||t===3}function Ti(t){return t===9||t===10}function zo(t){return ki(t)||Ti(t)}function ki(t){return t===0}function Le(t){return ki(t)||Tt(t)}function Po(t){return Le(t)||t===10}function tn(t){return Le(t)||Ti(t)}function sn(t){return tn(t)||Li(t)}function Li(t){return t===2}function Tt(t){return t===1}function rn(t){return Li(t)||en(t)}let Mo=class{constructor(e){this._material=e.material,this._techniques=e.techniques,this._output=e.output}dispose(){}get _stippleTextures(){return this._techniques.context?.stippleTextures}get _markerTextures(){return this._techniques.context?.markerTextures}getTechnique(e,i){return this._techniques.get(e,this._material.getConfiguration(this._output,i))}ensureResources(e){return 2}},nn=class{};const kt=nn;let an=class{constructor(e){this._bits=[...e]}equals(e){return ps(this._bits,e.bits)}get code(){return this._code??=String.fromCharCode(...this._bits),this._code}get bits(){return this._bits}},on=class extends kt{constructor(){super(),this._parameterBits=this._parameterBits?.map(()=>0)??[],this._parameterNames??=[]}get key(){return this._key??=new an(this._parameterBits),this._key}decode(e=this.key){const i=this._parameterBits;this._parameterBits=[...e.bits];const s=this._parameterNames.map(r=>`    ${r}: ${this[r]}`).join(`
`);return this._parameterBits=i,s}};function De(t={}){return(e,i)=>{e.hasOwnProperty("_parameterNames")||Object.defineProperty(e,"_parameterNames",{value:e._parameterNames?.slice()??[],configurable:!0,writable:!0}),e.hasOwnProperty("_parameterBits")||Object.defineProperty(e,"_parameterBits",{value:e._parameterBits?.slice()??[0],configurable:!0,writable:!0}),e._parameterNames.push(i);const s=t.count||2,r=Math.ceil(Math.log2(s)),n=e._parameterBits;let a=0;for(;n[a]+r>16;)a++,a>=n.length&&n.push(0);const o=n[a],l=(1<<r)-1<<o;n[a]+=r,t.count?Object.defineProperty(e,i,{get(){return(this._parameterBits[a]&l)>>o},set(u){if(this[i]!==u){if(this._key=null,this._parameterBits[a]=this._parameterBits[a]&~l|+u<<o&l,typeof u!="number")throw new Ge("internal:invalid-shader-configuration",`Configuration value for ${i} must be a number, got ${typeof u}`);if(t.count==null)throw new Ge("internal:invalid-shader-configuration",`Configuration value for ${i} must provide a count option`)}}}):Object.defineProperty(e,i,{get(){return!!((this._parameterBits[a]&l)>>o)},set(u){if(this[i]!==u&&(this._key=null,this._parameterBits[a]=this._parameterBits[a]&~l|+u<<o&l,typeof u!="boolean"))throw new Ge("internal:invalid-shader-configuration",`Configuration value for ${i} must be boolean, got ${typeof u}`)}})}}let ln=class extends on{constructor(){super(...arguments),this.instancedDoublePrecision=!1,this.hasModelTransformation=!1}},Me=class extends ln{constructor(){super(...arguments),this.output=0,this.oitPass=0,this.hasSlicePlane=!1,this.hasHighlightMixTexture=!1,this.bindType=1,this.instanced=!1,this.writeDepth=!0}};ee([De({count:11})],Me.prototype,"output",void 0),ee([De({count:3})],Me.prototype,"oitPass",void 0),ee([De()],Me.prototype,"hasSlicePlane",void 0),ee([De()],Me.prototype,"hasHighlightMixTexture",void 0);let wt=class{constructor(){this._scale=0,this._angleFactor=0,this._minScale=0}update(e,i,s,r){s?(this._scale=Math.min(s.divisor/(i-s.offset),1),this._angleFactor=cn(e),this._minScale=r!=null?Math.min(s.minPixelSize/r,1):0):(this._scale=1,this._minScale=1,this._angleFactor=1)}apply(e){const{_scale:i,_angleFactor:s,_minScale:r}=this;return e*Ie(K(i,1,s),r,1)}applyVec2(e,i){e[0]=this.apply(i[0]),e[1]=this.apply(i[1])}},Bo=class{constructor(){this.evaluator=new wt,this.alignmentEvaluator=new wt}update(e,i,s,r,n,a){this.evaluator.update(e,i,s,r),this.alignmentEvaluator.update(e,i,n??s,(n?a:null)??r)}};function cn(t){return Math.abs(t)**3}function Uo(t){return!!t&&!0}function Do(t,e,i,s,r,n){let a=i.screenLength*t.pixelRatio;r!=null&&(Jt.update(s,e,r,n),a=Jt.apply(a));const o=a*Math.tan(.5*t.fovY)/(.5*t.fullHeight);return Ie(o*e,i.minWorldLength,i.maxWorldLength)}const un=gs();function Yt(t,e){let i=!1;for(const s in e){const r=e[s];r!==void 0&&(Array.isArray(r)?Array.isArray(t[s])&&un(r,t[s])||(t[s]=r.slice(),i=!0):t[s]!==r&&(i=!0,t[s]=r))}return i}const No={multiply:1,ignore:2,replace:3,tint:4},Jt=new wt;let Ho=class{constructor(e,i){this.id=Pt(),this.supportsEdges=!1,this._renderPriority=0,this._parameters=new i,Yt(this._parameters,e),this.validateParameters(this._parameters)}get parameters(){return this._parameters}update(e){return!1}setParameters(e,i=!0){Yt(this._parameters,e)&&(this.validateParameters(this._parameters),i&&this._parametersChanged())}validateParameters(e){}shouldRender(e){return this.visible&&this.isVisibleForOutput(e.output)&&(!this.parameters.isDecoration||e.bind.decorations)&&(this.parameters.renderOccluded&e.renderOccludedMask)!==0}isVisibleForOutput(e){return!0}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this._parametersChanged())}_parametersChanged(){this.repository?.materialChanged(this)}get renderOccludedFlags(){return this.visible?this.parameters.renderOccluded:0}get hasEmissions(){return!1}getConfiguration(e,i,s=new Me){return s.output=e,s.hasHighlightMixTexture=e===9&&i.highlightMixTexture!=null,s}},Ro=class extends kt{constructor(){super(...arguments),this.renderOccluded=1,this.isDecoration=!1}};const hn=Sr(1,0,1,771);function qo(t,e=!1){switch(t){case 0:return e?Ci:Cr;case 1:return hn;case 2:case 3:return null}}function Go(t){if(t.draped)return null;switch(t.oitPass){case 0:case 2:return t.writeDepth?wr:null;case 1:case 3:return null}}const Wo=5e5,dn={factor:-1,units:-2};function Xo({oitPass:t,enableOffset:e}){return e&&t===1?dn:null}function Ko(t,e=513){return t===0||t===2?e:515}function Yo(t,e){const i=Tt(e);return t===1?i?{buffers:[st,rt,vs]}:{buffers:[st,rt]}:i?{buffers:[st,rt]}:null}function Jo(t,e,i,s=1){const{data:r,indices:n}=t,a=e.typedBuffer,o=e.typedBufferStride,l=n.length;if(i*=o,s===1)for(let u=0;u<l;++u)a[i]=r[n[u]],i+=o;else for(let u=0;u<l;++u){const c=r[n[u]];for(let h=0;h<s;h++)a[i]=c,i+=o}}function at(t,e,i){const{data:s,indices:r}=t,n=e.typedBuffer,a=e.typedBufferStride,o=r.length;i*=a;for(let l=0;l<o;++l){const u=2*r[l];n[i]=s[u],n[i+1]=s[u+1],i+=a}}function Lt(t,e,i,s=1){const{data:r,indices:n}=t,a=e.typedBuffer,o=e.typedBufferStride,l=n.length;if(i*=o,s===1)for(let u=0;u<l;++u){const c=3*n[u];a[i]=r[c],a[i+1]=r[c+1],a[i+2]=r[c+2],i+=o}else for(let u=0;u<l;++u){const c=3*n[u];for(let h=0;h<s;++h)a[i]=r[c],a[i+1]=r[c+1],a[i+2]=r[c+2],i+=o}}function Ii(t,e,i,s=1){const{data:r,indices:n}=t,a=e.typedBuffer,o=e.typedBufferStride,l=n.length;if(i*=o,s===1)for(let u=0;u<l;++u){const c=4*n[u];a[i]=r[c],a[i+1]=r[c+1],a[i+2]=r[c+2],a[i+3]=r[c+3],i+=o}else for(let u=0;u<l;++u){const c=4*n[u];for(let h=0;h<s;++h)a[i]=r[c],a[i+1]=r[c+1],a[i+2]=r[c+2],a[i+3]=r[c+3],i+=o}}function Zo(t,e,i){const s=t.typedBuffer,r=t.typedBufferStride;e*=r;for(let n=0;n<i;++n)s[e]=0,s[e+1]=0,s[e+2]=0,s[e+3]=0,e+=r}function fn(t,e,i,s,r=1){if(!e)return void Lt(t,i,s,r);const{data:n,indices:a}=t,o=i.typedBuffer,l=i.typedBufferStride,u=a.length,c=e[0],h=e[1],m=e[2],g=e[4],d=e[5],_=e[6],M=e[8],b=e[9],A=e[10],S=e[12],z=e[13],L=e[14];s*=l;let V=0,C=0,w=0;const $=fi(e)?y=>{V=n[y]+S,C=n[y+1]+z,w=n[y+2]+L}:y=>{const v=n[y],P=n[y+1],x=n[y+2];V=c*v+g*P+M*x+S,C=h*v+d*P+b*x+z,w=m*v+_*P+A*x+L};if(r===1)for(let y=0;y<u;++y)$(3*a[y]),o[s]=V,o[s+1]=C,o[s+2]=w,s+=l;else for(let y=0;y<u;++y){$(3*a[y]);for(let v=0;v<r;++v)o[s]=V,o[s+1]=C,o[s+2]=w,s+=l}}function mn(t,e,i,s,r=1){if(!e)return void Lt(t,i,s,r);const{data:n,indices:a}=t,o=e,l=i.typedBuffer,u=i.typedBufferStride,c=a.length,h=o[0],m=o[1],g=o[2],d=o[4],_=o[5],M=o[6],b=o[8],A=o[9],S=o[10],z=!mi(o),L=1e-6,V=1-L;s*=u;let C=0,w=0,$=0;const y=fi(o)?v=>{C=n[v],w=n[v+1],$=n[v+2]}:v=>{const P=n[v],x=n[v+1],k=n[v+2];C=h*P+d*x+b*k,w=m*P+_*x+A*k,$=g*P+M*x+S*k};if(r===1)if(z)for(let v=0;v<c;++v){y(3*a[v]);const P=C*C+w*w+$*$;if(P<V&&P>L){const x=1/Math.sqrt(P);l[s]=C*x,l[s+1]=w*x,l[s+2]=$*x}else l[s]=C,l[s+1]=w,l[s+2]=$;s+=u}else for(let v=0;v<c;++v)y(3*a[v]),l[s]=C,l[s+1]=w,l[s+2]=$,s+=u;else for(let v=0;v<c;++v){if(y(3*a[v]),z){const P=C*C+w*w+$*$;if(P<V&&P>L){const x=1/Math.sqrt(P);C*=x,w*=x,$*=x}}for(let P=0;P<r;++P)l[s]=C,l[s+1]=w,l[s+2]=$,s+=u}}function pn(t,e,i,s,r=1){if(!e)return void Ii(t,i,s,r);const{data:n,indices:a}=t,o=e,l=i.typedBuffer,u=i.typedBufferStride,c=a.length,h=o[0],m=o[1],g=o[2],d=o[4],_=o[5],M=o[6],b=o[8],A=o[9],S=o[10],z=!mi(o),L=1e-6,V=1-L;if(s*=u,r===1)for(let C=0;C<c;++C){const w=4*a[C],$=n[w],y=n[w+1],v=n[w+2],P=n[w+3];let x=h*$+d*y+b*v,k=m*$+_*y+A*v,B=g*$+M*y+S*v;if(z){const U=x*x+k*k+B*B;if(U<V&&U>L){const W=1/Math.sqrt(U);x*=W,k*=W,B*=W}}l[s]=x,l[s+1]=k,l[s+2]=B,l[s+3]=P,s+=u}else for(let C=0;C<c;++C){const w=4*a[C],$=n[w],y=n[w+1],v=n[w+2],P=n[w+3];let x=h*$+d*y+b*v,k=m*$+_*y+A*v,B=g*$+M*y+S*v;if(z){const U=x*x+k*k+B*B;if(U<V&&U>L){const W=1/Math.sqrt(U);x*=W,k*=W,B*=W}}for(let U=0;U<r;++U)l[s]=x,l[s+1]=k,l[s+2]=B,l[s+3]=P,s+=u}}function gn(t,e,i,s,r=1){const{data:n,indices:a}=t,o=i.typedBuffer,l=i.typedBufferStride,u=a.length;if(s*=l,e===n.length&&e===4){o[s]=n[0],o[s+1]=n[1],o[s+2]=n[2],o[s+3]=n[3];const c=new Uint32Array(i.typedBuffer.buffer,i.start),h=l/4,m=c[s/=4];s+=h;const g=u*r;for(let d=1;d<g;++d)c[s]=m,s+=h;return}if(r!==1)if(e!==4)for(let c=0;c<u;++c){const h=3*a[c];for(let m=0;m<r;++m)o[s]=n[h],o[s+1]=n[h+1],o[s+2]=n[h+2],o[s+3]=255,s+=l}else for(let c=0;c<u;++c){const h=4*a[c];for(let m=0;m<r;++m)o[s]=n[h],o[s+1]=n[h+1],o[s+2]=n[h+2],o[s+3]=n[h+3],s+=l}else{if(e===4){for(let c=0;c<u;++c){const h=4*a[c];o[s]=n[h],o[s+1]=n[h+1],o[s+2]=n[h+2],o[s+3]=n[h+3],s+=l}return}for(let c=0;c<u;++c){const h=3*a[c];o[s]=n[h],o[s+1]=n[h+1],o[s+2]=n[h+2],o[s+3]=255,s+=l}}}function vn(t,e,i){const{data:s,indices:r}=t,n=e.typedBuffer,a=e.typedBufferStride,o=r.length,l=s[0];i*=a;for(let u=0;u<o;++u)n[i]=l,i+=a}function Qo(t,e,i,s){_e(he,t,e);const r=Math.max(Math.sqrt(le(he)),1e-4);O(he,he,1/r),i[s++]=he[0],i[s++]=he[1],i[s++]=he[2],i[s++]=r}const he=p();function $n(t,e,i,s,r=1){const n=e.typedBuffer,a=e.typedBufferStride;if(s*=a,r===1)for(let o=0;o<i;++o)n[s]=t[0],n[s+1]=t[1],n[s+2]=t[2],n[s+3]=t[3],s+=a;else for(let o=0;o<i;++o)for(let l=0;l<r;++l)n[s]=t[0],n[s+1]=t[1],n[s+2]=t[2],n[s+3]=t[3],s+=a}function el(t,e,i,s,r,n,a){let o={numItems:0,numVerticesPerItem:0};for(const l of i.fields.keys()){const u=t.get(l),c=u?.indices;if(u&&c)l==="position"&&(o={numItems:1,numVerticesPerItem:c.length}),bn(l,u,s,r,n,a);else if(l==="olidColor"&&e!=null){const h=t.get("position")?.indices;if(h){const m=h.length;$n(e,n.getField(l,Si),m,a)}}}return o}function bn(t,e,i,s,r,n){switch(t){case"position":{F(e.size===3);const a=r.getField(t,nt);F(!!a,`No buffer view for ${t}`),fn(e,i,a,n);break}case"normal":{F(e.size===3);const a=r.getField(t,nt);F(!!a,`No buffer view for ${t}`),mn(e,s,a,n);break}case"normalCompressed":case"profileRight":case"profileUp":{F(e.size===2);const a=r.getField(t,Kt);F(!!a,`No buffer view for ${t}`),at(e,a,n);break}case"uv0":{F(e.size===2);const a=r.getField(t,xr)??r.getField(t,_r);F(!!a,`No buffer view for ${t}`),at(e,a,n);break}case"uvi":{F(e.size===2);const a=r.getField(t,Kt);F(!!a,`No buffer view for ${t}`),at(e,a,n);break}case"color":case"symbolColor":{const a=r.getField(t,Si);F(!!a,`No buffer view for ${t}`),F(e.size===3||e.size===4),gn(e,e.size,a,n);break}case"colorFeatureAttribute":case"opacityFeatureAttribute":case"sizeFeatureAttribute":{const a=r.getField(t,Xt)??r.getField(t,Xt);F(!!a,`No buffer view for ${t}`),F(e.size===1),vn(e,a,n);break}case"tangent":{F(e.size===4);const a=r.getField(t,Wt);F(!!a,`No buffer view for ${t}`),pn(e,i,a,n);break}case"profileVertexAndNormal":{F(e.size===4);const a=r.getField(t,yr)??r.getField(t,Wt);F(!!a,`No buffer view for ${t}`),Ii(e,a,n);break}case"profileAuxData":{F(e.size===3);const a=r.getField(t,br)??r.getField(t,nt);F(!!a,`No buffer view for ${t}`),Lt(e,a,n);break}}}let T=class{constructor(e,i,s,r,n=null){if(this.name=e,this.type=i,this.arraySize=n,this.bind={0:null,1:null,2:null},r)switch(s){case void 0:break;case 0:this.bind[0]=r;break;case 1:this.bind[1]=r;break;case 2:this.bind[2]=r}}equals(e){return this.type===e.type&&this.name===e.name&&this.arraySize===e.arraySize}},yn=class extends T{constructor(e,i,s){super(e,"float",0,(r,n)=>r.setUniform1f(e,i(n),s))}},re=class extends T{constructor(e,i,s){super(e,"vec3",2,(r,n,a,o)=>r.setUniform3fv(e,i(n,a,o),s))}},Q=class extends T{constructor(e,i,s){super(e,"vec3",1,(r,n,a)=>r.setUniform3fv(e,i(n,a),s))}},xn=class extends T{constructor(e,i,s){super(e,"mat3",1,(r,n,a)=>r.setUniformMatrix3fv(e,i(n,a),s))}},al=class extends T{constructor(e,i,s){super(e,"mat4",1,(r,n,a)=>r.setUniformMatrix4fv(e,i(n,a),s))}},ll=class{constructor(e,i){this._module=e,this._load=i}get(){return this._module}async reload(){return this._module=await this._load(),this._module}},Zt=class{constructor(e,i,s){this._context=e,this.locations=s,this._textures=new Map,this.source=vt()?i:null,i.attributeNames.forEach(r=>{s.has(r)||console.error(`Missing VertexAttributeLocation for ${r} used in shader`)}),this._glProgram=e.programCache.acquire(i.generate("vertex",!0),i.generate("fragment",!0),s),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bind=i.generateBind(this),this.bindPass=i.generateBindPass(this),this.bindDraw=i.generateBindDraw(this)}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(e,i){this._glProgram.setUniform1i(e,i?1:0)}setUniform1i(e,i){this._glProgram.setUniform1i(e,i)}setUniform1f(e,i,s){this._glProgram.setUniform1f(e,i,s)}setUniform2fv(e,i,s){this._glProgram.setUniform2fv(e,i,s)}setUniform3fv(e,i,s){this._glProgram.setUniform3fv(e,i,s)}setUniform4fv(e,i,s){this._glProgram.setUniform4fv(e,i,s)}setUniformMatrix3fv(e,i,s){this._glProgram.setUniformMatrix3fv(e,i,!1,s)}setUniformMatrix4fv(e,i,s){this._glProgram.setUniformMatrix4fv(e,i,!1,s)}setUniformMatrices4fv(e,i,s){this._glProgram.setUniformMatrices4fv(e,i,!1,s)}setUniform1fv(e,i,s){this._glProgram.setUniform1fv(e,i,s)}setUniform1iv(e,i){this._glProgram.setUniform1iv(e,i)}setUniform2iv(e,i){this._glProgram.setUniform2iv(e,i)}setUniform3iv(e,i){this._glProgram.setUniform3iv(e,i)}setUniform4iv(e,i){this._glProgram.setUniform4iv(e,i)}assertCompatibleVertexAttributeLocations(e,i){let s=e.locations;if(i){const r=new Map(s);i.forEach((n,a)=>r.set(a,s.size+n)),s=r}s.size!==this.locations.size&&console.error(`VertexAttributeLocations are incompatible: ${s}, ${this.locations}`),this.locations.forEach((r,n)=>{s.get(n)!==r&&console.error(`VertexAttributeLocations are incompatible: Program has ${n} at position ${r}, VAO has it at position ${s.get(n)}.`)})}stop(){this._textures.clear()}bindTexture(e,i){i?.glName||(vt()&&console.error(`Texture sampler ${e} has no given Texture in ${new Error().stack} `),i=this._context.emptyTexture);const s=this._ensureTextureUnit(e,i);this._context.useProgram(this),this.setUniform1i(e,s.unit),this._context.bindTexture(i,s.unit)}_ensureTextureUnit(e,i){let s=this._textures.get(e);return s==null?(s={texture:i,unit:this._textures.size},this._textures.set(e,s)):s.texture=i,s}};const _n=()=>hi.getLogger("esri.views.3d.webgl.ShaderTechnique");let hl=class{constructor(e,i,s,r){this.primitiveType=$s.TRIANGLES,this.key=i.key,this._program=new Zt(e.rctx,s.get().build(i),r),this._pipeline=this.initializePipeline(i),this.reload=async n=>{n&&await s.reload(),this.key.equals(i.key)||_n().warn("Configuration was changed after construction, cannot reload shader.",s),Bt(this._program),this._program=new Zt(e.rctx,s.get().build(i),r),this._pipeline=this.initializePipeline(i)}}destroy(){this._program=Bt(this._program),this._pipeline=null}get program(){return this._program}get compiled(){return this.program.compiled}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}getPipeline(e,i){return this._pipeline}initializePipeline(e){return zr({blending:Ci,colorWrite:Pr})}};function fl(t,e){return rn(t)?{buffers:[bs]}:e??null}function wn(){return!!ys("enable-feature:objectAndLayerId-rendering")}const ml={func:513},pl={func:519},gl={mask:255},vl={mask:0},$l={function:{func:519,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:0}},bl={function:{func:519,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7681}},yl={function:{func:514,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7680}},xl={function:{func:517,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7680}};function _l(t,e){Cn(t,e,new re("slicePlaneOrigin",(i,s)=>Di(e,i,s)),new re("slicePlaneBasis1",(i,s)=>Je(e,i,s,s.slicePlane?.basis1)),new re("slicePlaneBasis2",(i,s)=>Je(e,i,s,s.slicePlane?.basis2)))}function wl(t,e){Oi(t,e,new re("slicePlaneOrigin",(i,s)=>Di(e,i,s)),new re("slicePlaneBasis1",(i,s)=>Je(e,i,s,s.slicePlane?.basis1)),new re("slicePlaneBasis2",(i,s)=>Je(e,i,s,s.slicePlane?.basis2)))}const Sn=f`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
bool rejectBySlice(vec3 pos) {
return sliceByPlane(pos);
}`;function Oi(t,e,...i){e.hasSlicePlane?(t.uniforms.add(...i),t.code.add(Sn)):t.code.add("bool rejectBySlice(vec3 pos) { return false; }")}function Cn(t,e,...i){Oi(t,e,...i),e.hasSlicePlane?t.code.add(`
    void discardBySlice(vec3 pos) {
      if (sliceByPlane(pos)) {
        discard;
      }
    }

    vec4 applySliceOutline(vec4 color, vec3 pos) {
      SliceFactors factors = calculateSliceFactors(pos);

      factors.front /= 2.0 * fwidth(factors.front);
      factors.side0 /= 2.0 * fwidth(factors.side0);
      factors.side1 /= 2.0 * fwidth(factors.side1);
      factors.side2 /= 2.0 * fwidth(factors.side2);
      factors.side3 /= 2.0 * fwidth(factors.side3);

      // return after calling fwidth, to avoid aliasing caused by discontinuities in the input to fwidth
      if (sliceByFactors(factors)) {
        return color;
      }

      float outlineFactor = (1.0 - step(0.5, factors.front))
        * (1.0 - step(0.5, factors.side0))
        * (1.0 - step(0.5, factors.side1))
        * (1.0 - step(0.5, factors.side2))
        * (1.0 - step(0.5, factors.side3));

      return mix(color, vec4(vec3(0.0), color.a), outlineFactor * 0.3);
    }

    vec4 applySlice(vec4 color, vec3 pos) {
      return sliceEnabled() ? applySliceOutline(color, pos) : color;
    }
  `):t.code.add(f`void discardBySlice(vec3 pos) { }
vec4 applySlice(vec4 color, vec3 pos) { return color; }`)}function Bi(t,e,i){return t.instancedDoublePrecision?D(zn,i.camera.viewInverseTransposeMatrix[3],i.camera.viewInverseTransposeMatrix[7],i.camera.viewInverseTransposeMatrix[11]):e.slicePlaneLocalOrigin}function Vi(t,e){return t!=null?_e(Ze,e.origin,t):e.origin}function Ui(t,e,i){return t.hasSliceTranslatedView?e!=null?Ye(Pn,i.camera.viewMatrix,e):i.camera.viewMatrix:null}function Di(t,e,i){if(i.slicePlane==null)return Fe;const s=Bi(t,e,i),r=Vi(s,i.slicePlane),n=Ui(t,s,i);return n!=null?ce(Ze,r,n):r}function Je(t,e,i,s){if(s==null||i.slicePlane==null)return Fe;const r=Bi(t,e,i),n=Vi(r,i.slicePlane),a=Ui(t,r,i);return a!=null?(q(we,s,n),ce(Ze,n,a),ce(we,we,a),_e(we,we,Ze)):s}const zn=p(),Ze=p(),we=p(),Pn=pe();let Ni=class extends T{constructor(e,i,s){super(e,"vec2",0,(r,n)=>r.setUniform2fv(e,i(n),s))}};function et(t){t.code.add(f`struct MaskedColor {
vec4 color;
bvec4 mask;
};`)}function Cl(t){t.include(et),t.code.add(f`
    MaskedColor createMaskedFromUInt8NaNColor(vec4 color) {
      return MaskedColor(color * ${f.float(1/254)}, equal(color, vec4(255)));
    }
  `)}function Mn(t){t.include(et),t.code.add(f`vec4 maskedColorSelectOrOne(MaskedColor color) {
return vec4(
color.mask.r ? 1.0 : color.color.r,
color.mask.g ? 1.0 : color.color.g,
color.mask.b ? 1.0 : color.color.b,
color.mask.a ? 1.0 : color.color.a
);
}
MaskedColor multiplyMaskedColors(MaskedColor color1, MaskedColor color2) {
vec4 masked1 = maskedColorSelectOrOne(color1);
vec4 masked2 = maskedColorSelectOrOne(color2);
return MaskedColor(masked1 * masked2, bvec4(ivec4(color1.mask) & ivec4(color2.mask)));
}`)}function An(t){t.include(et),t.code.add(f`MaskedColor createMaskedFromNaNColor(vec4 color) {
return MaskedColor(color, isnan(color));
}`)}let Fn=class extends T{constructor(e,i,s){super(e,"vec3",0,(r,n)=>r.setUniform3fv(e,i(n),s))}},We=class extends T{constructor(e,i,s){super(e,"mat4",0,(r,n)=>r.setUniformMatrix4fv(e,i(n),s))}},Tn=class extends T{constructor(e,i,s){super(e,"mat4",2,(r,n,a)=>r.setUniformMatrix4fv(e,i(n,a),s))}};function Al(t,e){e.instancedDoublePrecision?t.constants.add("cameraPosition","vec3",Fe):t.uniforms.add(new re("cameraPosition",(i,s)=>D(Hi,s.camera.viewInverseTransposeMatrix[3]-i.origin[0],s.camera.viewInverseTransposeMatrix[7]-i.origin[1],s.camera.viewInverseTransposeMatrix[11]-i.origin[2])))}function Fl(t,e){if(!e.instancedDoublePrecision)return void t.uniforms.add(new We("proj",s=>s.camera.projectionMatrix),new Tn("view",(s,r)=>Ye(Qt,r.camera.viewMatrix,s.origin)),new re("localOrigin",s=>s.origin));const i=({camera:s})=>D(Hi,s.viewInverseTransposeMatrix[3],s.viewInverseTransposeMatrix[7],s.viewInverseTransposeMatrix[11]);t.uniforms.add(new We("proj",s=>s.camera.projectionMatrix),new We("view",s=>Ye(Qt,s.camera.viewMatrix,i(s))),new Fn("localOrigin",s=>i(s)))}const Qt=pe(),Hi=p();function Tl(t){t.uniforms.add(new We("viewNormal",e=>e.camera.viewInverseTransposeMatrix))}function kl(t){t.uniforms.add(new yn("pixelRatio",e=>e.camera.pixelRatio/e.overlayStretch))}function Ll(t,e,i){for(let s=0;s<i;++s)e[2*s]=t[s],e[2*s+1]=t[s]-e[2*s]}function Il(t,e){const i=t.length;for(let s=0;s<i;++s)ye[0]=t[s],e[s]=ye[0];return e}function Ol(t,e){const i=t.length;for(let s=0;s<i;++s)ye[0]=t[s],ye[1]=t[s]-ye[0],e[s]=ye[1];return e}const ye=new Float32Array(2);let Bl=class extends T{constructor(e,i){super(e,"int",1,(s,r,n)=>s.setUniform1i(e,i(r,n)))}};function kn(t,e){switch(e.textureCoordinateType){case 1:return t.attributes.add("uv0","vec2"),t.varyings.add("vuv0","vec2"),void t.vertex.code.add(f`void forwardTextureCoordinates() { vuv0 = uv0; }`);case 2:return t.attributes.add("uv0","vec2"),t.attributes.add("uvRegion","vec4"),t.varyings.add("vuv0","vec2"),t.varyings.add("vuvRegion","vec4"),void t.vertex.code.add(f`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`);default:xs(e.textureCoordinateType);case 0:return void t.vertex.code.add(f`void forwardTextureCoordinates() {}`);case 3:return}}function Ul(t){t.vertex.code.add(f`float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {
return absCosAngle * absCosAngle * absCosAngle;
}`),t.vertex.code.add(f`vec3 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec3 params) {
return vec3(
min(params.x / (distanceToCamera - params.y), 1.0),
screenSizePerspectiveViewAngleDependentFactor(absCosAngle),
params.z
);
}`),t.vertex.code.add(f`float applyScreenSizePerspectiveScaleFactorFloat(float size, vec3 factor) {
return size * clamp(mix(factor.x, 1.0, factor.y), factor.z, 1.0);
}`),t.vertex.code.add(f`float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec3 params) {
return applyScreenSizePerspectiveScaleFactorFloat(
size,
screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)
);
}`),t.vertex.code.add(f`vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec3 factor) {
return size * clamp(mix(factor.x, 1.0, factor.y), factor.z, 1.0);
}`),t.vertex.code.add(f`vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec3 params) {
return applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));
}`)}function Dl(t){t.uniforms.add(new Q("screenSizePerspective",e=>ji(e.screenSizePerspective,e.screenSizePerspectiveMinPixelReferenceSize)))}function Nl(t){t.uniforms.add(new Q("screenSizePerspectiveAlignment",e=>ji(e.screenSizePerspectiveAlignment||e.screenSizePerspective,e.screenSizePerspectiveAlignment?null:e.screenSizePerspectiveMinPixelReferenceSize)))}function ji(t,e){const i=e!=null&&t!=null?Math.min(t.minPixelSize/e,1):0;return t?D(ei,t.divisor,t.offset,i):D(ei,0,0,0)}const ei=p();let Ln=class extends T{constructor(e,i,s){super(e,"vec4",1,(r,n,a)=>r.setUniform4fv(e,i(n,a),s))}};function jl(t,e){if(e.output!==10)return t.vertex.code.add(f`void forwardObjectAndLayerIdColor() {}`),void t.fragment.code.add(f`void outputObjectAndLayerIdColor() {}`);const i=e.instanced;t.varyings.add("objectAndLayerIdColorVarying","vec4");const s=i?"instanceOlidColor":"olidColor";t.attributes.add(s,"vec4"),t.vertex.code.add(f`
    void forwardObjectAndLayerIdColor() {
      objectAndLayerIdColorVarying = ${s} * 0.003921568627451;
    }`),t.fragment.code.add(f`void outputObjectAndLayerIdColor() {
fragColor = objectAndLayerIdColorVarying;
}`)}function In(t){const{fragment:e}=t;e.code.add(f`uint readChannelBits(uint channel, int highlightLevel) {
int llc = (highlightLevel & 3) << 1;
return (channel >> llc) & 3u;
}
uint readChannel(uvec2 texel, int highlightLevel) {
int lic = (highlightLevel >> 2) & 1;
return texel[lic];
}
uint readLevelBits(uvec2 texel, int highlightLevel) {
return readChannelBits(readChannel(texel, highlightLevel), highlightLevel);
}`)}let On=class extends T{constructor(e,i){super(e,"ivec2",0,(s,r)=>s.setUniform2iv(e,i(r)))}},Bn=class extends T{constructor(e,i){super(e,"int",0,(s,r)=>s.setUniform1i(e,i(r)))}},Ri=class extends T{constructor(e,i){super(e,"sampler2D",0,(s,r)=>s.bindTexture(e,i(r)))}},Vn=class extends T{constructor(e,i){super(e,"usampler2D",0,(s,r)=>s.bindTexture(e,i(r)))}};function Un(t,e){const{fragment:i}=t,{output:s,draped:r,hasHighlightMixTexture:n}=e;s===9?(i.uniforms.add(new Bn("highlightLevel",a=>a.highlightLevel??0),new On("highlightMixOrigin",a=>a.highlightMixOrigin)),t.outputs.add("fragHighlight","uvec2",0),t.include(In),n?i.uniforms.add(new Vn("highlightMixTexture",a=>a.highlightMixTexture)).code.add(f`uvec2 getAccumulatedHighlight() {
return texelFetch(highlightMixTexture, ivec2(gl_FragCoord.xy) - highlightMixOrigin, 0).rg;
}
void outputHighlight(bool occluded) {
if (highlightLevel == 0) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
} else {
int ll = (highlightLevel & 3) << 1;
int li = (highlightLevel >> 2) & 3;
uint bits;
if (occluded) {
bits = 3u << ll;
} else {
bits = 1u << ll;
}
uvec2 combinedHighlight = getAccumulatedHighlight();
combinedHighlight[li] |= bits;
fragHighlight = combinedHighlight;
}
}`):i.code.add(f`void outputHighlight(bool occluded) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
}`),r?i.code.add(f`bool isHighlightOccluded() {
return false;
}`):i.uniforms.add(new Ri("depthTexture",a=>a.mainDepth)).code.add(f`bool isHighlightOccluded() {
float sceneDepth = texelFetch(depthTexture, ivec2(gl_FragCoord.xy), 0).x;
return gl_FragCoord.z > sceneDepth + 5e-7;
}`),i.code.add(f`void calculateOcclusionAndOutputHighlight() {
outputHighlight(isHighlightOccluded());
}`)):i.code.add(f`void calculateOcclusionAndOutputHighlight() {}`)}let Dn=class extends T{constructor(e,i,s,r){super(e,"vec4",1,(n,a,o)=>n.setUniform4fv(e,i(a,o),r),s)}},Nn=class extends T{constructor(e,i,s,r){super(e,"float",1,(n,a,o)=>n.setUniform1fv(e,i(a,o),r),s)}},It=class{constructor(e){this.field=e}},Hn=class extends It{constructor(e){super(e),this.minSize=[0,0,0],this.maxSize=[0,0,0],this.offset=[0,0,0],this.factor=[0,0,0],this.type=[0,0,0],this.fallback=[0,0,0]}},ti=class extends It{constructor(e){super(e),this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.values=[0,0,0,0,0,0,0,0],this.fallback=[0,0,0,0]}};class jn extends It{constructor(e,i=0){super(e),this.fallback=i,this.values=[0,0,0,0,0,0,0,0],this.opacityValues=[0,0,0,0,0,0,0,0]}}class Rn{}function Se(t){return t!=null}function En(t,e,i,s=pe()){const r=t||0,n=e||0,a=i||0;return r!==0&&ks(s,s,-r/180*Math.PI),n!==0&&pi(s,s,n/180*Math.PI),a!==0&&Ls(s,s,a/180*Math.PI),s}function ne(t,e,i,s,r){const n=t.minSize,a=t.maxSize;if(t.useSymbolValue){const o=s.symbolSize[i];return e.minSize[i]=o,e.maxSize[i]=o,e.offset[i]=e.minSize[i],e.factor[i]=0,e.type[i]=1,!0}if(Se(t.field))return Se(t.stops)?t.stops.length===2&&ge(t.stops[0].size)&&ge(t.stops[1].size)?(ii(t.stops[0].size,t.stops[1].size,t.stops[0].value,t.stops[1].value,e,i),e.type[i]=1,!0):!1:ge(n)&&ge(a)&&Se(t.minDataValue)&&Se(t.maxDataValue)?(ii(n,a,t.minDataValue,t.maxDataValue,e,i),e.type[i]=1,!0):t.valueUnit==="unknown"?!1:Ut[t.valueUnit]!=null?(e.minSize[i]=-1/0,e.maxSize[i]=1/0,e.offset[i]=0,e.factor[i]=1/Ut[t.valueUnit],e.type[i]=1,!0):!1;if(!Se(t.field)){if(t.stops?.[0]&&ge(t.stops[0].size))return e.minSize[i]=t.stops[0].size,e.maxSize[i]=t.stops[0].size,e.offset[i]=e.minSize[i],e.factor[i]=0,e.type[i]=1,!0;if(ge(n))return e.minSize[i]=n,e.maxSize[i]=n,e.offset[i]=n,e.factor[i]=0,e.type[i]=1,!0}return!1}function ii(t,e,i,s,r,n){const a=Math.abs(s-i)>0?(e-t)/(s-i):0;r.minSize[n]=a>0?t:e,r.maxSize[n]=a>0?e:t,r.offset[n]=t-i*a,r.factor[n]=a}function qn(t,e,i,s){if(t.normalizationField||t.valueRepresentation||!Ts(t.field))return null;if(e.size){if(t.field)if(e.size.field){if(t.field!==e.size.field)return null}else e.size.field=t.field}else e.size=new Hn(t.field),j(e.size.fallback,i.fallbackSize);let r;switch(t.axis){case"width":return r=ne(t,e.size,0,i),r?e:null;case"height":return r=ne(t,e.size,2,i),r?e:null;case"depth":return r=ne(t,e.size,1,i),r?e:null;case"width-and-depth":return r=ne(t,e.size,0,i),r&&ne(t,e.size,1,i),r?e:null;case null:case void 0:case"all":return r=ne(t,e.size,0,i),r=r&&ne(t,e.size,1,i),r=r&&ne(t,e.size,2,i),r?e:null;default:return`${t.axis}`,null}}function Gn(t,e,i){for(let r=0;r<3;++r){let n=e.unitInMeters;t.type[r]===1&&(n*=e.modelSize[r],t.type[r]=2),t.minSize[r]=t.minSize[r]/n,t.maxSize[r]=t.maxSize[r]/n,t.offset[r]=t.offset[r]/n,t.factor[r]=t.factor[r]/n}let s;if(t.type[0]!==0)s=0;else if(t.type[1]!==0)s=1;else{if(t.type[2]===0)return!1;s=2}for(let r=0;r<3;++r)t.type[r]===0&&(t.minSize[r]=t.minSize[s],t.maxSize[r]=t.maxSize[s],t.offset[r]=t.offset[s],t.factor[r]=t.factor[s],t.type[r]=t.type[s]);return!0}function si(t,e,i){t[4*e]=i.r/255,t[4*e+1]=i.g/255,t[4*e+2]=i.b/255,t[4*e+3]=i.a}function Wn(t,e,i,s){if(t.normalizationField)return null;if(Mt(t.field)){if(!t.stops)return null;{if(t.stops.length>8)return null;e.color=new ti(t.field);const r=t.stops;for(let n=0;n<8;++n){const a=r[Math.min(n,r.length-1)];e.color.values[n]=a.value,si(e.color.colors,n,a.color)}Vt(e.color.fallback,i.fallbackColor)}}else{if(!(t.stops&&t.stops.length>=0))return null;{const r=t.stops&&t.stops.length>=0&&t.stops[0].color;e.color=new ti(null);for(let n=0;n<8;n++)e.color.values[n]=1/0,si(e.color.colors,n,r);Vt(e.color.fallback,i.fallbackColor)}}return e}function Xn(t,e,i,s){if(t.normalizationField)return null;if(Mt(t.field)){if(!t.stops)return null;{if(t.stops.length>8)return null;e.opacity=new jn(t.field,i.fallbackColor[3]);const r=t.stops;for(let n=0;n<8;++n){const a=r[Math.min(n,r.length-1)];e.opacity.values[n]=a.value,e.opacity.opacityValues[n]=a.opacity}}}else{if(!(t.stops&&t.stops.length>=0))return null;{const r=t.stops&&t.stops.length>=0?t.stops[0].opacity:0;e.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0],fallback:i.fallbackColor[3]};for(let n=0;n<8;n++)e.opacity.values[n]=1/0,e.opacity.opacityValues[n]=r}}return e}function ot(t,e,i){const s=i===2&&t.rotationType==="arithmetic";e.offset[i]=s?90:0,e.factor[i]=s?-1:1,e.type[i]=1}function Kn(t,e,i){if(!Mt(t.field))return null;if(e.rotation){if(t.field)if(e.rotation.field){if(t.field!==e.rotation.field)return null}else e.rotation.field=t.field}else e.rotation={field:t.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(t.axis){case"tilt":return ot(t,e.rotation,0),e;case"roll":return ot(t,e.rotation,1),e;case null:case void 0:case"heading":return ot(t,e.rotation,2),e;default:return`${t.axis}`,null}}class Zl{constructor({supports:e,modelSize:i,symbolSize:s,unitInMeters:r,anchor:n,scale:a,rotation:o,fallbackColor:l,fallbackSize:u}){this.supports=e,this.modelSize=i??Oe(),this.symbolSize=s??Oe(),this.unitInMeters=r??1,this.anchor=n??Te(),this.scale=a??Oe(),this.rotation=o??Te(),this.fallbackColor=l??ws(),this.fallbackSize=u??Oe()}}function Ei(t,e,i){if(!t)return null;const s=t.reduce((r,n)=>{if(!r)return r;if(n.valueExpression)return null;switch(n.type){case"size":return e.supports.size?qn(n,r,e,i):r;case"color":return e.supports.color?Wn(n,r,e):r;case"opacity":return e.supports.opacity?Xn(n,r,e):null;case"rotation":return e.supports.rotation?Kn(n,r,i):r;default:return null}},new Rn);return!(t.length>0&&s)||s.size||s.color||s.opacity||s.rotation?s?.size&&!Gn(s.size,e)?null:s:null}class Yn{constructor(e,i,s){this.visualVariables=e,this.materialParameters=i,this.requiresShaderTransformation=s}}function Ql(t,e){if(!t||wn()||_s.TESTS_DISABLE_FAST_UPDATES)return null;const i=Ei(t.visualVariables,e);return i?new Yn(i,Gi(i,e),!!i.size):null}function ec(t,e,i){if(!e||!t)return!1;const s=t.visualVariables,r=Ei(e.visualVariables,i);return!!r&&!!(Ne(s.size,r.size,"size")&&Ne(s.color,r.color,"color")&&Ne(s.rotation,r.rotation,"rotation")&&Ne(s.opacity,r.opacity,"opacity"))&&(t.visualVariables=r,t.materialParameters=Gi(r,i),t.requiresShaderTransformation=!!r.size,!0)}function Ne(t,e,i){if(!!t!=!!e||t&&t.field!==e?.field)return!1;if(t&&i==="rotation"){const s=t,r=e;for(let n=0;n<3;n++)if(s.type[n]!==r.type[n]||s.offset[n]!==r.offset[n]||s.factor[n]!==r.factor[n])return!1}return!0}class qi extends kt{constructor(e){super(),this.vvSize=e?.size??null,this.vvColor=e?.color??null,this.vvOpacity=e?.opacity??null}get hasVVSize(){return!!this.vvSize}get hasVVColor(){return!!this.vvColor}get hasVVOpacity(){return!!this.vvOpacity}}function Gi(t,e){const i=new qi(t);return i.vvSize&&(i.vvSymbolAnchor=e.anchor,Ms(Ae),En(e.rotation[2],e.rotation[0],e.rotation[1],Ae),i.vvSymbolRotationMatrix=i.vvSymbolRotationMatrix||As(),Fs(i.vvSymbolRotationMatrix,Ae)),i}function tc(t,e,i){if(!t.vvSize)return i;Ss(ae,i);const s=t.vvSymbolRotationMatrix;return Cs(Ae,s[0],s[1],s[2],0,s[3],s[4],s[5],0,s[6],s[7],s[8],0,0,0,0,1),zs(ae,ae,Ae),Jn(ri,t,e),Ps(ae,ae,ri),Ye(ae,ae,t.vvSymbolAnchor),ae}function Jn(t,e,i){if(!e.vvSize)return D(t,1,1,1),t;if(Number.isNaN(i[0]))return j(t,e.vvSize.fallback);for(let s=0;s<3;++s){const r=e.vvSize.offset[s]+i[0]*e.vvSize.factor[s];t[s]=Ie(r,e.vvSize.minSize[s],e.vvSize.maxSize[s])}return t}function ic(t,e){const i=t==null?0:e.attributes[t];return typeof i=="number"&&isFinite(i)?i:NaN}const ae=pe(),ri=p(),Ae=pe();let sc=class extends qi{constructor(){super(...arguments),this.renderOccluded=1,this.isDecoration=!1}};const lt=8;function nc(t,e){const{vertex:i,attributes:s}=t;e.hasVVInstancing&&(e.hasVVSize||e.hasVVColor)&&s.add("instanceFeatureAttribute","vec4"),e.hasVVSize?(i.uniforms.add(new Q("vvSizeMinSize",r=>r.vvSize.minSize)),i.uniforms.add(new Q("vvSizeMaxSize",r=>r.vvSize.maxSize)),i.uniforms.add(new Q("vvSizeOffset",r=>r.vvSize.offset)),i.uniforms.add(new Q("vvSizeFactor",r=>r.vvSize.factor)),i.uniforms.add(new Q("vvSizeFallback",r=>r.vvSize.fallback)),i.uniforms.add(new xn("vvSymbolRotationMatrix",r=>r.vvSymbolRotationMatrix)),i.uniforms.add(new Q("vvSymbolAnchor",r=>r.vvSymbolAnchor)),i.code.add(f`vec3 vvScale(vec4 _featureAttribute) {
if (isnan(_featureAttribute.x)) {
return vvSizeFallback;
}
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),i.code.add(f`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 scale = max(vvScale(_featureAttribute), eps);
        return vec4(vvSymbolRotationMatrix * _normal / scale, 1.0);
      }

      ${e.hasVVInstancing?f`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):i.code.add(f`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),t.vertex.include(et),e.hasVVColor?(i.constants.add("vvColorNumber","int",lt),i.uniforms.add(new Nn("vvColorValues",r=>r.vvColor.values,lt),new Dn("vvColorColors",r=>r.vvColor.colors,lt),new Ln("vvColorFallback",r=>r.vvColor.fallback,{supportsNaN:!0})),e.hasVVInstancing&&(t.vertex.include(Mn),t.vertex.include(An)),i.code.add(f`
      vec4 interpolateVVColor(float value) {
        if (isnan(value)) {
          return vvColorFallback;
        }

        if (value <= vvColorValues[0]) {
          return vvColorColors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (vvColorValues[i] >= value) {
            float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
            return mix(vvColorColors[i-1], vvColorColors[i], f);
          }
        }
        return vvColorColors[vvColorNumber - 1];
      }

      vec4 vvGetColor(vec4 featureAttribute) {
        return interpolateVVColor(featureAttribute.y);
      }

      ${e.hasVVInstancing?f`
            vec4 vvColor() {
              return vvGetColor(instanceFeatureAttribute);
            }

            MaskedColor applyVVColor(MaskedColor color) {
              return multiplyMaskedColors(color, createMaskedFromNaNColor(vvColor()));
            }
            `:f`
            vec4 vvColor() {
              return vec4(1.0);
            }

            MaskedColor applyVVColor(MaskedColor color) {
              return color;
            }
            `}
    `)):i.code.add(f`vec4 vvColor() {
return vec4(1.0);
}
MaskedColor applyVVColor(MaskedColor color) {
return color;
}`)}let Zn=class extends T{constructor(e,i,s){super(e,"float",2,(r,n,a)=>r.setUniform1f(e,i(n,a),s))}},Qn=class extends T{constructor(e,i,s){super(e,"float",1,(r,n,a)=>r.setUniform1f(e,i(n,a),s))}};const ea=1/255.5;let ta=class extends T{constructor(e,i){super(e,"sampler2D",1,(s,r,n)=>s.bindTexture(e,i(r,n)))}};function ia(t){t.fragment.code.add(f`vec4 textureAtlasLookup(sampler2D tex, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
return textureGrad(tex, uvAtlas, dUVdx, dUVdy);
}`)}function sa(t,e){const{textureCoordinateType:i}=e;if(i===0||i===3)return;t.include(kn,e);const s=i===2;s&&t.include(ia),t.fragment.code.add(f`
    vec4 textureLookup(sampler2D tex, vec2 uv) {
      return ${s?"textureAtlasLookup(tex, uv, vuvRegion)":"texture(tex, uv)"};
    }
  `)}let cc=class extends T{constructor(e,i,s){super(e,"vec2",1,(r,n,a)=>r.setUniform2fv(e,i(n,a),s))}},ra=class extends T{constructor(e,i){super(e,"sampler2D",2,(s,r,n)=>s.bindTexture(e,i(r,n)))}};var se;let dc=(se=class{constructor(e=1/0,i=-1/0){this.near=e,this.far=i}set(e,i){this.near=e,this.far=i}union(e){e!=null&&(this.near=Math.min(this.near,e.near),this.far=Math.max(this.far,e.far))}within(e){return this.near<=e&&e<=this.far}equals(e){return this.near===e.near&&this.far===e.far}},se.Zero=new se(0,0),se.Infinite=new se,se);function na(t,e){const i=[],s=[];return He(i,t,e,0),He(s,i,e,1),He(i,s,e,2),He(s,i,e,3),s}function He(t,e,i,s){const r=aa(i,s);if(t.length=0,e.length){r(je,e[0],e[0])===1&&Ce(t,e[0]);for(let n=0;n<e.length;n++){const a=e[n===e.length-1?0:n+1];switch(r(je,e[n],a)){case 1:Ce(t,a);break;case 3:Ce(t,Dt(je));break;case 2:Ce(t,Dt(je)),Ce(t,a)}}}}function Ce(t,e){t.length!==0&&Is(t.at(-1),e)||t.push(e)}function aa(t,e){const i=e===0||e===2?0:1,s=t[e],r=e===0||e===1?1:-1,n=i===0?1:0;return(a,o,l)=>{if(o[i]<s&&l[i]<s)return r===1?0:1;if(o[i]>s&&l[i]>s)return r===1?1:0;const u=(l[n]-o[n])/(l[i]-o[i]),c=o[n]+u*(s-o[i]);return a[i]=s,a[n]=c,(o[i]<s?1:-1)*r>0?2:3}}const je=At(),oa=p(),Re=p();function Wi(){return{direction:p(),up:p()}}function Xi(t,e,i,s,r){let n=ke(oa,t),a=Z(n,s);const o=a>0;a=Math.abs(a),a>.99&&(a=Math.abs(Z(e,s)),a<.99?(j(n,e),o&&O(n,n,-1)):n=null);let l=0;if(n){O(Re,s,Z(s,n)),_e(n,n,Re);const c=Z(n,r)/(le(n)*le(r));de(Re,n,r),l=(Z(Re,s)>0?1:-1)*me($t(c))}const u=me($t(-Z(s,t)/le(t)));return i?(i.heading=l,i.tilt=u,i):{heading:l,tilt:u}}function Ki(t,e,i,s){_e(ni,i,e),Os(s,Bs(e,ni),t)||t===i||j(t,i)}const ni=p(),Yi=N(0,1,0),Ji=N(0,0,1),ze=pe(),Y=p(),J=p();function Zi(t,e,i,s=Wi()){const{direction:r,up:n}=s;return Us(ze,-G(e)),pi(ze,ze,G(i)),ce(r,Ji,ze),O(r,r,-1),ce(n,Yi,ze),s}function la(t,e,i,s){return Xi(e,i,s,Ji,Yi)}function ca(t,e,i,s){const r=Zi(t,i,s),n=p();return O(n,r.direction,-e),q(n,n,t),{up:r.up,eye:n,heading:i,tilt:s}}function ua(t){return me(t)}function ha(t){return G(t)}function da(t,e,i,s,r){const n=t.renderSpatialReference,a=t.spatialReference??e.spatialReference;return Nt(e,Y,n),Nt(e,J,n),Y[0]-=i/2,J[0]+=i/2,Y[1]-=s/2,J[1]+=s/2,Ht(Y,n,Y,a),Ht(J,n,J,a),r?(r.xmin=Y[0],r.ymin=Y[1],r.xmax=J[0],r.ymax=J[1],r.spatialReference=a):r=new gi(Y[0],Y[1],J[0],J[1],a),r}function fa(t,e){const i=t.frustum,{renderCoordsHelper:s}=t,r=s.getAltitude(e),n=t.spatialReference,a=t.state.camera.eye,o=[],l=i.planes[5];for(let u=0;u<4;u++){const c=i.lines[u];s.intersectInfiniteManifold(vi(c.origin,c.direction),r,X)||ma(X,i,s,c.endpoint,r),Ki(X,a,X,l),o.push(Vs(X[0],X[1]))}return pa(na(o,s.extent),s,n)}function ma(t,e,i,s,r){const n=e.lines[11].direction,a=(r-i.getAltitude(s))/n[2];bt(t,s,n,a)}function pa(t,e,i){const s=t.map(r=>(D(X,r[0],r[1],0),e.fromRenderCoords(X,X,i),[X[0],X[1]]));return s.length<=2?new yt({spatialReference:i}):(s.push(s[0].slice()),$i(s)||s.reverse(),new yt({rings:[s],spatialReference:i}))}const X=p();Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:la,eyeForCenterWithHeadingTilt:ca,eyeTiltToLookAtTilt:ha,headingTiltToDirectionUp:Zi,lookAtTiltToEyeTilt:ua,toArea:fa,toExtent:da},Symbol.toStringTag,{value:"Module"}));var fe;let ga=(fe=class{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(e){this.renderCoordsHelper=e,this.frustum=Ds(),this._points=Ns(),this.lines=new Array(12),this._origin=p(),this._direction=p(),this._altitude=null;for(let i=0;i<12;i++)this.lines[i]={origin:null,direction:p(),endpoint:null}}update(e){Hs(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),j(this._origin,e.eye),j(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let i=0;i<this._points.length;i++)j(this._points[i],e[i]);js(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return Rs(this.frustum,e)}intersectsRay(e){return Es(this.frustum,e)}intersectsLineSegment(e,i){return qs(this.frustum,e,i)}intersectsPoint(e){return Gs(this.frustum,e)}_updateLines(){const e=this._points;for(let i=0;i<4;i++){const s=i+4;ct(this.lines[i],e[i],e[s]),ct(this.lines[i+4],e[i],i===3?e[0]:e[i+1]),ct(this.lines[i+8],e[s],i===3?e[4]:e[s+1])}}},fe.planePointIndices=Ws,fe.nearFarLineIndices=[[0,4],[1,5],[2,6],[3,7]],fe);function ct(t,e,i){t.origin=e,t.endpoint=i,Xs(t.direction,e,i)}const ut=N(parseFloat(5802e-9.toFixed(6)),parseFloat(13558e-9.toFixed(6)),parseFloat(331e-7.toFixed(6))),ht=3,dt=N(ht*parseFloat(65e-8.toFixed(6)),ht*parseFloat(1881e-9.toFixed(6)),ht*parseFloat(85e-9.toFixed(6)));N(parseFloat(Number(ut[0]+dt[0]).toFixed(6)),parseFloat(Number(ut[1]+dt[1]).toFixed(6)),parseFloat(Number(ut[2]+dt[2]).toFixed(6)));const va=2;bi();Ks();function $a(t,e,i){t.worldUpAtPosition(e,ai),_e(ft,i,e);const s=le(ft);return s===0?0:$t(Z(ft,ai)/s)}const ai=p(),ft=p();function ba(t,e,i){const s=e/i,r=G(t),n=Math.sin(s/2),a=Math.cos(r),o=2*Qe(Math.sqrt(n*n/(a*a)));return me(o)}const Qi=N(0,0,1),es=ke(p(),N(1,1,1)),Pe=pe(),oe=p(),ve=p();function ts(t,e,i,s=Wi()){de(oe,t,Qi),Z(oe,oe)===0&&de(oe,t,es),rr(Pe,-G(e),t),nr(Pe,Pe,-G(i),oe);const{up:r,direction:n}=s;return de(r,oe,t),ke(r,r),ce(r,r,Pe),ke(n,t),xi(n,n),ce(n,n,Pe),s}function ya(t,e,i,s){const r=oe,n=ve;return ke(r,t),de(ve,r,Qi),Z(ve,ve)===0&&de(ve,r,es),de(n,ve,r),Xi(e,i,s,r,n)}function xa(t,e,i,s){const r={eye:p(),up:null,tilt:s,heading:i},n=oe;n[0]=t[0],n[1]=t[2],n[2]=-t[1];const a=e,o=G(i),l=G(s),u=Math.sin(o),c=Math.cos(o),h=Math.sin(l),m=Math.cos(l),g=le(n);let d;if(Math.abs(l)<1e-8)d=a+g;else{const U=g/h,W=Qe(a/U),tt=Math.PI-l-W;d=U*Math.sin(tt)}const _=m*a,M=a*a*(h*h),b=c*c*M,A=d-_,S=A*A,z=b*(b+S-n[1]*n[1]);if(z<0)return O(r.eye,n,d/g),r.tilt=0,Ee(r,t);const L=Math.sqrt(z),V=n[1]*A,C=b+S;let w;if(w=c>0?-L+V:L+V,Math.abs(C)<1e-8)return g<1e-8?(r.eye[0]=0,r.eye[1]=0,r.eye[2]=a):O(r.eye,n,d/g),r.tilt=0,mt(r.eye),Ee(r,t);r.eye[1]=w/C;const $=u*u*M,y=h*a,v=c*y*r.eye[1],P=r.eye[1]*r.eye[1],x=1-P,k=Math.sqrt(x),B=b*P+$-2*v*k*A+x*S;return Math.abs(B)<1e-8?(O(r.eye,n,d/g),r.tilt=0,mt(r.eye),Ee(r,t)):(r.eye[0]=(x*(d*n[0]-_*n[0])-y*k*(n[0]*r.eye[1]*c+n[2]*u))/B,r.eye[2]=(x*(d*n[2]-_*n[2])-y*k*(n[2]*r.eye[1]*c-n[0]*u))/B,O(r.eye,r.eye,d),mt(r.eye),Ee(r,t))}function mt(t){const e=t[1];t[1]=-t[2],t[2]=e}function Ee(t,e){const i=ts(e,t.heading,t.tilt);return t.up=i.up,t}function _a(t,e,i){const s=le(e),r=Math.sqrt(i*i+s*s-2*i*s*Math.cos(Math.PI-t)),n=Qe(i/(r/Math.sin(t)));return me(t-n)}function wa(t,e,i){const s=G(t),r=le(e);return Qe(i/(r/Math.sin(s)))+s}function Sa(t,e,i,s,r){let n,a,o,l;const u=e.latitude,c=Js(t.spatialReference).radius,h=e.longitude,m=ba(u,i,c)/2;n=h-m,a=h+m;const g=G(u),d=(1+Math.sin(g))/(1-Math.sin(g)),_=(d+1)*Math.tan(s/c/2),M=_*_;function b(S){const z=Math.PI/2;return(S=ar.normalize(S,-z))>z&&(S=Math.PI-S),S}if(o=1.5*Math.PI-2*Math.atan(.5*(_+Math.sqrt(4*d+M))),l=o+s/c,o=b(o),l=b(l),l<o){const S=l;l=o,o=S}if(o=Math.max(me(o),-90),l=Math.min(me(l),90),a=Zs.monotonic(n,a),a-n>180){const S=(a-n-180)/2;n+=S,a-=S}const A=t.spatialReference&&t.spatialReference.isGeographic?t.spatialReference:Qs.WGS84;return r?(r.xmin=n,r.ymin=o,r.xmax=a,r.ymax=l,r.spatialReference=A):r=new gi(n,o,a,l,A),t.spatialReference&&t.spatialReference.isWebMercator&&er(r,!1,r),r}function Ca(t,e){const{renderCoordsHelper:i}=t,s=t.state.camera.clone(),r=new ga(i);s.near=va,r.update(s);const n=i.getAltitude(e),a=t.spatialReference,o=i.referenceEllipsoid.radius,l=s.eye,u=1+tr(l,e)/(o+n),c=Math.sqrt(u*u-1),{minCurvature:h,maxCurvature:m,minSamples:g,maxSamples:d}=Aa,_=Ma(t),M=Ie((c-h)/(m-h),0,1),b=Math.round(K(g,d,M)),A=s.aboveGround,S=r.planes[5],z=[],L=jt(Fe,Fa,Rt()),V=jt(Fe,Ta,Rt());xt(pt,0,0,0,0);const C=$=>{};for(let $=0;$<4;$++){const y=$===1&&!A||$===3&&A?1-_:0,v=$===1&&A||$===3&&!A?_:1,P=r.lines[$],x=r.lines[$===3?0:$+1];for(let k=0;k<b;k++){const B=k/b,U=k===0?0:K(y,v,$===1?1-(1-B)**2:$===3?B**2:B),W=Ke(La,P.origin,x.origin,U),tt=ir(P.direction,x.direction,U,ka);i.intersectManifoldClosestSilhouette(vi(W,tt),n,H),Ki(H,l,H,S),z.push(di(H)),z.length!==0&&C(Et(z.at(-1),H));const as=(qt(L,H)?1:0)|(qt(V,H)?2:0);pt[as]=1}}z.length>2&&C(Et(z[0],z.at(-1)));const w=za(sr(pt)>1?Pa(is(z,L),V):[z],i,a);return new yt({rings:w,spatialReference:a})}function za(t,e,i){const s=2*_i();return t.map(r=>{const n=[];let a=!1;for(const o of r)e.fromRenderCoords(o,H,i),Math.abs(o[0])<s&&Math.abs(o[1])<s?(n.push([null,H[1]]),n.push([null,H[1]]),a=!0):n.push([H[0],H[1]]);if(a)for(let o=0;o<n.length;o++){const l=n[o];if(l[0]!=null)continue;const u=n[o+1],c=n.at(o===0?-1:o-1);l[0]=c[0],o++;const h=n.at(o===n.length-1?0:o+1);u[0]=h[0]}return n.push(n[0]),$i(n)||n.reverse(),n})}function Pa(t,e){const i=[];for(const s of t)i.push(...is(s,e));return i}function is(t,e){const i=[],s=[],r=_i();for(let a=0;a<t.length;a++){const o=t[a],l=a===t.length-1?t[0]:t[a+1],u=cr(o,l,Ia),c=ur(e,u.origin,u.vector,0,H);switch(c){case 2:i.push(o);break;case 3:s.push(o);break;case 0:case 1:{const[h,m,g]=c===0?[1,i,s]:[-1,s,i],d=hr(e),_=bt(p(),H,d,h*r),M=bt(p(),H,d,h*-r);m.push(o),m.push(_),g.push(M)}}}const n=[];return i.length&&n.push(i),s.length&&n.push(s),n}function Ma(t){const{renderCoordsHelper:e,state:{camera:i}}=t,{center:s,eye:r}=i,n=Math.abs(e.getAltitude(s)),a=Math.abs(Math.PI/2-$a(e,s,r));return lr(oi,e.referenceEllipsoid.radius+n),or(oi,a,i.distance,i.fovY)}const Aa={minCurvature:G(5),maxCurvature:G(50),minSamples:1,maxSamples:6},Fa=N(1,0,0),Ta=N(0,1,0),ka=p(),La=p(),H=p(),oi=bi(),Ia=Ys(),pt=yi();Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:ya,eyeForCenterWithHeadingTilt:xa,eyeTiltToLookAtTilt:wa,headingTiltToDirectionUp:ts,lookAtTiltToEyeTilt:_a,toArea:Ca,toExtent:Sa},Symbol.toStringTag,{value:"Module"}));const Oa={COMPOSITE:"composite-color"},fc={SSAO:"ssao",LASERLINES:"laserline-color",HIGHLIGHTS:"highlight-color"};let $e=class extends dr{constructor(e){super(e),this.view=null,this.consumes={required:[]},this.produces=Oa.COMPOSITE,this.requireGeometryDepth=!1,this._dirty=!0}initialize(){this.addHandles([fr(()=>this.view.ready,e=>{e&&this.view.stage?.renderer.addRenderNode(this)},mr)])}destroy(){this.view.stage?.renderer?.removeRenderNode(this)}precompile(){}render(){throw new Ge("RenderNode:render-function-not-implemented","render() is not implemented.")}get camera(){return this.view.state.camera.clone()}get sunLight(){return this.bindParameters.lighting.legacy}get gl(){return this.view.stage.renderView.renderingContext.gl}get techniques(){return this.view.stage.renderView.techniques}acquireOutputFramebuffer(){const e=this._frameBuffer?.getTexture()?.descriptor,i=this.view.stage.renderer.fboCache.acquire(e?.width??640,e?.height??480,this.produces);return i.fbo?.initializeAndBind(),i}bindRenderTarget(){return this._frameBuffer?.fbo?.initializeAndBind(),this._frameBuffer}requestRender(e){switch(e){case 2:this.view.state.fading=!0;case 1:this.view.stage?.renderView.requestRender(e);case 0:case void 0:this._dirty=!0}}resetWebGLState(){this.renderingContext.resetState(),this.renderingContext.bindFramebuffer(this._frameBuffer?.fbo)}get fboCache(){return this.view.stage.renderer.fboCache}get bindParameters(){return this.renderContext.bind}get renderingContext(){return this.view.stage.renderView.renderingContext}get renderContext(){return this.view.stage?.renderer.renderContext}updateAnimation(e){return!!this._dirty&&(this._dirty=!1,!0)}doRender(e){this._frameBuffer=e.find(({name:i})=>i===this.produces);try{return this.render(e)}finally{this._frameBuffer=null}}};ee([Be({constructOnly:!0})],$e.prototype,"view",void 0),ee([Be({constructOnly:!0})],$e.prototype,"consumes",void 0),ee([Be()],$e.prototype,"produces",void 0),ee([Be({readOnly:!0})],$e.prototype,"techniques",null),$e=ee([pr("esri.views.3d.webgl.RenderNode")],$e);const pc=[],Ba=[new Pi("position",3,wi.FLOAT,0,12)],Va=[new Pi("position",2,wi.FLOAT,0,8)],gc=zi(Va);zi(Ba);function vc(t,e=!0){t.attributes.add("position","vec2"),e&&t.varyings.add("uv","vec2"),t.vertex.main.add(f`
      gl_Position = vec4(position, 0.0, 1.0);
      ${e?f`uv = position * 0.5 + vec2(0.5);`:""}
  `)}function Ua(t){t.uniforms.add(new Ni("zProjectionMap",e=>Da(e.camera))),t.code.add(f`float linearizeDepth(float depth) {
float depthNdc = depth * 2.0 - 1.0;
float c1 = zProjectionMap[0];
float c2 = zProjectionMap[1];
return -(c1 / (depthNdc + c2 + 1e-7));
}`),t.code.add(f`float delinearizeDepth(float linearDepth) {
float c1 = zProjectionMap[0];
float c2 = zProjectionMap[1];
float depthNdc = (-c1/linearDepth) - c2 - 1e-7;
float depthNonlinear01 = (depthNdc + 1.0 ) / 2.0;
return depthNonlinear01;
}`),t.code.add(f`float depthFromTexture(sampler2D depthTexture, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthTexture, 0)));
float depth = texelFetch(depthTexture, iuv, 0).r;
return depth;
}`),t.code.add(f`float linearDepthFromTexture(sampler2D depthTexture, vec2 uv) {
return linearizeDepth(depthFromTexture(depthTexture, uv));
}`)}function Da(t){const e=t.projectionMatrix;return _t(Na,e[14],e[10])}const Na=At();let $c=class extends T{constructor(e,i,s){super(e,"vec2",2,(r,n,a,o)=>r.setUniform2fv(e,i(n,a,o),s))}},Ha=class extends T{constructor(e,i,s){super(e,"vec4",0,(r,n)=>r.setUniform4fv(e,i(n),s))}};function xc(t){t.fragment.uniforms.add(new Ha("projInfo",e=>ja(e.camera))),t.fragment.uniforms.add(new Ni("zScale",e=>Ra(e.camera))),t.fragment.code.add(f`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)}function ja(t){const e=t.projectionMatrix;return e[11]===0?xt(li,2/(t.fullWidth*e[0]),2/(t.fullHeight*e[5]),(1+e[12])/e[0],(1+e[13])/e[5]):xt(li,-2/(t.fullWidth*e[0]),-2/(t.fullHeight*e[5]),(1-e[8])/e[0],(1-e[9])/e[5])}const li=yi();function Ra(t){return t.projectionMatrix[11]===0?_t(ci,0,1):_t(ci,1,0)}const ci=At();function _c(t){const e=3.141592653589793,i=.3183098861837907;t.constants.add("PI","float",e),t.constants.add("LIGHT_NORMALIZATION","float",i),t.constants.add("INV_PI","float",i),t.constants.add("HALF_PI","float",1.570796326794897),t.constants.add("TWO_PI","float",6.28318530717958)}let Ea=class{constructor(e=Te()){this.intensity=e}};class qa{constructor(e=Te(),i=N(.57735,.57735,.57735)){this.intensity=e,this.direction=i}}class St{constructor(e=Te(),i=N(.57735,.57735,.57735),s=!0,r=1,n=1){this.intensity=e,this.direction=i,this.castShadows=s,this.specularStrength=r,this.environmentStrength=n}}let ss=class{constructor(){this.r=[0],this.g=[0],this.b=[0]}};function Ga(t,e,i){(i=i||t).length=t.length;for(let s=0;s<t.length;s++)i[s]=t[s]*e[s];return i}function gt(t,e,i){(i=i||t).length=t.length;for(let s=0;s<t.length;s++)i[s]=t[s]*e;return i}function xe(t,e,i){(i=i||t).length=t.length;for(let s=0;s<t.length;s++)i[s]=t[s]+e[s];return i}function rs(t){return(t+1)*(t+1)}function Wa(t){return Ie(Math.floor(Math.sqrt(t)-1),0,2)}function ns(t,e,i){const s=t[0],r=t[1],n=t[2],a=i||[];return a.length=rs(e),e>=0&&(a[0]=.28209479177),e>=1&&(a[1]=.4886025119*s,a[2]=.4886025119*n,a[3]=.4886025119*r),e>=2&&(a[4]=1.09254843059*s*r,a[5]=1.09254843059*r*n,a[6]=.31539156525*(3*n*n-1),a[7]=1.09254843059*s*n,a[8]=.54627421529*(s*s-r*r)),a}function Xa(t,e){const i=rs(t),s=e||{r:[],g:[],b:[]};s.r.length=s.g.length=s.b.length=i;for(let r=0;r<i;r++)s.r[r]=s.g[r]=s.b[r]=0;return s}function Ka(t,e){const i=Wa(e.r.length);for(const s of t)xi(Ct,s.direction),ns(Ct,i,ie),Ga(ie,Xe),gt(ie,s.intensity[0],be),xe(e.r,be),gt(ie,s.intensity[1],be),xe(e.g,be),gt(ie,s.intensity[2],be),xe(e.b,be);return e}function Ya(t,e){ns(Ct,0,ie);for(const i of t)e.r[0]+=ie[0]*Xe[0]*i.intensity[0]*4*Math.PI,e.g[0]+=ie[0]*Xe[0]*i.intensity[1]*4*Math.PI,e.b[0]+=ie[0]*Xe[0]*i.intensity[2]*4*Math.PI;return e}function Ja(t,e,i,s){Xa(e,s),D(i.intensity,0,0,0);let r=!1;const n=Za,a=Qa,o=eo;n.length=0,a.length=0,o.length=0;for(const l of t)l instanceof St&&!r?(j(i.direction,l.direction),j(i.intensity,l.intensity),i.specularStrength=l.specularStrength,i.environmentStrength=l.environmentStrength,i.castShadows=l.castShadows,r=!0):l instanceof St||l instanceof qa?n.push(l):l instanceof Ea?a.push(l):l instanceof ss&&o.push(l);Ka(n,s),Ya(a,s);for(const l of o)xe(s.r,l.r),xe(s.g,l.g),xe(s.b,l.b)}const Za=[],Qa=[],eo=[],ie=[0],be=[0],Ct=p(),Xe=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class ui{constructor(){this.color=p(),this.intensity=1}}class to{constructor(){this.direction=p(),this.ambient=new ui,this.diffuse=new ui}}const io=.4;class Cc{constructor(){this._shOrder=2,this._legacy=new to,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new ss,this._mainLight=new St(p(),N(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(e){Ja(e,this._shOrder,this._mainLight,this._sphericalHarmonics),this.updateLegacy()}updateLegacy(){j(this._legacy.direction,this._mainLight.direction);const e=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*e,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*e,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*e,O(this._legacy.diffuse.color,this._mainLight.intensity,e),j(qe,this._legacy.diffuse.color),O(qe,qe,io*this.globalFactor),q(this._legacy.ambient.color,this._legacy.ambient.color,qe)}copyFrom(e){this._sphericalHarmonics.r=Array.from(e.sh.r),this._sphericalHarmonics.g=Array.from(e.sh.g),this._sphericalHarmonics.b=Array.from(e.sh.b),j(this._mainLight.direction,e.mainLight.direction),j(this._mainLight.intensity,e.mainLight.intensity),this._mainLight.castShadows=e.mainLight.castShadows,this._mainLight.specularStrength=e.mainLight.specularStrength,this._mainLight.environmentStrength=e.mainLight.environmentStrength,this.globalFactor=e.globalFactor,this.noonFactor=e.noonFactor}lerpLighting(e,i,s){if(Ke(this._mainLight.intensity,e.mainLight.intensity,i.mainLight.intensity,s),this._mainLight.environmentStrength=K(e.mainLight.environmentStrength,i.mainLight.environmentStrength,s),this._mainLight.specularStrength=K(e.mainLight.specularStrength,i.mainLight.specularStrength,s),j(this._mainLight.direction,i.mainLight.direction),this._mainLight.castShadows=i.mainLight.castShadows,this.globalFactor=K(e.globalFactor,i.globalFactor,s),this.noonFactor=K(e.noonFactor,i.noonFactor,s),e.sh.r.length===i.sh.r.length)for(let r=0;r<i.sh.r.length;r++)this._sphericalHarmonics.r[r]=K(e.sh.r[r],i.sh.r[r],s),this._sphericalHarmonics.g[r]=K(e.sh.g[r],i.sh.g[r],s),this._sphericalHarmonics.b[r]=K(e.sh.b[r],i.sh.b[r],s);else for(let r=0;r<i.sh.r.length;r++)this._sphericalHarmonics.r[r]=i.sh.r[r],this._sphericalHarmonics.g[r]=i.sh.g[r],this._sphericalHarmonics.b[r]=i.sh.b[r];this.updateLegacy()}}const qe=p();function zc(t,{occlusionPass:e,terrainDepthTest:i,cullAboveTerrain:s}){const{vertex:r,fragment:n,varyings:a}=t;if(!i)return r.code.add("void forwardViewPosDepth(vec3 pos) {}"),void n.code.add(`${e?"bool":"void"} discardByTerrainDepth() { ${R(e,"return false;")}}`);a.add("viewPosDepth","float",{invariant:!0}),r.code.add(`void forwardViewPosDepth(vec3 pos) {
    viewPosDepth = pos.z;
  }`),n.include(Ua),n.uniforms.add(new Ri("terrainDepthTexture",o=>o.terrainDepth?.attachment)).code.add(f`
    ${e?"bool":"void"} discardByTerrainDepth() {
      float depth = texelFetch(terrainDepthTexture, ivec2(gl_FragCoord.xy), 0).r;
      float linearDepth = linearizeDepth(depth);
      ${e?"return viewPosDepth < linearDepth && depth < 1.0;":`if(viewPosDepth ${s?">":"<="} linearDepth) discard;`}
    }`)}function so(t){t.code.add(f`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}function ro(t){t.code.add(f`
    const float GAMMA = ${f.float(Gt)};
    const float INV_GAMMA = ${f.float(1/Gt)};

    vec4 delinearizeGamma(vec4 color) {
      return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.a);
    }

    vec3 linearizeGamma(vec3 color) {
      return pow(color, vec3(GAMMA));
    }
  `)}const no=1;function ao(t,e){if(!Le(e.output))return;t.fragment.include(ro);const{emissionSource:i,hasEmissiveTextureTransform:s,bindType:r}=e,n=i===3||i===4||i===5;n&&(t.include(sa,e),t.fragment.uniforms.add(r===1?new ta("texEmission",h=>h.textureEmissive):new ra("texEmission",h=>h.textureEmissive)));const a=i===2||n;a&&t.fragment.uniforms.add(r===1?new Q("emissiveBaseColor",h=>h.emissiveBaseColor):new re("emissiveBaseColor",h=>h.emissiveBaseColor));const o=i!==0;o&&!(i===7||i===6||i===4||i===5)&&t.fragment.uniforms.add(r===1?new Qn("emissiveStrength",h=>h.emissiveStrength):new Zn("emissiveStrength",h=>h.emissiveStrength));const l=i===7,u=i===5,c=i===1||i===6||l;t.fragment.code.add(f`
    vec4 getEmissions(vec3 symbolColor) {
      vec4 emissions = ${a?u?"emissiveSource == 0 ? vec4(emissiveBaseColor, 1.0): vec4(linearizeGamma(symbolColor), 1.0)":"vec4(emissiveBaseColor, 1.0)":c?l?"emissiveSource == 0 ? vec4(0.0): vec4(linearizeGamma(symbolColor), 1.0)":"vec4(linearizeGamma(symbolColor), 1.0)":"vec4(0.0)"};
      ${R(n,`${R(u,`if(emissiveSource == 0) {
              vec4 emissiveFromTex = textureLookup(texEmission, ${s?"emissiveUV":"vuv0"});
              emissions *= vec4(linearizeGamma(emissiveFromTex.rgb), emissiveFromTex.a);
           }`,`vec4 emissiveFromTex = textureLookup(texEmission, ${s?"emissiveUV":"vuv0"});
           emissions *= vec4(linearizeGamma(emissiveFromTex.rgb), emissiveFromTex.a);`)}
        emissions.w = emissions.rgb == vec3(0.0) ? 0.0: emissions.w;`)}
      ${R(o,`emissions.rgb *= emissiveStrength * ${f.float(no)};`)}
      return emissions;
    }
  `)}function Pc(t,e){t.include(Un,e),t.include(ao,e),t.fragment.include(so);const{output:i,oitPass:s,discardInvisibleFragments:r,snowCover:n}=e,a=i===10,o=Tt(i),l=Le(i)&&s===1,u=Le(i)&&s!==1;let c=0;(u||o||l)&&t.outputs.add("fragColor","vec4",c++),o&&t.outputs.add("fragEmission","vec4",c++),l&&t.outputs.add("fragAlpha","float",c++),t.fragment.code.add(f`
    void outputColorHighlightOID(vec4 finalColor, const in vec3 vWorldPosition, vec3 emissiveSymbolColor ${R(n,", float snow")}) {
      ${R(a,"finalColor.a = 1.0;")}

      ${R(r,`if (finalColor.a < ${f.float(ea)}) { discard; }`)}

      finalColor = applySlice(finalColor, vWorldPosition);
      ${R(l,f`fragColor = premultiplyAlpha(finalColor);
             fragAlpha = finalColor.a;`)}
      ${R(u,"fragColor = finalColor;")}
      ${R(o,`fragEmission = ${R(n,"mix(finalColor.a * getEmissions(emissiveSymbolColor), vec4(0.0), snow);","finalColor.a * getEmissions(emissiveSymbolColor);")}`)}
      calculateOcclusionAndOutputHighlight();
      ${R(a,"outputObjectAndLayerIdColor();")}
    }
  `)}export{$e as $,Po as A,Li as B,zo as C,Wo as D,ea as E,sc as F,Mo as G,kt as H,el as I,Ni as J,Ul as K,Nl as L,Al as M,T as N,qr as O,Gr as P,vc as Q,ta as R,$o as S,Q as T,Bl as U,$c as V,Qn as W,In as X,pc as Y,ra as Z,gc as _,Pc as a,Ro as a$,fc as a0,Cc as a1,on as a2,Ea as a3,yn as a4,xn as a5,et as a6,Cl as a7,Mn as a8,al as a9,Nn as aA,kl as aB,We as aC,dn as aD,xl as aE,pl as aF,yl as aG,vl as aH,ml as aI,Ti as aJ,sn as aK,Qo as aL,Wr as aM,go as aN,wl as aO,tn as aP,Bo as aQ,Jn as aR,fn as aS,mn as aT,gn as aU,at as aV,Jo as aW,Ii as aX,Zo as aY,$n as aZ,ic as a_,Fn as aa,Il as ab,Ol as ac,Tl as ad,No as ae,kn as af,Un as ag,sa as ah,cc as ai,Ua as aj,xc as ak,Ri as al,Ha as am,_c as an,io as ao,re as ap,Bn as aq,An as ar,Co as as,en as at,Do as au,Ll as av,_o as aw,Jr as ax,Dl as ay,Tn as az,so as b,Uo as b0,ki as b1,bn as b2,Ql as b3,ec as b4,Zl as b5,dc as b6,tc as b7,vo as b8,lt as b9,Dn as ba,ro as bb,Yt as bc,wn as c,jl as d,Ln as e,Fl as f,hl as g,Xo as h,zc as i,bl as j,$l as k,gl as l,So as m,po as n,fl as o,_l as p,Go as q,Ko as r,Ho as s,ll as t,nc as u,qo as v,Yo as w,Le as x,Me as y,De as z};
