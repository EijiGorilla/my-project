import{_ as S,iE as L,ll as m,d2 as g,kx as P,jA as H,f1 as R,kR as y,lm as b,d0 as U,aH as T,jB as _,aP as $,bK as x,ln as V,bj as B,bm as O,aN as k,r as X,bi as N,lo as G}from"./index-Cf-lFAZt.js";import{r as K}from"./videoUtils-DBqbxlxW.js";import{t as W}from"./requestImageUtils-ZPD4Ha7V.js";import{S as j}from"./OutputColorHighlightOID.glsl-D8r0EqP2.js";import{o as z}from"./textureUtils-CPS1vV5j.js";import{s as Y}from"./BufferView-f6HPMtox.js";function Z(){return f??=(async()=>{const r=await S(()=>import("./basis_transcoder-DuG70Smz.js"),[]),e=await r.default({locateFile:t=>L(`esri/libs/basisu/${t}`)});return e.initializeBasis(),e})(),f}let f,o=null,c=null;async function A(){return c==null&&(c=Z(),o=await c),c}function q(r,e){if(o==null)return r.byteLength;const t=new o.BasisFile(new Uint8Array(r)),a=w(t)?F(t.getNumLevels(0),t.getHasAlpha(),t.getImageWidth(0,0),t.getImageHeight(0,0),e):0;return t.close(),t.delete(),a}function J(r,e){if(o==null)return r.byteLength;const t=new o.KTX2File(new Uint8Array(r)),a=M(t)?F(t.getLevels(),t.getHasAlpha(),t.getWidth(),t.getHeight(),e):0;return t.close(),t.delete(),a}function F(r,e,t,a,i){const s=P(e?m.COMPRESSED_RGBA8_ETC2_EAC:m.COMPRESSED_RGB8_ETC2),n=i&&r>1?(4**r-1)/(3*4**(r-1)):1;return Math.ceil(t*a*s*n)}function w(r){return r.getNumImages()>=1&&!r.isUASTC()}function M(r){return r.getFaces()>=1&&r.isETC1S()}async function Q(r,e,t){o==null&&(o=await A());const a=new o.BasisFile(new Uint8Array(t));if(!w(a))return null;a.startTranscoding();const i=D(r,e,a.getNumLevels(0),a.getHasAlpha(),a.getImageWidth(0,0),a.getImageHeight(0,0),(s,n)=>a.getImageTranscodedSizeInBytes(0,s,n),(s,n,l)=>a.transcodeImage(l,0,s,n,0,0));return a.close(),a.delete(),i}async function tt(r,e,t){o==null&&(o=await A());const a=new o.KTX2File(new Uint8Array(t));if(!M(a))return null;a.startTranscoding();const i=D(r,e,a.getLevels(),a.getHasAlpha(),a.getWidth(),a.getHeight(),(s,n)=>a.getImageTranscodedSizeInBytes(s,0,0,n),(s,n,l)=>a.transcodeImage(l,s,0,0,n,0,-1,-1));return a.close(),a.delete(),i}function D(r,e,t,a,i,s,n,l){const{compressedTextureETC:h,compressedTextureS3TC:E}=r.capabilities,[p,I]=h?a?[1,m.COMPRESSED_RGBA8_ETC2_EAC]:[0,m.COMPRESSED_RGB8_ETC2]:E?a?[3,m.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[2,m.COMPRESSED_RGB_S3TC_DXT1_EXT]:[13,6408],v=e.hasMipmap?t:Math.min(1,t),u=[];for(let d=0;d<v;d++)u.push(new Uint8Array(n(d,p))),l(d,p,u[d]);return e.internalFormat=I,e.hasMipmap=u.length>1,e.samplingMode=e.hasMipmap?9987:9729,e.width=i,e.height=s,new g(r,e,{type:"compressed",levels:u})}class mt{constructor(e,t){this._data=e,this.id=H(),this.events=new R,this._parameters={...at,...t},this._startPreload(e)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(e){e instanceof HTMLVideoElement?(this.update=t=>this._update(e,t),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e)}_startPreloadVideoElement(e){if(!(y(e.src)||e.preload==="auto"&&e.crossOrigin)&&(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src,e.paused&&e.autoplay)){const t=[];K(e,a=>t.push(a)).then(()=>{e.play()}).finally(()=>t.forEach(a=>a.remove()))}}_startPreloadImageElement(e){b(e.src)||y(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){const t=new U;return t.wrapMode=this._parameters.wrap??10497,t.flipped=!this._parameters.noUnpackFlip,t.samplingMode=this._parameters.mipmap?9987:9729,t.hasMipmap=!!this._parameters.mipmap,t.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,t.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t.dataType=this._parameters.dataType??t.dataType,t.pixelFormat=this._parameters.pixelFormat??t.pixelFormat,t.internalFormat=this._parameters.internalFormat??t.internalFormat,t}get glTexture(){return this._glTexture??this._emptyTexture}get loaded(){return this._glTexture!=null}get usedMemory(){return this._glTexture?.usedMemory||et(this._data,this._parameters)}load(e){if(this._loadingPromise)return this._loadingPromise;if(this._glTexture)return this._glTexture;const t=this._data;return t==null?(this._glTexture=new g(e,this._createDescriptor(e),null),this._glTexture):(this._emptyTexture=e.emptyTexture,this._parameters.reloadable||(this._data=void 0),typeof t=="string"?this._loadFromURL(e,t):t instanceof Image?this._loadFromImageElement(e,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t):T(t)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(e,t):_(t)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(e,new Uint8Array(t)):(_(t)||T(t))&&this._parameters.encoding==="image/ktx2"?this._loadFromKTX2(e,t):(_(t)||T(t))&&this._parameters.encoding==="image/x.basis"?this._loadFromBasis(e,t):_(t)?this._loadFromPixelData(e,new Uint8Array(t)):$(t)?this._loadFromPixelData(e,t):null)}_update(e,t){return this._glTexture==null||e.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||t===e.currentTime?t:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,t){return this._glTexture=j(e,this._createDescriptor(e),t),this._emptyTexture=null,this._glTexture}_loadFromKTX2(e,t){return this._loadAsync(()=>tt(e,this._createDescriptor(e),t).then(a=>(this._glTexture=a,a)))}_loadFromBasis(e,t){return this._loadAsync(()=>Q(e,this._createDescriptor(e),t).then(a=>(this._glTexture=a,a)))}_loadFromPixelData(e,t){Y(this._parameters.width>0&&this._parameters.height>0);const a=this._createDescriptor(e);return a.pixelFormat!==6407&&a.pixelFormat!==6408||(a.compress=this._parameters.compressionOptions),a.width=this._parameters.width??0,a.height=this._parameters.height??0,this._glTexture=new g(e,a,t),this._glTexture}_loadFromURL(e,t){return this._loadAsync(async a=>{const i=await W(t,{signal:a});return x(a),this._loadFromImage(e,i)})}_loadFromImageElement(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync(async a=>{const i=await V(t,t.src,!1,a);return x(a),this._loadFromImage(e,i)})}_loadFromVideoElement(e,t){return t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)}_loadFromVideoElementAsync(e,t){return this._loadAsync(a=>new Promise((i,s)=>{const n=()=>{t.removeEventListener("loadeddata",l),t.removeEventListener("error",h),N(E)},l=()=>{t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(n(),i(this._loadFromImage(e,t)))},h=p=>{n(),s(p||new X("texture:load-error","Failed to load video"))};t.addEventListener("loadeddata",l),t.addEventListener("error",h);const E=B(a,()=>h(O()))}))}_loadFromImage(e,t){let a=t;a instanceof HTMLVideoElement||(a=z(a,e.parameters));const i=C(a);this._parameters.width=i.width,this._parameters.height=i.height;const s=this._createDescriptor(e);return s.width=i.width,s.height=i.height,s.compress=this._parameters.compressionOptions,this._glTexture=new g(e,s,a),this._emptyTexture=null,this.events.emit("loaded"),this._glTexture}_loadAsync(e){const t=new AbortController;this._loadingController=t;const a=e(t.signal);this._loadingPromise=a;const i=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===a&&(this._loadingPromise=null),this._emptyTexture=null};return a.then(i,i),a}unload(){if(this._glTexture=k(this._glTexture),this._emptyTexture=null,this._loadingController!=null){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}}function et(r,e){if(r==null)return 0;if(_(r)||T(r))return e.encoding==="image/ktx2"?J(r,!!e.mipmap):e.encoding==="image/x.basis"?q(r,!!e.mipmap):r.byteLength;const{width:t,height:a}=r instanceof Image||r instanceof ImageData||r instanceof HTMLCanvasElement||r instanceof HTMLVideoElement?C(r):e,i=e.pixelFormat??6408,s=G(i);return(e.mipmap?4/3:1)*t*a*s||0}function C(r){return r instanceof HTMLVideoElement?{width:r.videoWidth,height:r.videoHeight}:r}const at={wrap:{s:10497,t:10497},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};export{mt as M};
